import{d as se,x as le,y as ae,r as v,c as G,z as ie,a,b as w,F as g,l as k,k as E,o as i,e as ue,q as re,n as ce,T as de,A as x,B as Y,_ as ve}from"./index-2c1944cb.js";const fe={style:{position:"absolute",top:"200px",left:"200px","user-select":"none"}},he={width:"5000",height:"5000",style:{position:"absolute",top:"0","z-index":"2"}},pe=["x1","y1","x2","y2"],ge=["x1","y1","x2","y2"],ye=["x1","y1","x2","y2"],xe=["x1","y1","x2","y2","onMouseenter","onMouseleave","onClick"],me=["x1","y1","x2","y2"],_e={class:"d-flex",style:{"z-index":"1"}},we={class:"me-5"},ke={style:{height:"25px"}},Ce=se({__name:"TestView",setup(Ee){const J=le(),y=ae(),C=v({});v({});const H=v(0),f=v([]),T=v(!1),z=G(()=>{let e=y.tagList.filter(t=>t.propertyId==15);if(T.value&&Object.keys(_.value).length){const t=new Set,n=e.filter(o=>_.value[o.id]);n.forEach(o=>t.add(o.id)),n.forEach(o=>o.allChildren.forEach(s=>t.add(s))),n.forEach(o=>o.allParents.forEach(s=>t.add(s))),e=y.tagList.filter(o=>t.has(o.id))}return e});let m={};const h=v([]);function K(){const e=[];for(let t=0;t<=H.value;t++)e[t]=z.value.filter(n=>C.value[n.id]==t);h.value=e}async function F(){const e=z.value;Q(e),K(),await x(),P(),await x(),await O()}function Q(e){let t=0;const n=C.value,o=new Set(e.map(s=>s.id));for(;e.length;){const s=e.filter(l=>!l.parents.some(p=>n[p]==null&&o.has(p)));for(let l of s)n[l.id]=t;e=e.filter(l=>n[l.id]==null),t+=1}H.value=t-1,C.value=n}function P(){const t=h.value,n=[];for(const o of t)for(const s of o)if(s)for(const l of s.children){if(!m[s.id]||!m[l])continue;const p=m[s.id].getBoundingClientRect(),u=m[l].getBoundingClientRect(),c={x1:p.right-200,y1:p.y+11-200,x2:u.x-200,y2:u.y+11-200,child:y.tags[l],parent:s,hover:!1};n.push(c)}f.value=n}async function O(){console.log("reorder");let e=[...h.value];h.value=[],await x(),h.value=e;for(let t=0;t<5;t++){e=[...h.value];const n=[],o=Math.max(...e.map(u=>u.length)),s={},l={},p={};for(let u=0;u<e.length;u++)e[u]=e[u].filter(c=>c);for(const u of e)for(let c=0;c<u.length;c++){const D=u[c];s[D.id]=c}for(const u of e){for(let r=0;r<u.length;r++){const d=u[r];let N=r;!d.children.length&&d.parents.length?N=Y(d.parents.map(R=>s[R]))/d.parents.length:d.children.length&&(N=Y(d.children.map(R=>s[R]))/d.children.length),l[d.id]=N}const c=[...u].sort((r,d)=>l[r.id]-l[d.id]);let D=o-c.length-1,$=0;for(const r of c){for(;Math.round(l[r.id])>$&&D>0;)D-=1,$+=1;p[r.id]=$,$+=1}c.sort((r,d)=>p[r.id]-p[d.id]);const V=[];let I=0;for(const r of c){for(;p[r.id]>I;)V.push(void 0),I+=1;V.push(r),s[r.id]=V.length-1,I+=1}n.push(V)}h.value=n}await x(),P()}function U(e){const t=f.value[e];t.hover=!0}function W(e){const t=f.value[e];t.hover=!1}async function Z(e){const t=f.value[e];await y.deleteTagParent(t.child.id,t.parent.id),await j()}async function j(){f.value=[],h.value=[],C.value={},await x(),await F()}const L=v(!1),M=v(-1),b=v(-1),B=v([0,0]),S=v([0,0]),_=v({}),ee=G(()=>{let e={};for(let t of z.value)e[t.id]=[],M.value==t.id?e[t.id].push("hover-tag"):_.value[t.id]?e[t.id].push("selected-tag"):e[t.id].push("tag");return e}),q=G(()=>{const e=[],t=_.value,n=new Set,o=Object.keys(t).map(Number);o.forEach(s=>n.add(s)),o.forEach(s=>y.tags[s].allChildren.forEach(l=>n.add(l))),o.forEach(s=>y.tags[s].allParents.forEach(l=>n.add(l))),console.log(n);for(const s of f.value)n.has(s.child.id)&&n.has(s.parent.id)?e.push(!0):e.push(!1);return e});function te(e){document.addEventListener("mouseup",X),document.addEventListener("mousemove",A),b.value=e.id,L.value=!0;const t=m[e.id].getBoundingClientRect();B.value=[(t.x+t.right)/2-200,t.y+11-200],S.value=B.value}function ne(e){console.log("mouseup");const t=_.value;L.value&&b.value!=e.id||(t[e.id]?delete t[e.id]:t[e.id]=!0,_.value=t,T.value&&j())}function A(e){S.value=[e.clientX-200,e.clientY-200]}async function X(){const e=b.value,t=M.value;b.value=-1,L.value=!1,document.removeEventListener("mouseup",X),document.removeEventListener("mousemove",A),await x(),e!=t&&(await y.addTagParent(t,e),f.value=[],h.value=[],C.value={},await x(),await F())}function oe(){T.value=!T.value,j()}return ie(()=>J.status.loaded,F),(e,t)=>(i(),a(g,null,[w("button",{onClick:O},"Reorder"),w("button",{onClick:P},"compute lines"),w("button",{onClick:oe},"Filter"),w("div",null,[w("div",fe,[(i(),a("svg",he,[(i(!0),a(g,null,k(f.value,(n,o)=>(i(),a(g,null,[q.value[o]?E("",!0):(i(),a("line",{key:0,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,class:"line"},null,8,pe))],64))),256)),(i(!0),a(g,null,k(f.value,(n,o)=>(i(),a(g,null,[q.value[o]?(i(),a("line",{key:0,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,class:"selected-line"},null,8,ge)):E("",!0)],64))),256)),(i(!0),a(g,null,k(f.value,n=>(i(),a(g,null,[n.hover?(i(),a("line",{key:0,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,class:"hover-line"},null,8,ye)):E("",!0)],64))),256)),(i(!0),a(g,null,k(f.value,(n,o)=>(i(),a("line",{x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,style:{stroke:"white","stroke-width":"4",opacity:"0",cursor:"pointer"},onMouseenter:s=>U(o),onMouseleave:s=>W(o),onClick:s=>Z(o)},null,40,xe))),256)),L.value?(i(),a("line",{key:0,x1:B.value[0],y1:B.value[1],x2:S.value[0],y2:S.value[1],stroke:"green","stroke-width":"2"},null,8,me)):E("",!0)])),w("div",_e,[(i(!0),a(g,null,k(h.value,n=>(i(),a("div",we,[(i(!0),a(g,null,k(n,(o,s)=>(i(),a("div",ke,[o?(i(),a("span",{key:0,ref_for:!0,ref:l=>ue(m)[o.id]=l},[re(de,{id:o.id,style:{"z-index":"10"},onMousedown:l=>te(o),onMouseup:l=>ne(o),onMouseenter:l=>M.value=o.id,onMouseleave:t[0]||(t[0]=l=>M.value=-1),class:ce(ee.value[o.id])},null,8,["id","onMousedown","onMouseup","onMouseenter","class"])],512)):E("",!0)]))),256))]))),256))])])])],64))}});const Le=ve(Ce,[["__scopeId","data-v-3271e4a6"]]);export{Le as default};
