import{d as H,B as X,k as U,D as ie,l as T,b as a,i as ae,t as L,C as Kt,o as m,E as ot,r as V,c as D,a as w,f as te,n as Y,F as Z,s as J,h as E,G as ce,q as R,e as I,H as Ct,I as Ve,J as ct,_ as j,K as ye,m as se,L as N,N as Pt,j as re,O as Ee,u as be,Q as ge,R as Se,w as Te,v as Ae,S as Ce,M as le,y as B,T as ee,U as Je,V as at,W as Qt,X as he,Y as zt,Z as Jt,g as et,$ as pt,a0 as es,a1 as ts,a2 as ss,a3 as os,a4 as as,a5 as is,a6 as ns,a7 as rs,a8 as ls,a9 as us,aa as Rt,ab as Et,ac as ds,ad as pe,ae as ue,af as cs,ag as Le,ah as Tt,ai as q,aj as it,ak as At,al as ps,am as tt,an as hs,ao as Lt,ap as Ot,aq as Vt,ar as Ie,A as ke,as as vs,at as ms,au as fs,av as Ft,aw as gs,ax as ys,ay as bs,az as Ut,aA as ht,aB as vt,aC as _s,aD as xs,aE as ws,aF as ks,aG as $s,aH as Ms,aI as Ss,aJ as Is,p as mt}from"./index-nMfs5GdY.js";import{V as Cs,c as Pe,M as nt,a as ze,G as Ps,T as Dt,d as rt,D as Bt,e as Gt,P as Ht,f as zs,I as Rs,g as ve,L as Es,B as Fe,h as Ts,i as As,j as Ls,k as Os,l as Vs,m as ft,S as Fs,O as Us,W as Ds}from"./three.module-Cl0ZyOCO.js";import{_ as Bs}from"./Tutorial.vue_vue_type_style_index_0_lang-6gBg4PvF.js";const Gs={class:"text-nowrap"},Hs=["onClick"],Zs=["onClick"],Ns=H({__name:"FolderOptionDropdown",props:{folder:{}},setup(M){const t=X(),e=M;function s(){t.reImportFolder(e.folder.id)}function o(){confirm(Kt.global.t("main.nav.folders.del_alert"))&&t.deleteFolder(e.folder.id)}return(l,v)=>(m(),U(ie,{teleport:!0},{button:T(()=>v[0]||(v[0]=[a("i",{class:"bi bi-three-dots-vertical base-hover"},null,-1)])),popup:T(({hide:h})=>[a("div",Gs,[a("div",{class:"p-2 bb",onClick:c=>{s(),h()}},v[1]||(v[1]=[a("i",{class:"bi bi-arrow-clockwise me-1"},null,-1),ae("Re import")]),8,Hs),v[3]||(v[3]=a("div",{class:"custom-hr"},null,-1)),a("div",{class:"bb p-2",onClick:c=>{o(),h()}},[v[2]||(v[2]=a("i",{class:"bi bi-trash me-1"},null,-1)),ae(L(l.$t("main.nav.folders.del")),1)],8,Zs)])]),_:1}))}}),Ws=["onMouseenter"],qs=["onClick"],Ys={class:"text-secondary"},Xs=["onClick"],js=H({__name:"FolderList2",props:{folders:Array,visibleFolders:Object,filterManager:ot,root:{type:Boolean,default:!0},tab:Object},setup(M){const t=X(),e=M,s=V(null),o=D(()=>{let n={};const p=new Set(e.filterManager.state.folders);return e.folders.map(u=>u.id).forEach(u=>{p.has(u)&&(n[u]=!0)}),n}),l=D(()=>{let n={};return e.folders.map(p=>p.id).forEach(p=>{e.visibleFolders[p]&&(n[p]=!0)}),n}),v=D(()=>{let n={};return e.folders.forEach(p=>{let u=[];o.value[p.id]&&u.push("selected"),n[p.id]=u.join(" ")}),n});function h(n){let p=e.visibleFolders;p[n]?delete p[n]:p[n]=!0}function c(n){let p=new Set(e.filterManager.state.folders);const u=p.has(n),b=t.folders[n].parent!=null&&p.has(t.folders[n].parent);u&&!b?(p.delete(n),Ve(n).forEach(S=>p.delete(S.id))):(i(n,p),p.add(n),Ve(n).forEach(S=>p.add(S.id)),ct(t.folders[n]).forEach(S=>p.delete(S.id))),e.filterManager.setFolders(Array.from(p)),e.tab.setSelectedFolder(p),e.filterManager.update(!0)}function i(n,p){const u=ct(t.folders[n]);let b;for(let S of u)if(p.has(S.id))b=S;else break;b!=null&&Ve(b.id).forEach(S=>p.delete(S.id))}return(n,p)=>{const u=Ct("FolderList2",!0);return m(),w("ul",{class:Y(e.root?"tree":""),style:te(e.root?"padding-left:0px;":"")},[(m(!0),w(Z,null,J(M.folders,b=>(m(),w("li",{style:te(e.root?"padding-left:0px;":""),class:"no-break"},[a("div",{style:{display:"inline"},onMouseenter:S=>s.value=b.id,onMouseleave:p[1]||(p[1]=S=>s.value=null)},[a("summary",{class:Y(v.value[b.id]),onClick:S=>c(b.id)},[a("span",{class:Y(s.value===b.id?"visible-option":"invisible-option"),onClick:p[0]||(p[0]=ce(()=>{},["stop"]))},[R(Ns,{folder:b},null,8,["folder"])],2),ae(" "+L(b.name)+" ",1),a("span",Ys,L(I(t).folders[b.id].count),1)],10,qs)],40,Ws),b.children&&b.children.length>0?(m(),w("i",{key:0,onClick:S=>h(b.id),class:Y("bi bi-chevron-"+(l.value[b.id]?"down":"right")+" ms-2 btn-icon"),style:{"font-size":"9px"}},null,10,Xs)):E("",!0),b.children&&b.children.length>0&&l.value[b.id]?(m(),U(u,{key:1,folders:b.children,root:!1,"visible-folders":e.visibleFolders,"filter-manager":e.filterManager,tab:e.tab},null,8,["folders","visible-folders","filter-manager","tab"])):E("",!0)],4))),256))],6)}}}),Ks=j(js,[["__scopeId","data-v-4f6f42f4"]]),Qs={class:"text-center"},Js={class:"w-100 text-center",style:{"font-size":"10px"}},eo={key:0,class:"progress",role:"progressbar","aria-label":"Example 1px high","aria-valuemin":"0","aria-valuemax":"100",style:{height:"1px"}},to=H({__name:"TaskStatus",props:{task:{}},setup(M){const t=M,e=D(()=>t.task.total-t.task.remain-t.task.computing),s=D(()=>t.task.total);return(o,l)=>(m(),w("div",Qs,[ae(L(t.task.name)+" ",1),a("div",Js,L(e.value)+" / "+L(s.value)+" "+L(o.$t("main.nav.tasks.done")),1),s.value>0?(m(),w("div",eo,[a("div",{class:"progress-bar",style:te(`width: ${e.value/s.value*100}%`)},null,4)])):E("",!0)]))}}),Zt=H({__name:"TabContainer",props:{id:{}},setup(M){const t=ye(),e=M;let s;const o=V(!1);function l(){s=t.getTab(e.id),o.value=!0}return se(l),N(()=>e.id,async()=>{o.value=!1,await re(),l()}),(v,h)=>o.value&&I(t).loaded?Pt(v.$slots,"default",{key:0,tab:I(s)}):E("",!0)}}),Re={},so={class:"d-flex flex-row"},oo={key:2,class:"d-flex",style:{width:"150px"}},ao={class:"flex-grow-1"},io={key:1,style:{"padding-top":"1px"}},no={class:"text-center",style:{width:"24px","margin-top":"2px"}},ro={style:{width:"20px","margin-top":"2px","flex-shrink":"0"},class:"text-center"},lo={key:0},uo={key:0,class:"ms-3 pt-1"},co={key:1},po=H({__name:"PropertyOptions",props:{tab:{},property:{},open:{type:Boolean}},setup(M){const{t}=Ee({useScope:"global"}),e=be();ge();const s=X(),o=M,l=V(!1),v=V(!1),h=V(""),c=V(!1),i=D(()=>o.tab.state.visibleProperties[o.property.id]==!0),n=D(()=>o.tab.collection.filterManager.state.filter.filters.some(g=>!g.isGroup&&g.propertyId==o.property.id)),p=D(()=>o.tab.collection.groupManager.state.groupBy.includes(o.property.id)),u=D(()=>o.tab.collection.sortManager.state.sortBy.includes(o.property.id)),b=D(()=>{if(n.value)return o.tab.collection.filterManager.state.filter.filters.find(g=>!g.isGroup&&g.propertyId==o.property.id).id}),S=()=>o.tab.collection.filterManager,z=D(()=>o.tab.getSha1Mode());function $(){i.value?o.tab.setVisibleProperty(o.property.id,!1):o.tab.setVisibleProperty(o.property.id,!0)}function C(){o.open&&(l.value?l.value=!1:(l.value=!0,h.value=o.property.name),v.value=!1)}function P(){o.property.type!=ee.tag&&o.property.type!=ee.multi_tags||(v.value?v.value=!1:v.value=!0,l.value=!1)}function r(){u.value?o.tab.collection.sortManager.delSort(o.property.id):o.tab.collection.sortManager.setSort(o.property.id),o.tab.collection.sortManager.update(!0)}function d(){p.value?o.tab.collection.groupManager.delGroupOption(o.property.id):o.tab.collection.groupManager.setGroupOption(o.property.id),o.tab.collection.groupManager.update(!0)}function x(){confirm(t("common.properties.delete")+": "+o.property.name+" ?   "+o.property.id)&&s.deleteProperty(o.property.id)}async function O(){h.value!=""&&(await s.updateProperty(o.property.id,h.value),C())}function A(){const g=S();n.value?(g.deleteFilter(b.value),Re.filter.hide()):(g.addNewFilter(o.property.id),Re.filter.show())}return N(()=>o.property,()=>{l.value=!1}),(g,y)=>(m(),w("div",{class:Y(c.value?"hover-light":"")},[a("div",so,[o.open?(m(),w(Z,{key:0},[l.value?E("",!0):(m(),w("div",{key:0,class:"option-holder hover-light btn-icon",style:{width:"150px"},onClick:C},[R(Se,{type:o.property.type,class:"me-2 btn-icon",onMouseenter:y[0]||(y[0]=_=>c.value=!0),onMouseleave:y[1]||(y[1]=_=>c.value=!1)},null,8,["type"]),a("span",null,L(o.property.name),1)]))],64)):(m(),U(Se,{key:1,type:o.property.type,class:"me-2",style:{position:"relative",top:"2px"}},null,8,["type"])),l.value&&o.open?(m(),w("div",oo,[a("div",null,[a("i",{class:"btn-icon me-1 bi bi-x-lg",style:{padding:"2px"},onClick:C,onMouseenter:y[2]||(y[2]=_=>c.value=!0),onMouseleave:y[3]||(y[3]=_=>c.value=!1)},null,32)]),a("div",ao,[o.property.id>=0?Te((m(),w("input",{key:0,style:{position:"relative",top:"1px"},type:"text",class:"text-input","onUpdate:modelValue":y[4]||(y[4]=_=>h.value=_),onChange:O},null,544)),[[Ae,h.value]]):(m(),w("span",io,[R(Se,{type:o.property.type,class:"me-2 btn-icon"},null,8,["type"]),a("span",null,L(o.property.name),1)]))])])):E("",!0),o.open?(m(),w(Z,{key:3},[I(Ce)(o.property.type)?(m(),w("div",{key:0,style:{width:"20px","margin-top":"2px",cursor:"pointer"},class:"text-center",onClick:y[5]||(y[5]=_=>I(e).showModal(I(le).TAG,{propId:o.property.id}))},[R(B,{click:!1,message:"main.nav.properties.open_tags"},{default:T(()=>y[7]||(y[7]=[a("i",{class:"bi bi-arrows-fullscreen"},null,-1)])),_:1})])):E("",!0)],64)):E("",!0),o.open?(m(),w(Z,{key:4},[a("div",no,[o.property.type==I(ee).tag||o.property.type==I(ee).multi_tags?(m(),w("div",{key:0,onClick:P,style:{cursor:"pointer"}},[v.value?(m(),U(B,{key:0,message:"main.nav.properties.collapse_property_tooltip"},{default:T(()=>y[8]||(y[8]=[a("i",{class:"bi bi-chevron-down"},null,-1)])),_:1})):(m(),U(B,{key:1,message:"main.nav.properties.expand_property_tooltip"},{default:T(()=>y[9]||(y[9]=[a("i",{class:"bi bi-chevron-right ms-1"},null,-1)])),_:1}))])):E("",!0)]),a("div",ro,[o.property.mode==I(Je).id?(m(),U(B,{key:0,click:!1,message:"main.nav.properties.linked_property_tooltip"},{default:T(()=>y[10]||(y[10]=[a("i",{class:"bi bi-link-45deg"},null,-1)])),_:1})):E("",!0)])],64)):E("",!0),a("div",{style:{width:"20px","margin-top":"2px","flex-shrink":"0"},onClick:$,class:"btn-icon text-center"},[z.value&&o.property.mode==I(Je).id?(m(),U(B,{key:0,message:"main.nav.properties.hidden_property_tooltip"},{default:T(()=>[a("span",{class:"bi bi-eye-slash",onClick:y[6]||(y[6]=ce(()=>{},["stop"]))})]),_:1})):(m(),U(B,{key:1,pos:"right",message:"main.nav.properties.hide_property_tooltip"},{default:T(()=>[a("span",{class:Y("bi bi-eye text-"+(i.value?"primary":"secondary"))},null,2)]),_:1}))])]),o.open?(m(),w("div",lo,[l.value?(m(),w("div",uo,[g.property.id!=I(at).folders?(m(),w("div",{key:0,class:Y(["options hover-light",n.value?" text-primary":""]),onClick:A},[a("div",null,[y[11]||(y[11]=a("i",{class:"bi bi-funnel-fill me-2"},null,-1)),ae(L(g.$t("main.menu.filters")),1)])],2)):E("",!0),a("div",{class:Y(["options hover-light",u.value?" text-primary":""]),onClick:r},[y[12]||(y[12]=a("i",{class:"bi bi-filter me-2"},null,-1)),ae(L(g.$t("main.menu.sort.title")),1)],2),a("div",{class:Y(["options hover-light",p.value?" text-primary":""]),onClick:d},[y[13]||(y[13]=a("i",{class:"bi bi-collection me-2"},null,-1)),ae(L(g.$t("main.menu.groupby")),1)],2),o.property.id>=0?(m(),w("div",{key:1,class:"options hover-light",onClick:x},[y[14]||(y[14]=a("i",{class:"bi bi-trash me-2"},null,-1)),ae(L(g.$t("main.nav.properties.delete_property")),1)])):E("",!0)])):v.value?(m(),w("div",co,[R(Qt,{property:o.property,"can-create":!0,"can-customize":!0,"can-delete":!0,"can-link":!0},null,8,["property"])])):E("",!0)])):E("",!0)],2))}}),ho=j(po,[["__scopeId","data-v-7f4c496c"]]),vo={key:0,class:"prop-container"},mo={key:0},fo={key:1},go={key:0,class:"ms-2 text-capitalize overflow-hidden"},yo={key:1,class:"ms-2"},bo={class:"p-1"},_o=["onClick"],xo=["onClick"],wo={key:0,class:"ps-1 pe-1"},ko={class:"property-item"},$o=H({__name:"PropertyGroup",props:{tab:{},node:{},menuOpen:{type:Boolean}},setup(M){const t=X(),e=be(),s=M,o=V(!0),l=V(!1),v=V(""),h=D(()=>s.node.propertyIds.map(P=>t.properties[P])),c=D(()=>s.node.propertyIds.map(P=>s.tab.isVisibleProperty(P)).filter(P=>!P).length==0),i=D(()=>{if(s.node.groupId>=0)return t.propertyGroups[s.node.groupId];if(s.node.groupId==he.DEFAULT)return{id:he.DEFAULT,name:"default"};if(s.node.groupId==he.COMPUTED)return{id:he.COMPUTED,name:"computed"}}),n=D(()=>i.value.id>=0);function p(){o.value=!o.value}function u(P){t.updatePropertyGroup(i.value.id,v.value)}function b(){v.value=i.value.name}function S(){t.deletePropertyGroup(i.value.id)}async function z(){const r={emptyProperties:t.propertyList.filter(x=>x.propertyGroupId==s.node.groupId).map(x=>x.id)};await t.sendCommit(r);const d={emptyPropertyGroups:[s.node.groupId]};await t.sendCommit(d)}async function $(P){if(P.added){let r=P.added.element;const d=t.properties[r];let x=s.node.groupId;x<0&&(x=null),await t.updateProperty(d.id,d.name,x),await t.triggerPropertyTreeChange()}P.moved&&await t.triggerPropertyTreeChange()}function C(){c.value?s.tab.setVisibleProperties(s.node.propertyIds,!1):s.tab.setVisibleProperties(s.node.propertyIds,!0)}return se(b),N(s,b),(P,r)=>I(t).propertyGroups[s.node.groupId]||s.node.groupId<0?(m(),w("div",vo,[R(I(zt),{list:s.node.propertyIds,"item-key":d=>d,group:s.node.groupId>0||s.node.groupId==I(he).DEFAULT?"properties":void 0,onChange:$},{header:T(()=>[a("div",{class:"d-flex group-container",onClick:p},[o.value?(m(),w("div",mo,r[4]||(r[4]=[a("i",{class:"bi bi-caret-down-fill"},null,-1)]))):E("",!0),o.value?E("",!0):(m(),w("div",fo,r[5]||(r[5]=[a("i",{class:"bi bi-caret-right-fill"},null,-1)]))),s.menuOpen?(m(),w(Z,{key:2},[l.value?E("",!0):(m(),w("div",go,L(i.value.name),1)),l.value?(m(),w("div",yo,[R(Jt,{"auto-focus":!0,modelValue:v.value,"onUpdate:modelValue":r[0]||(r[0]=d=>v.value=d),style:{"background-color":"white"},"min-height":25,width:135,onSubmit:u,onCancel:b,onBlur:r[1]||(r[1]=d=>l.value=!1)},null,8,["modelValue"])])):E("",!0),r[8]||(r[8]=a("div",{class:"flex-grow-1"},null,-1)),s.node.groupId>=I(he).DEFAULT?(m(),U(ie,{key:2,onClick:r[2]||(r[2]=ce(()=>{},["prevent","stop"]))},{button:T(()=>r[6]||(r[6]=[a("i",{class:"bb bi bi-three-dots"},null,-1)])),popup:T(({hide:d})=>[a("div",bo,[n.value?(m(),w(Z,{key:0},[a("div",{class:"bb",onClick:x=>{l.value=!0,d()}},L(P.$t("main.menu.editName")),9,_o),a("div",{class:"bb",onClick:S},L(P.$t("main.menu.removeGroup")),1)],64)):E("",!0),a("div",{class:"bb",onClick:x=>{z(),d()}},L(P.$t("main.menu.deleteGroupAndProperties")),9,xo)])]),_:1})):E("",!0),s.node.groupId>=-1?(m(),w("div",{key:3,class:"bb me-1",onClick:r[3]||(r[3]=ce(d=>I(e).showModal(I(le).PROPERTY,{group:s.node.groupId}),["stop","prevent"]))},[R(B,{message:P.$t("main.menu.addNewPropertyToGroup")},{default:T(()=>r[7]||(r[7]=[a("i",{class:"bi bi-plus"},null,-1)])),_:1},8,["message"])])):E("",!0)],64)):E("",!0),s.node.propertyIds.length?(m(),w("div",{key:3,style:{cursor:"pointer","flex-shrink":"0","margin-right":"11px"},onClick:ce(C,["stop"])},[a("span",{class:Y("bi bi-eye text-"+(c.value?"primary":"secondary"))},null,2)])):E("",!0)])]),item:T(({element:d,index:x})=>[o.value&&h.value.length&&I(t).properties[d]?(m(),w("div",wo,[a("div",ko,[R(ho,{tab:s.tab,property:I(t).properties[d],open:s.menuOpen},null,8,["tab","property","open"])])])):E("",!0)]),_:1},8,["list","item-key","group"])])):E("",!0)}}),Ue=j($o,[["__scopeId","data-v-113247f9"]]),Mo={key:0,class:"mb-1"},So=H({__name:"DraggablePropertyList",props:{tab:{},menuOpen:{type:Boolean}},emits:[],setup(M,{emit:t}){const e=X(),s=M;function o(l){e.triggerPropertyTreeChange()}return(l,v)=>(m(),U(I(zt),{list:I(e).propertyTree,onChange:o,"item-key":h=>h.groupId},{item:T(({element:h})=>[h.groupId>=0?(m(),w("div",Mo,[R(Ue,{tab:s.tab,node:h,"menu-open":s.menuOpen},null,8,["tab","node","menu-open"])])):E("",!0)]),footer:T(()=>[R(Ue,{class:"mb-1",tab:s.tab,node:I(e).propertyTree[I(e).propertyTree.length-2],"menu-open":s.menuOpen},null,8,["tab","node","menu-open"]),R(Ue,{class:"mb-1",tab:s.tab,node:I(e).propertyTree[I(e).propertyTree.length-1],"menu-open":s.menuOpen},null,8,["tab","node","menu-open"])]),_:1},8,["list","item-key"]))}}),Io={class:""},Co={class:"m-0",style:{padding:"4px 0px 4px 8px"}},Po={class:"d-flex align-items-center",style:{"font-size":"15px","line-height":"14px"}},zo={class:"flex-grow-1 text-capitalize overflow-hidden"},Ro={key:0,class:"bi bi-chevron-left"},Eo={key:1,class:"bi bi-chevron-right"},To={class:"ps-2 pe-2",style:{"padding-bottom":"9.5px"}},Ao={class:"d-flex align-items-center"},Lo={style:{"max-height":"300px",overflow:"auto"}},Oo={key:0,id:"import"},Vo={class:"pt-1 pb-2"},Fo={class:"d-flex align-items-center ps-2 pe-2",style:{height:"30px"}},Uo={key:0,class:"ps-2 pe-2"},Do={class:"p-1"},Bo={key:0,class:"custom-hr"},Go={class:"p-1 mt-0"},Ho={key:0,class:"d-flex p-1"},Zo={key:0,class:"spinner-grow spinner-grow-sm float-end",style:{width:"10px",height:"10px","margin-top":"5px"}},No={key:1,class:"bb me-1"},Wo={class:"bb me-2"},qo={key:1,class:"mt-2"},Yo=200,Xo=55,jo=H({__name:"Menu",emits:["export","toggle"],setup(M,{emit:t}){const e=ge(),s=X(),o=be(),l=ye(),v=t,h=V(!1),c=V(!0),i=D(()=>c.value?Yo:Xo),n=async()=>{o.showModal(le.IMPORT)},p=D(()=>e.state.tasks.filter(z=>!z.done)??[]);function u(){o.showModal(le.FOLDERSELECTION,{callback:b,mode:"images"})}function b(z){z&&s.addFolder(z)}function S(){c.value=!c.value,v("toggle")}return(z,$)=>(m(),U(Zt,{id:I(l).mainTab},{default:T(({tab:C})=>[a("div",{class:"menu overflow-scroll",style:te({width:i.value+"px"})},[a("div",Io,[a("div",null,[a("div",Co,[a("div",Po,[c.value?(m(),w(Z,{key:0},[a("div",zo,L(I(e).state.name),1),R(B,{message:"main.menu.close_project"},{default:T(()=>[a("div",{class:"base-hover p-1",onClick:$[0]||($[0]=P=>I(o).closeProject(I(e).state.id))},$[6]||($[6]=[a("i",{class:"bi bi-arrow-up-left-square red-hover"},null,-1)]))]),_:1}),a("div",{class:"base-hover p-1",onClick:$[1]||($[1]=P=>I(o).showModal(I(le).SETTINGS))},$[7]||($[7]=[a("i",{class:"bi bi-gear"},null,-1)]))],64)):E("",!0),a("div",{class:Y(["base-hover p-1",c.value?"":"flex-grow-1 text-center"]),style:{"margin-right":"6px"},onClick:S},[c.value?(m(),w("i",Ro)):(m(),w("i",Eo))],2)])]),c.value?(m(),w(Z,{key:0},[$[9]||($[9]=a("div",{class:"custom-hr"},null,-1)),a("div",To,[a("div",Ao,[a("div",null,[a("b",null,L(z.$t("main.nav.folders.title")),1)]),a("div",{id:"add_folder",class:"ms-auto plus",onClick:$[2]||($[2]=P=>{u(),I(et)()})},[R(B,{message:"main.nav.folders.add"},{default:T(()=>$[8]||($[8]=[a("i",{class:"bi bi-plus"},null,-1)])),_:1})])]),a("div",Lo,[R(Ks,{folders:I(s).folderRoots,"filter-manager":C.collection.filterManager,"visible-folders":C.state.visibleFolders,tab:C},null,8,["folders","filter-manager","visible-folders","tab"])])])],64)):E("",!0),c.value?(m(),w(Z,{key:1},[p.value&&p.value.length?(m(),w("div",Oo,[$[11]||($[11]=a("div",{class:"custom-hr"},null,-1)),a("div",Vo,[a("div",Fo,[a("div",null,[a("b",null,L(z.$t("main.nav.tasks.title")),1)])]),$[10]||($[10]=a("div",{class:"custom-hr"},null,-1)),I(e).state.tasks?(m(),w("div",Uo,[(m(!0),w(Z,null,J(p.value,(P,r)=>(m(),w("div",Do,[r?(m(),w("div",Bo)):E("",!0),R(to,{task:P},null,8,["task"])]))),256))])):E("",!0)])])):E("",!0)],64)):E("",!0),$[18]||($[18]=a("div",{class:"custom-hr"},null,-1)),a("div",Go,[c.value?(m(),w("div",Ho,[R(B,{message:"main.nav.properties.properties_tooltip",pos:"top",icon:!0},{default:T(()=>[a("b",null,L(z.$t("main.nav.properties.title")),1)]),_:1}),$[13]||($[13]=a("span",{class:"flex-grow-1"},null,-1)),h.value?(m(),w("span",Zo,$[12]||($[12]=[a("span",{class:"sr-only"},null,-1)]))):(m(),w("span",No,[R(B,{pos:"right",message:"main.nav.properties.import_properties_tooltip"},{default:T(()=>[a("i",{class:"bi bi-box-arrow-in-up text-secondary",style:{position:"relative",top:"0px","font-size":"15px"},onClick:n})]),_:1})])),a("span",Wo,[R(B,{pos:"right",message:"main.nav.properties.export_properties_tooltip"},{default:T(()=>[a("i",{class:"bi bi-box-arrow-up text-secondary",style:{position:"relative",top:"0px","font-size":"15px"},onClick:$[3]||($[3]=P=>I(o).showModal(I(le).EXPORT,void 0))})]),_:1})])])):E("",!0),I(e).loaded?(m(),w("div",qo,[R(So,{tab:C,"menu-open":c.value},null,8,["tab","menu-open"]),c.value?(m(),w(Z,{key:0},[$[16]||($[16]=a("div",{class:"property-item m-0 p-0"},null,-1)),a("div",{id:"add-property",onClick:$[4]||($[4]=P=>{I(o).showModal(I(le).PROPERTY,void 0),I(et)()}),class:"btn-icon base-hover mt-1",style:{"line-height":"25px"}},[$[14]||($[14]=a("i",{class:"bi bi-plus btn-icon float-start",style:{"font-size":"25px"}},null,-1)),a("span",null,L(z.$t("main.nav.properties.add_property")),1)]),$[17]||($[17]=a("div",{class:"custom-hr mt-1"},null,-1)),a("div",{onClick:$[5]||($[5]=P=>I(s).addPropertyGroup("New Group")),class:"btn-icon base-hover mt-1",style:{"line-height":"25px"}},[$[15]||($[15]=a("i",{class:"bi bi-plus btn-icon float-start",style:{"font-size":"25px"}},null,-1)),a("span",null,L(z.$t("main.nav.properties.add_property_group")),1)])],64)):E("",!0)])):E("",!0)])])])],4)]),_:1},8,["id"]))}}),Ko=j(jo,[["__scopeId","data-v-33a01314"]]),Qo={class:"p-0 hover-light ps-1 bb",style:{width:"50px"}},Jo={class:""},ea=["onClick"],ta=H({__name:"FilterGroupOperator",props:{modelValue:{}},emits:["update:modelValue"],setup(M,{emit:t}){const e=M,s=t;function o(l){s("update:modelValue",l)}return(l,v)=>(m(),U(ie,null,{button:T(()=>[a("div",Qo,[a("span",Jo,L(l.$t("modals.filters."+e.modelValue)),1)])]),popup:T(({hide:h})=>[a("div",{class:"ps-2 pt-1 pb-1 pe-2",onClick:h},[a("div",{class:"base-btn",onClick:v[0]||(v[0]=c=>o(I(pt).and))},L(l.$t("modals.filters.and")),1),v[2]||(v[2]=a("hr",{class:"m-0 p-0 mt-1 mb-1"},null,-1)),a("div",{class:"base-btn",onClick:v[1]||(v[1]=c=>o(I(pt).or))},L(l.$t("modals.filters.or")),1)],8,ea)]),_:1}))}}),sa=["disabled"],oa={class:"m-0 p-1"},aa=["onClick"],ia=H({__name:"OperatorChoice",props:{propertyId:{},modelValue:{},disabled:{type:Boolean}},emits:["hide","update:modelValue"],setup(M,{emit:t}){const e=X(),s=M,o=t,l=D(()=>e.properties[s.propertyId]),v=D(()=>es(l.value.type));async function h(c){o("update:modelValue",c)}return(c,i)=>(m(),U(ie,{onHide:i[0]||(i[0]=n=>o("hide")),placement:"bottom"},{button:T(()=>[a("div",{class:"text-nowrap sb ps-1 pe-1",disabled:s.disabled},[a("span",null,L(c.$t("modals.filters.operators."+s.modelValue)),1)],8,sa)]),popup:T(({hide:n})=>[a("div",oa,[(m(!0),w(Z,null,J(v.value,p=>(m(),w("div",{class:"hover-light p-1 rounded",style:{cursor:"pointer"},onClick:u=>{h(p),n()}},[a("a",null,L(c.$t("modals.filters.operators."+p)),1)],8,aa))),256))])]),_:1}))}}),na=j(ia,[["__scopeId","data-v-21b8bb8e"]]),ra={class:"d-flex text-nowrap overflow-hidden",style:{"font-size":"14px"}},la=H({__name:"FilterValueInput",props:{modelValue:{},property:{},width:{}},emits:["update:modelValue"],setup(M,{emit:t}){const e=M,s=t;function o(l){s("update:modelValue",l)}return(l,v)=>(m(),w("div",ra,[I(Ce)(l.property.type)?(m(),U(ts,{key:0,"model-value":e.modelValue,"onUpdate:modelValue":o,"no-wrap":!0,"auto-focus":!0,"can-create":!1,"can-customize":!1,property:e.property,teleport:!1,width:e.width,class:"sb","force-multi":!0},null,8,["model-value","property","width"])):e.property.type==I(ee).color?(m(),U(ss,{key:1,"model-value":e.modelValue,"onUpdate:modelValue":o,width:e.width,rounded:!0,"min-height":22,teleport:!1,offset:2,class:"sb"},null,8,["model-value","width"])):e.property.type==I(ee).number?(m(),U(os,{key:2,"model-value":e.modelValue,"onUpdate:modelValue":o,width:e.width,height:26,"input-offset":0,class:"sb"},null,8,["model-value","width"])):e.property.type==I(ee).url?(m(),U(as,{key:3,"model-value":e.modelValue,"onUpdate:modelValue":o,width:e.width,offset:-22,class:"sb"},null,8,["model-value","width"])):e.property.type==I(ee).checkbox?(m(),U(is,{key:4,"model-value":e.modelValue,"onUpdate:modelValue":o,label:e.property.name,width:e.width,class:"sb"},null,8,["model-value","label","width"])):e.property.type==I(ee).date?(m(),U(ns,{key:5,"model-value":e.modelValue,teleport:!1,"onUpdate:modelValue":o,width:e.width,class:"sb"},null,8,["model-value","width"])):(m(),U(rs,{key:6,"model-value":e.modelValue,"onUpdate:modelValue":o,width:e.width,offset:-22,class:"sb"},null,8,["model-value","width"]))]))}}),ua={class:"p-0 m-0 ps-2"},da=H({__name:"FilterRow",props:{manager:{},filter:{}},emits:[],setup(M,{emit:t}){const e=X(),s=M,o=D(()=>e.properties[s.filter.propertyId]),l=D(()=>ls(s.filter.operator));function v(i){s.manager.updateFilter(s.filter.id,{operator:i})}function h(i){s.manager.updateFilter(s.filter.id,{value:i})}function c(i){s.manager.updateFilter(s.filter.id,{propertyId:i.id})}return(i,n)=>(m(),w(Z,null,[a("td",ua,[R(us,{"model-value":o.value,"onUpdate:modelValue":c},null,8,["model-value"])]),a("td",null,[R(na,{"property-id":o.value.id,"model-value":s.filter.operator,"onUpdate:modelValue":v},null,8,["property-id","model-value"])]),a("td",null,[l.value?(m(),U(la,{key:0,"model-value":s.filter.value,"onUpdate:modelValue":h,property:o.value,width:140,style:{width:"150px"},class:""},null,8,["model-value","property"])):E("",!0)])],64))}}),ca={style:{"max-height":"500px",overflow:"auto"}},Nt=H({__name:"AddFilterBtn",props:{group:{},manager:{}},emits:[],setup(M,{emit:t}){const e=M;function s(o){e.manager.addNewFilter(o,e.group.id),Re.filter.show()}return(o,l)=>(m(),U(ie,{placement:"auto"},{button:T(()=>[Pt(o.$slots,"default")]),popup:T(({hide:v})=>[a("div",ca,[R(Rt,{onSelect:h=>{s(h),v()},"ignore-ids":[I(at).folders]},null,8,["onSelect","ignore-ids"])])]),_:3}))}}),pa={class:"filter-group"},ha={class:"table table-sm"},va={style:{height:"33px"}},ma={class:""},fa={key:0,class:"m-0 p-0"},ga={key:2,class:"text-secondary"},ya={class:"border rounded"},ba={class:""},_a=["onClick"],xa={class:"d-flex text-secondary ms-2"},wa={class:"add-options hover-light"},ka=H({__name:"FilterGroup",props:{filter:{},manager:{},parent:{}},emits:["delete"],setup(M,{emit:t}){X();const e=M,s=D(()=>e.filter),o=D(()=>s.value.filters),l=D(()=>{let i=255-(s.value.depth+1)*5;return`background: rgb(${i},${i},${i});`});function v(i){e.manager.deleteFilter(i.id)}function h(i){e.manager.addNewFilterGroup(i)}function c(i,n){e.manager.updateFilterGroup(i,n)}return(i,n)=>(m(),w("div",pa,[a("table",ha,[(m(!0),w(Z,null,J(o.value,(p,u)=>(m(),w("tr",va,[a("td",ma,[u==0?(m(),w("div",fa,L(i.$t("modals.filters.where")),1)):u==1?(m(),U(ta,{key:1,"model-value":s.value.groupOperator,"onUpdate:modelValue":n[0]||(n[0]=b=>c(s.value.id,b))},null,8,["model-value"])):(m(),w("span",ga,L(i.$t("modals.filters."+s.value.groupOperator)),1))]),p.propertyId!==void 0?(m(),U(da,{key:0,filter:p,manager:e.manager},null,8,["filter","manager"])):(m(),w("td",{key:1,colspan:"3",style:te(l.value)},[a("div",ya,[R(Wt,{filter:p,manager:e.manager},null,8,["filter","manager"])])],4)),a("td",ba,[a("span",{class:"base-btn",onClick:b=>v(p)},n[2]||(n[2]=[a("i",{class:"bi bi-trash"},null,-1)]),8,_a)])]))),256))]),a("div",xa,[R(Nt,{group:e.filter,manager:e.manager},{default:T(()=>[a("div",wa,[n[3]||(n[3]=a("i",{class:"bi bi-plus"},null,-1)),ae(L(i.$t("modals.filters.new_filter")),1)])]),_:1},8,["group","manager"]),a("div",{class:"add-options hover-light",onClick:n[1]||(n[1]=p=>h(s.value.id))},[n[4]||(n[4]=a("i",{class:"bi bi-plus"},null,-1)),ae(L(i.$t("modals.filters.new_group")),1)])])]))}}),Wt=j(ka,[["__scopeId","data-v-e644f737"]]),$a={key:0,class:"d-flex flex-row m-0 ms-1 p-1 bg hover-light bg-medium",style:{cursor:"pointer"}},Ma={key:0},Sa={key:0,class:"or-separator"},Ia={key:0,class:"or-separator"},Ca={key:0,class:"m-1 p-1"},Pa=H({__name:"MainFilterDropdown",props:{manager:ot},emits:["update:modelValue"],setup(M,{emit:t}){const e=X(),s=M,o=V(null),l=V(null),v=D(()=>{let c=h(s.manager.state.filter),i={};return c.forEach(n=>i[n.propertyId]=n),Object.values(i)});function h(c){let i=[];for(let n of c.filters)n.isGroup?i.push(...h(n)):i.push(n);return i}return N(()=>s.manager.state.filter.filters,()=>{s.manager.state.filter.filters.length==0&&l.value.hide()}),se(async()=>{await re(),Re.filter=l.value}),(c,i)=>(m(),U(ie,{ref_key:"dropdownElem",ref:l,placement:"top-start"},{button:T(()=>[a("div",null,[v.value.length||s.manager.state.query?.text?(m(),w("div",$a,[s.manager.state.query?.text?(m(),w("div",Ma,[i[0]||(i[0]=a("span",{class:"text-primary"},"Text Query",-1)),v.value.length?(m(),w("span",Sa,"|")):E("",!0)])):E("",!0),(m(!0),w(Z,null,J(v.value,(n,p)=>(m(),w("div",null,[p>0?(m(),w("span",Ia,"|")):E("",!0),n.propertyId==I(at).id?(m(),U(Se,{key:1,type:I(e).properties[n.propertyId].type,style:{"margin-right":"2px"}},null,8,["type"])):E("",!0),a("span",null,L(I(e).properties[n.propertyId].name),1)]))),256))])):E("",!0)])]),popup:T(()=>[a("div",{class:"m-0 p-0",ref_key:"popupElem",ref:o},[Object.keys(I(e).properties).length>0?(m(),w("div",Ca,[R(Wt,{filter:s.manager.state.filter,manager:s.manager,parent:o.value},null,8,["filter","manager","parent"])])):E("",!0)],512)]),_:1},512))}}),za=j(Pa,[["__scopeId","data-v-6382f4d7"]]),Ra={class:"d-flex flex-row filter-form"},Ea={class:"pt-1 pb-1"},Ta=H({__name:"FilterForm",props:{manager:ot},setup(M){const t=M;return(e,s)=>(m(),w("div",Ra,[a("div",Ea,L(e.$t("main.menu.filters"))+": ",1),R(za,{manager:t.manager},null,8,["manager"]),R(Nt,{manager:t.manager,group:t.manager.state.filter,class:"p-1"},{default:T(()=>s[0]||(s[0]=[a("span",{class:"base-hover plus-btn text-secondary"},[a("i",{class:"bi bi-plus"})],-1)])),_:1},8,["manager","group"])]))}}),Aa=j(Ta,[["__scopeId","data-v-cc2f25ec"]]),La={class:"p-1",style:{"max-height":"400px","overflow-y":"scroll"}},Oa=H({__name:"PropertyDropdown",props:{groupIds:Array},emits:["select"],setup(M,{emit:t}){const e=M,s=t,o=V(null);return(l,v)=>(m(),U(ie,{ref_key:"dropdownElem",ref:o,"auto-focus":!1},{button:T(()=>v[2]||(v[2]=[a("div",{class:"text-secondary p-1"},[a("span",{class:"base-hover plus-btn"},[a("i",{class:"bi bi-plus"})])],-1)])),popup:T(()=>[a("div",La,[R(Rt,{onClick:v[0]||(v[0]=h=>I(et)()),onSelect:v[1]||(v[1]=h=>{s("select",h),o.value.hide()}),"ignore-ids":e.groupIds},null,8,["ignore-ids"])])]),_:1},512))}}),qt=j(Oa,[["__scopeId","data-v-012e1f38"]]),Va={class:"base-hover ps-1 pe-1"},Fa={class:"main"},Ua=["onClick"],Da=H({__name:"TimeUnitDropdown",props:{modelValue:{}},emits:["update:modelValue"],setup(M,{emit:t}){const e=M,s=t,o=Object.values(Et);function l(v){s("update:modelValue",v)}return(v,h)=>(m(),U(ie,null,{button:T(()=>[a("div",Va,L(e.modelValue),1)]),popup:T(({hide:c})=>[a("div",Fa,[(m(!0),w(Z,null,J(I(o),i=>(m(),w("div",{class:"base-hover option",onClick:n=>{l(i),c()}},L(i),9,Ua))),256))])]),_:1}))}}),Ba=j(Da,[["__scopeId","data-v-ce3e3774"]]),Ga={class:""},Ha={class:"d-flex ipt"},Za={class:"ms-2",min:"1"},Na=H({__name:"GroupOptionDropdown",props:{option:{}},emits:["change"],setup(M,{emit:t}){const e=M,s=t,o=V(1),l=V(Et.Year);function v(){e.option.stepSize==o.value&&e.option.stepUnit==l.value||s("change",{stepSize:o.value,stepUnit:l.value})}function h(){o.value=e.option.stepSize??1,l.value=e.option.stepUnit}return N(()=>e.option,h),se(h),N(o,()=>{(o.value<1||o.value==null||isNaN(o.value))&&(o.value=1)}),(c,i)=>(m(),U(ie,{onHide:v},{button:T(()=>i[2]||(i[2]=[a("i",{class:"bi bi-three-dots-vertical"},null,-1)])),popup:T(({hide:n,focus:p})=>[a("div",Ga,[a("div",Ha,[a("div",null,[Te(a("input",{type:"number","onUpdate:modelValue":i[0]||(i[0]=u=>o.value=u)},null,512),[[Ae,o.value]])]),a("div",Za,[R(Ba,{modelValue:l.value,"onUpdate:modelValue":i[1]||(i[1]=u=>l.value=u),onHide:p},null,8,["modelValue","onHide"])])])])]),_:1}))}}),Wa=j(Na,[["__scopeId","data-v-78b647dc"]]),qa={class:"d-flex flex-row group-form"},Ya={class:"pt-1 pb-1"},Xa={key:0,class:"bg-selected bg d-flex flex-row m-0 ms-1 p-0 align-items-center"},ja={key:0,class:"bi bi-chevron-right smaller"},Ka=["onClick"],Qa=["onClick"],Ja=["onClick"],ei=["onClick"],ti=["onClick"],si=["onClick"],oi=["onClick"],ai=["onClick"],ii=["onClick"],ni={key:5,class:"sm-btn"},ri={key:0,class:"spinner-grow spinner-grow-sm loading ms-1"},li=H({__name:"GroupForm",props:{isLoading:Boolean,manager:ds},setup(M){const t=X(),e=M;function s(n){e.manager.setGroupOption(n),e.manager.update(!0)}function o(n){e.manager.delGroupOption(n),e.manager.update(!0)}function l(n,p){e.manager.setGroupOption(n,{direction:p}),e.manager.sortGroups(!0)}function v(n,p){e.manager.setGroupOption(n,{type:p}),e.manager.sortGroups(!0)}function h(n,p){e.manager.setGroupOption(n,p),e.manager.update(!0)}const c=D(()=>e.manager.state.groupBy.map(n=>t.properties[n])),i=D(()=>{const n=[];return e.manager.state.groupBy.forEach(p=>{n.push({option:e.manager.state.options[p],property:t.properties[p]})}),n});return(n,p)=>(m(),w("div",qa,[a("div",Ya,L(n.$t("main.menu.groupby"))+": ",1),c.value.length?(m(),w("div",Xa,[(m(!0),w(Z,null,J(i.value,(u,b)=>(m(),w(Z,null,[b>0?(m(),w("i",ja)):E("",!0),a("div",{class:"base-hover m-1 ps-1 pe-1",onClick:S=>o(u.property.id),id:"remove-group-button"},L(u.property.name),9,Ka),u.option.type==I(pe).Size?(m(),U(B,{key:1,message:"main.menu.sort.group_order_nb_tooltip"},{default:T(()=>[u.option.direction==I(ue).Ascending?(m(),w("i",{key:0,class:"bi bi-sort-up-alt sm-btn",onClick:S=>v(u.property.id,I(pe).Property)},null,8,Qa)):(m(),w("i",{key:1,class:"bi bi-sort-down sm-btn",onClick:S=>v(u.property.id,I(pe).Property)},null,8,Ja))]),_:2},1024)):(m(),U(B,{key:2,message:"main.menu.sort.group_order_az_tooltip"},{default:T(()=>[u.property.type==I(ee).number?(m(),w(Z,{key:0},[u.option.direction==I(ue).Ascending?(m(),w("i",{key:0,class:"bi bi-sort-numeric-up sm-btn",onClick:S=>v(u.property.id,I(pe).Size)},null,8,ei)):(m(),w("i",{key:1,class:"bi bi-sort-numeric-down-alt sm-btn",onClick:S=>v(u.property.id,I(pe).Size)},null,8,ti))],64)):(m(),w(Z,{key:1},[u.option.direction==I(ue).Ascending?(m(),w("i",{key:0,class:"bi bi-sort-alpha-up sm-btn",onClick:S=>v(u.property.id,I(pe).Size)},null,8,si)):(m(),w("i",{key:1,class:"bi bi-sort-alpha-down-alt sm-btn",onClick:S=>v(u.property.id,I(pe).Size)},null,8,oi))],64))]),_:2},1024)),u.option.direction==I(ue).Ascending?(m(),U(B,{key:3,message:"main.menu.sort.order_asc"},{default:T(()=>[a("i",{class:"bi bi-arrow-up sm-btn",onClick:S=>l(u.property.id,I(ue).Descending)},null,8,ai)]),_:2},1024)):(m(),U(B,{key:4,message:"main.menu.sort.order_desc"},{default:T(()=>[a("i",{class:"bi bi-arrow-down sm-btn",onClick:S=>l(u.property.id,I(ue).Ascending)},null,8,ii)]),_:2},1024)),u.property.type==I(ee).date?(m(),w("div",ni,[R(Wa,{option:u.option,onChange:S=>h(u.property.id,S)},null,8,["option","onChange"])])):E("",!0)],64))),256)),e.isLoading?(m(),w("i",ri)):E("",!0)])):E("",!0),R(qt,{id:"add-group-button","group-ids":e.manager.state.groupBy,onSelect:p[0]||(p[0]=u=>s(u))},null,8,["group-ids"])]))}}),ui=j(li,[["__scopeId","data-v-81bcbb10"]]),di={class:"d-flex flex-row sort-form"},ci={class:"pt-1 pb-1"},pi={key:0,class:"d-flex flex-row m-0 p-0 bg-medium bg ms-1 align-items-center"},hi={key:0,class:"bi bi-chevron-right smaller"},vi=["onClick"],mi=["onClick"],fi=["onClick"],gi=H({__name:"SortForm",props:{manager:cs},setup(M){const t=X(),e=M,s=D(()=>e.manager.state.sortBy.map(c=>({propertyId:c,direction:e.manager.state.options[c].direction}))),o=D(()=>s.value.map(c=>c.propertyId));function l(c){e.manager.setSort(c),e.manager.update(!0)}function v(c){e.manager.delSort(c),e.manager.update(!0)}function h(c,i){e.manager.setSort(c,{direction:i}),e.manager.update(!0)}return(c,i)=>(m(),w("div",di,[a("div",ci,L(c.$t("main.menu.sort.title"))+": ",1),s.value.length?(m(),w("div",pi,[(m(!0),w(Z,null,J(s.value,(n,p)=>(m(),w(Z,null,[p>0?(m(),w("i",hi)):E("",!0),a("div",{class:"me-0 ms-1 ps-1 mt-1 mb-1 pe-1 base-hover",onClick:u=>v(n.propertyId)},L(I(t).properties[n.propertyId].name),9,vi),n.direction==I(ue).Ascending?(m(),U(B,{key:1,message:"main.menu.sort.order_asc"},{default:T(()=>[a("i",{class:"bi bi-arrow-up sm-btn",onClick:u=>h(n.propertyId,I(ue).Descending)},null,8,mi)]),_:2},1024)):(m(),U(B,{key:2,message:"main.menu.sort.order_desc"},{default:T(()=>[a("i",{class:"bi bi-arrow-down sm-btn",onClick:u=>h(n.propertyId,I(ue).Ascending)},null,8,fi)]),_:2},1024))],64))),256))])):E("",!0),R(qt,{"group-ids":o.value,onSelect:i[0]||(i[0]=n=>l(n))},null,8,["group-ids"])]))}}),yi=j(gi,[["__scopeId","data-v-4e00ef99"]]),bi={class:"p-2"},_i={key:0,class:"border mb-1 p-1 text-center text-secondary",style:{"background-color":"#f7f7f7"}},xi={class:"border mb-1 p-1"},wi={class:"me"},ki={key:0},$i={key:1},Mi={class:"border mb-1 p-1",style:{"background-color":"#f7f7f7"}},Si={class:"d-flex center justify-content-center"},Ii={key:1,class:"bi bi-arrow-down text-secondary"},Ci={key:3,class:"bi bi-arrow-up text-secondary"},Pi={class:"border mb-1 p-1"},zi={class:"me"},Ri={key:0},Ei={key:1},Ti={key:1,class:"border mb-1 p-1 text-center text-secondary",style:{"background-color":"#f7f7f7"}},me=5,Ai=H({__name:"HistoryDropdown",emits:[],setup(M,{emit:t}){const e=X(),s=V(!1),o=D(()=>s.value?{backgroundColor:"blue"}:{backgroundColor:"white"}),l=D(()=>[...e.history.undo].reverse().slice(0,me)),v=D(()=>e.history.redo.slice(Math.max(e.history.redo.length-me,0)));return N(()=>e.onUndo,()=>{console.log("changed"),s.value=!0,setTimeout(()=>s.value=!1,100)}),(h,c)=>l.value.length||v.value.length?(m(),U(ie,{key:0},{button:T(()=>[R(B,{message:"dropdown.history.info"},{default:T(()=>[a("div",{class:"d-flex sb flash",style:te([{"font-size":"14px"},o.value])},[c[2]||(c[2]=a("i",{class:"bi bi-clock-history me-1"},null,-1)),a("div",null,L(h.$t("dropdown.history.button")),1)],4)]),_:1})]),popup:T(()=>[a("div",bi,[I(e).history.redo.length>me?(m(),w("div",_i," + "+L(I(e).history.redo.length-me),1)):E("",!0),(m(!0),w(Z,null,J(v.value,i=>(m(),w("div",xi,[a("span",wi,L(new Date(i.timestamp).toLocaleTimeString("fr-Fr",{hour:"2-digit",minute:"2-digit"})),1),c[3]||(c[3]=a("span",{class:"sep ms-1 me-1"},null,-1)),i.tags?(m(),w("span",ki,L(i.tags)+" "+L(h.$t("dropdown.history.tags")),1)):E("",!0),i.values?(m(),w("span",$i,L(i.values)+" "+L(h.$t("dropdown.history.values")),1)):E("",!0)]))),256)),a("div",Mi,[a("div",Si,[l.value.length?(m(),U(B,{key:0,message:"dropdown.history.undo"},{default:T(()=>[a("div",{class:"bi bi-arrow-down sb",onClick:c[0]||(c[0]=(...i)=>I(e).undo&&I(e).undo(...i))})]),_:1})):(m(),w("div",Ii)),c[4]||(c[4]=a("div",{style:{width:"30px"}},null,-1)),v.value.length?(m(),U(B,{key:2,message:"dropdown.history.redo"},{default:T(()=>[a("div",{class:"bi bi-arrow-up sb",onClick:c[1]||(c[1]=(...i)=>I(e).redo&&I(e).redo(...i))})]),_:1})):(m(),w("div",Ci))])]),(m(!0),w(Z,null,J(l.value,i=>(m(),w("div",Pi,[a("span",zi,L(new Date(i.timestamp).toLocaleTimeString("fr-Fr",{hour:"2-digit",minute:"2-digit"})),1),c[5]||(c[5]=a("span",{class:"sep ms-1 me-1"},null,-1)),i.tags?(m(),w("span",Ri,L(i.tags)+" "+L(h.$t("dropdown.history.tags")),1)):E("",!0),i.values?(m(),w("span",Ei,L(i.values)+" "+L(h.$t("dropdown.history.values")),1)):E("",!0)]))),256)),I(e).history.undo.length>me?(m(),w("div",Ti," + "+L(I(e).history.undo.length-me),1)):E("",!0)])]),_:1})):E("",!0)}}),Li=j(Ai,[["__scopeId","data-v-85cd80d0"]]),Oi=H({__name:"ToggleReload",props:{tab:{}},emits:[],setup(M,{emit:t}){const e=M,s=D(()=>e.tab.collection.state.autoReload?2:e.tab.collection.runState.isDirty?0:1);function o(){s.value==0?e.tab.collection.update():s.value==1?e.tab.collection.setAutoReload(!0):e.tab.collection.setAutoReload(!1)}return(l,v)=>(m(),w("div",{class:"bb font",onClick:o,style:{width:"26px",height:"30px",overflow:"hidde"}},[s.value==0?(m(),U(B,{key:0,message:"btn.reload.dirty",pos:"bottom"},{default:T(()=>v[0]||(v[0]=[a("span",{class:"bi bi-arrow-repeat text-warning"},null,-1)])),_:1})):E("",!0),s.value==1?(m(),U(B,{key:1,message:"btn.reload.valid",pos:"bottom"},{default:T(()=>v[1]||(v[1]=[a("span",{class:"bi bi-check2-all text-success"},null,-1)])),_:1})):E("",!0),s.value==2?(m(),U(B,{key:2,message:"btn.reload.auto",pos:"bottom"},{default:T(()=>v[2]||(v[2]=[a("div",{style:{height:"30px"}},[a("span",{class:"bi bi-check2-all text-success small-valid"}),a("span",{class:"bi bi-arrow-repeat big-arrow text-warning",style:{opacity:"0.3"}})],-1)])),_:1})):E("",!0)]))}}),Vi=j(Oi,[["__scopeId","data-v-91d89d17"]]),Fi=["onSubmit"],Ui={class:"mb-1"},Di={class:"d-flex flex-center mt-3",style:{height:"20px"}},Bi=["onClick"],Gi=["onClick"],Hi=H({__name:"InputOptions",props:{functionId:{},size:{},hideText:{type:Boolean}},emits:["changed"],setup(M,{emit:t}){const e=Le(),s=M,o=t,l=V([]),v=D(()=>s.size?s.size:12),h=D(()=>s.functionId.slice(0,s.functionId.indexOf(".")));function c(){if(!s.functionId||!e.index[s.functionId])return;const p=e.index[s.functionId].params,u=e.getContext(s.functionId).uiInputs;for(let b of p)b.defaultValue=u[b.name];l.value=JSON.parse(JSON.stringify(p))}async function i(){for(let p in l.value)e.index[s.functionId].params[p].defaultValue=l.value[p].defaultValue;await e.updateDefaultParams(),o("changed")}function n(){c()}return se(c),(p,u)=>l.value.length?(m(),w("div",{key:0,style:te({fontSize:v.value+"px"})},[R(ie,null,{button:T(()=>[a("div",null,[R(B,{message:"Options"},{default:T(()=>u[0]||(u[0]=[a("span",{class:"bbb"},[a("i",{class:"bi bi-gear"})],-1)])),_:1})])]),popup:T(({hide:b})=>[a("form",{onSubmit:ce(S=>{i(),b()},["prevent"]),class:"p-2"},[(m(!0),w(Z,null,J(l.value,(S,z)=>(m(),w("div",Ui,[S.name=="text"&&s.hideText?E("",!0):(m(),U(Tt,{key:0,input:S,source:h.value},null,8,["input","source"]))]))),256)),a("div",Di,[u[1]||(u[1]=a("div",{class:"flex-grow-1"},null,-1)),a("div",{class:"bb",onClick:S=>{n(),b()}},L(p.$t("cancel")),9,Bi),a("div",{class:"bb",onClick:S=>{i(),b()}},L(p.$t("confirm")),9,Gi)])],40,Fi)]),_:1})],4)):E("",!0)}}),Zi={class:"cont3"},Ni={class:"select-wrapper"},Wi=["placeholder"],qi={style:{width:"22px"}},Yi={key:0},Xi=H({__name:"TextSearchInput",props:{query:{}},emits:["update:query"],setup(M,{emit:t}){const e=Le(),s=M,o=t,l=V(null),v=V(!1),h=[{value:"text",icon:"search"},{value:"regex",icon:"regex"}],c=V([]),i=V("text"),n=V(""),p=D(()=>i.value!="text"&&i.value!="regex");function u(){const C=e.textSearchFunctions.map(P=>({value:P.id,icon:"boxes"}));c.value=[...h,...C]}function b(){s.query&&(i.value=s.query.type||"text",n.value=s.query.text||"")}function S(){n.value="",$()}function z(){$()}function $(){const C={type:i.value,text:n.value};if(p.value){if(!e.index[i.value]){i.value="text",S();return}const P=e.getContext(i.value);P.uiInputs.text=n.value,C.ctx=P}o("update:query",C)}return u(),N(()=>s.query,b,{deep:!0}),N(()=>e.textSearchFunctions,u),N(i,$),se(()=>{u(),b()}),q.ctrlF.on(()=>l.value?.focus()),(C,P)=>(m(),w("div",Zi,[a("div",Ni,[R(it,{options:c.value,modelValue:i.value,"onUpdate:modelValue":P[0]||(P[0]=r=>i.value=r),placeholder:"Search Mode",class:"bg-white",size:16},null,8,["options","modelValue"])]),a("div",{class:Y(["input-field d-flex items-align-center",{focus:v.value}])},[Te(a("input",{class:"text-input2",type:"text","onUpdate:modelValue":P[1]||(P[1]=r=>n.value=r),placeholder:C.$t("main.menu.search"),ref_key:"inputElem",ref:l,onFocusin:P[2]||(P[2]=r=>v.value=!0),onFocusout:P[3]||(P[3]=r=>v.value=!1),onKeypress:At(z,["enter"])},null,40,Wi),[[Ae,n.value]]),a("div",qi,[n.value.length?(m(),w("i",{key:0,class:"bi bi-x sb",onClick:S})):E("",!0)])],2),p.value?(m(),w("div",Yi,[R(Hi,{"function-id":i.value,size:14,"hide-text":!0,onChanged:$},null,8,["function-id"])])):E("",!0)]))}}),ji=j(Xi,[["__scopeId","data-v-e749d0c6"]]),Ki={class:"d-flex flex-row p-2 align-items-center"},Qi={class:"me-3 d-flex"},Ji={class:"ms-5",style:{"font-size":"13px"}},en=["checked"],tn={class:"ms-1"},sn={class:"ms-4"},on={class:"d-flex flex-wrap content-container ps-2"},an=H({__name:"ContentFilter",props:{tab:{},computeStatus:{}},emits:["compute-ml","search-images","remove:selected"],setup(M,{emit:t}){ps();const e=M,s=V(),o=D(()=>Object.keys(e.tab.collection.groupManager.selectedImages.value).map(Number)),l=D(()=>o.value.length);function v(i){const n=i.target.checked;e.tab.collection.groupManager.setSha1Mode(n,!0)}function h(){console.log("get local",e.tab.state.filterState.query),s.value=e.tab.state.filterState.query}function c(i){s.value=i,e.tab.collection.filterManager.setQuery(s.value),e.tab.collection.filterManager.update(!0),e.tab.saveState()}return se(h),N(()=>e.tab.collection.filterManager.state.query,h),(i,n)=>(m(),w(Z,null,[a("div",Ki,[R(ji,{class:"me-3",style:{"flex-shrink":"0"},query:s.value,"onUpdate:query":c},null,8,["query"]),a("div",Qi,[R(B,{message:"main.menu.grid_tooltip"},{default:T(()=>[a("i",{class:Y("bi bi-grid-3x3-gap-fill me-2 btn-icon"+(e.tab.state.display=="tree"?"":" text-secondary")),onClick:n[0]||(n[0]=p=>e.tab.setViewMode("tree"))},null,2)]),_:1}),R(B,{message:"main.menu.table_tooltip"},{default:T(()=>[a("i",{id:"toot",class:Y("bi bi-table btn-icon me-2"+(e.tab.state.display=="grid"?"":" text-secondary")),onClick:n[1]||(n[1]=p=>e.tab.setViewMode("grid"))},null,2)]),_:1}),R(B,{message:"main.menu.graph_tooltip"},{default:T(()=>[a("i",{id:"toot",class:Y("bi bi-bar-chart btn-icon me-2"+(e.tab.state.display=="graph"?"":" text-secondary")),onClick:n[2]||(n[2]=p=>e.tab.setViewMode("graph"))},null,2)]),_:1}),R(B,{message:"main.menu.map_tooltip"},{default:T(()=>[a("i",{id:"toot",class:Y("bi bi-map btn-icon"+(e.tab.state.display=="map"?"":" text-secondary")),onClick:n[3]||(n[3]=p=>e.tab.setViewMode("map"))},null,2)]),_:1})]),R(B,{message:"main.menu.image_size_tooltip",click:!1},{default:T(()=>n[7]||(n[7]=[a("div",{class:"bi bi-aspect-ratio me-1"},null,-1)])),_:1}),a("div",null,[R(tt,{min:30,max:500,modelValue:e.tab.state.imageSize,"onUpdate:modelValue":n[4]||(n[4]=p=>e.tab.state.imageSize=p)},null,8,["modelValue"])]),a("div",Ji,[R(B,{message:"main.menu.image_mode_tooltip"},{default:T(()=>[a("input",{type:"checkbox",checked:e.tab.collection.groupManager.state.sha1Mode,onChange:v},null,40,en),a("span",tn,L(i.$t("main.menu.image_mode")),1)]),_:1})]),a("div",sn,[R(Li)]),a("div",null,[l.value?(m(),U(hs,{key:0,class:"ms-5",style:{"font-size":"14px"},"selected-images-ids":o.value,"onRemove:selected":n[5]||(n[5]=p=>e.tab.collection.groupManager.clearSelection()),onStamped:n[6]||(n[6]=p=>e.tab.collection.groupManager.clearSelection())},null,8,["selected-images-ids"])):E("",!0)]),n[9]||(n[9]=a("div",{class:"flex-grow-1"},null,-1)),R(B,{message:"main.menu.issue",class:"bb"},{default:T(()=>n[8]||(n[8]=[a("a",{href:"https://github.com/CERES-Sorbonne/Panoptic/issues/new/choose",target:"_blank",class:"bi bi-cone-striped",style:{color:"grey"}},null,-1)])),_:1})]),a("div",on,[R(Vi,{tab:e.tab,class:"me-1"},null,8,["tab"]),R(Aa,{manager:e.tab.collection.filterManager},null,8,["manager"]),R(ui,{"is-loading":e.computeStatus.groups,manager:e.tab.collection.groupManager},null,8,["is-loading","manager"]),R(yi,{manager:e.tab.collection.sortManager},null,8,["manager"]),n[10]||(n[10]=a("div",null,null,-1))])],64))}}),nn=j(an,[["__scopeId","data-v-59af2330"]]),rn={class:""},ln={class:"d-flex flex-row"},un=H({__name:"ImageRecomended",props:{pile:Object,size:{type:Number,default:100}},emits:["accept","refuse"],setup(M,{emit:t}){const e=be(),s=M,o=t,l=D(()=>`width: ${s.size}px; height: ${s.size}px;`);D(()=>`max-width: ${s.size-2}px; max-height: ${s.size-1}px;`);const v=D(()=>s.pile.images[0]);return(h,c)=>(m(),w("div",rn,[R(Lt,{image:v.value},{default:T(()=>[a("div",{style:te(l.value),class:"img-container",onClick:c[0]||(c[0]=i=>I(e).showModal(I(le).IMAGE,{image:v.value}))},[R(Ot,{image:v.value,width:s.size-2,height:s.size-1},null,8,["image","width","height"])],4)]),_:1},8,["image"]),a("div",ln,[R(B,{message:"main.recommand.accept"},{default:T(()=>[a("div",{style:te(["width: "+s.size/2+"px;",{"font-size":"10px"}]),class:"text-center text-success validate clickable unselectable",onClick:c[1]||(c[1]=i=>o("accept",v.value))}," ✓ ",4)]),_:1}),R(B,{message:"main.recommand.refuse"},{default:T(()=>[a("div",{style:te(["width: "+s.size/2+"px;",{"font-size":"10px"}]),class:"text-center text-danger refuse clickable unselectable",onClick:c[2]||(c[2]=i=>o("refuse",v.value))}," ✕ ",4)]),_:1})])]))}}),dn=j(un,[["__scopeId","data-v-2ff8fded"]]),cn={class:"bbb"},pn={class:"p-2"},hn=["onClick"],vn={key:0,class:"ms-1"},mn=["onSubmit"],fn={class:"mb-1"},gn={class:"d-flex flex-center mt-3",style:{height:"20px"}},yn=["onClick"],bn=["onClick"],_n=H({__name:"ActionSelect",props:{action:{},hideGear:{type:Boolean},size:{}},emits:["changed"],setup(M,{emit:t}){const e=Le(),s=M,o=t,l=D(()=>e.defaultActions[s.action]),v=V([]),h=V(null),c=D(()=>s.size?s.size:12),i=D(()=>Vt(e.index).filter(C=>C.hooks.includes(s.action)).map(C=>C.id)),n=D(()=>h.value.slice(0,h.value.indexOf(".")));function p(){h.value=l.value,u()}function u(){const $=h.value;if(!$||!e.index[$])return;const C=e.index[$].params,P=e.getContext($).uiInputs;for(let r of C)r.defaultValue=P[r.name];v.value=JSON.parse(JSON.stringify(C))}async function b(){const $=h.value;for(let C in v.value)e.index[$].params[C].defaultValue=v.value[C].defaultValue;await e.updateDefaultParams(),o("changed")}function S(){u()}async function z($){const C={};C[s.action]=$,await e.updateDefaultActions(C),await p(),o("changed")}return se(p),($,C)=>(m(),w("div",{class:"d-flex",style:te({fontSize:c.value+"px"})},[R(ie,null,{button:T(()=>[a("div",null,[h.value?(m(),U(B,{key:0,class:"p-0 m-0",message:I(e).index[h.value].description},{default:T(()=>[a("span",cn,[ae(L(h.value),1),C[0]||(C[0]=a("i",{class:"ms-1 bi bi-chevron-down"},null,-1))])]),_:1},8,["message"])):E("",!0)])]),popup:T(({hide:P})=>[a("div",pn,[(m(!0),w(Z,null,J(i.value,r=>(m(),w("div",{class:"bb",onClick:d=>{z(r),P()}},[R(B,{message:I(e).index[r].description},{default:T(()=>[ae(L(r),1)]),_:2},1032,["message"])],8,hn))),256))])]),_:1}),v.value.length&&!s.hideGear?(m(),w("div",vn,[R(ie,null,{button:T(()=>[a("div",null,[R(B,{message:"Options"},{default:T(()=>C[1]||(C[1]=[a("span",{class:"bbb"},[a("i",{class:"bi bi-gear"})],-1)])),_:1})])]),popup:T(({hide:P})=>[a("form",{onSubmit:ce(r=>{b(),P()},["prevent"]),class:"p-2"},[(m(!0),w(Z,null,J(v.value,(r,d)=>(m(),w("div",fn,[R(Tt,{input:r,source:n.value},null,8,["input","source"])]))),256)),a("div",gn,[C[2]||(C[2]=a("div",{class:"flex-grow-1"},null,-1)),a("div",{class:"bb",onClick:r=>{S(),P()}},L($.$t("cancel")),9,yn),a("div",{class:"bb",onClick:r=>{b(),P()}},L($.$t("confirm")),9,bn)])],40,mn)]),_:1})])):E("",!0)],4))}}),xn={class:"reco-container"},wn={class:"d-flex flex-row m-0 ps-2 center mb-1 mt-0",style:{height:"25px"}},kn={key:0,class:"bi bi-funnel-fill bb text-primary"},$n={key:1,class:"bi bi-funnel bb"},Mn={class:"text-secondary me-2"},Sn={style:{"padding-top":"2px"},class:"me-1"},In={class:"flex-grow-1"},Cn={class:"d-flex flex-row"},Pn={key:0,class:"separator"},zn={class:"d-flex flex-row"},De=10,Rn=H({__name:"RecommendedMenu",props:{tab:{},imageSize:{},group:{},width:{},height:{}},emits:["scroll","close","update"],setup(M,{emit:t}){const e=X(),s=Le(),o=M,l=t,v=V(1),h=Ie([]),c=V(null),i=Ie([]),n=Ie(new Set),p=V(!0),u=[],b=[];async function S(A){const g=[],y=[];i.forEach(_=>{if(_.value!=null){const f=e.properties[_.propertyId];let k=_.value;f.type==ee.multi_tags?(k=A.properties[_.propertyId]??[],k=[...k,_.value]):f.type==ee.tag&&(k=[k]),f.mode==Je.id?y.push({instanceId:A.id,propertyId:f.id,value:k}):g.push({propertyId:f.id,sha1:A.sha1,value:k})}}),await e.setPropertyValues(y,g)}function z(A){c.value.isSha1Group?c.value.images.filter(g=>g.sha1==A.sha1).forEach(g=>n.add(g.id)):n.add(A.id),O()}function $(){h.length=0;let A=[];const g=b.map(y=>e.instances[y]);if(c.value.isSha1Group){const y={},_=Array.from(new Set(g.map(f=>f.sha1)));_.forEach(f=>y[f]=[]),g.forEach(f=>y[f.sha1].push(f)),_.forEach(f=>A.push({sha1:f,images:e.sha1Index[f]}))}else g.forEach(y=>A.push({sha1:y.sha1,images:[y]}));C(A,h,v.value,o.imageSize,o.width)}function C(A,g,y,_,f){let k=f,F=[],G=0;for(let W=0;W<A.length&&!(g.length>=y);W++){let Q=A[W];if(Q.images=Q.images.filter(ne=>!n.has(ne.id)),Q.images.length==0)continue;let K=_+De;if(G+K<k){F.push(Q),G+=K;continue}if(F.length==0)throw new Error("Images seems to be to big for the line");g.push(F),g.length<y&&(F=[Q],G=K)}F.length>0&&g.length<y&&g.push(F)}async function P(){if(!o.group||!s.hasSimilaryFunction)return;const A=s.defaultActions.similar,g=s.getContext(A);g.instanceIds=o.group.images.map(F=>F.id);const y=await s.getSimilarImages(g);if(!y)return;if(!y.groups)throw new Error("No instances in ActionResult");let f=ms(y.groups)[0];if(p.value){const F=new Set(o.tab.collection.filterManager.result.images.map(G=>G.id));f.images=f.images.filter(G=>F.has(G.id))}f.scores&&fs(f),c.value=f,i.length=0;let k=o.group;for(;k;)i.push(...k.meta.propertyValues),k=k.parent;n.clear(),u.length=0,f.images.forEach(F=>u.push(F.id)),O(),l("update")}function r(){p.value=!p.value}function d(){o.tab.collection.groupManager.onResultChange.addListener(O)}function x(){o.tab.collection.groupManager.onResultChange.removeListener(O)}function O(){const A=o.tab.collection.groupManager.result.index[o.group.id];if(!A){l("close");return}b.length=0;const g=new Set(A.images.map(y=>y.id));u.forEach(y=>{g.has(y)||n.has(y)||b.push(y)}),$()}return se(d),ke(x),se(P),N(()=>o.group,()=>{P(),n.clear()}),N(()=>o.imageSize,$),N(()=>o.width,$),N(p,P),(A,g)=>(m(),w("div",xn,[a("div",wn,[R(B,{message:"main.recommand.close"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:g[0]||(g[0]=y=>l("close"))},g[2]||(g[2]=[a("span",{class:"bi bi-x-lg bb"},null,-1)]))]),_:1}),g[5]||(g[5]=a("div",{class:"b-left pe-1"},null,-1)),R(B,{message:"main.recommand.scroll"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:g[1]||(g[1]=y=>l("scroll",o.group.id))},g[3]||(g[3]=[a("span",{class:"bi bi-arrow-down-circle bb"},null,-1)]))]),_:1}),g[6]||(g[6]=a("div",{class:"b-left pe-1"},null,-1)),R(B,{message:"main.recommand.filter"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:r},[p.value?(m(),w("span",kn)):(m(),w("span",$n))])]),_:1}),g[7]||(g[7]=a("div",{class:"b-left pe-1"},null,-1)),R(B,{message:"main.recommand.reload"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:P},g[4]||(g[4]=[a("span",{class:"bi bi-arrow-clockwise bb"},null,-1)]))]),_:1}),g[8]||(g[8]=a("div",{class:"b-left pe-1"},null,-1)),R(B,{"icon-pos":"left",message:"main.recommand.tooltip",icon:!0},{default:T(()=>[a("span",Mn,L(A.$t("main.recommand.title")),1)]),_:1}),a("div",Sn,[R(_n,{action:"similar",onChanged:P})]),a("div",In,[a("div",Cn,[(m(!0),w(Z,null,J(i,(y,_)=>(m(),w(Z,null,[R(vs,{class:"",value:y},null,8,["value"]),_<i.length-1?(m(),w("div",Pn)):E("",!0)],64))),256))])])]),a("div",{style:te("margin-left:"+De+"px;")},[(m(!0),w(Z,null,J(h,y=>(m(),w("div",null,[a("div",zn,[(m(!0),w(Z,null,J(y,_=>(m(),U(dn,{pile:_,size:o.imageSize,onAccept:S,onRefuse:z,style:te("margin-right:"+De+"px;")},null,8,["pile","size","style"]))),256))])]))),256))],4)]))}}),En=j(Rn,[["__scopeId","data-v-fe023b30"]]),Tn={style:{display:"flex"}},An={class:"info"},Ln={__name:"LineChart",props:{chartData:{series:Array,xValues:Array,dataType:ee},height:String},setup(M){const t=M,e=V(0),s=V(!1),o={};Object.keys(t.chartData.series).forEach(p=>{o[p]=!1});const l=V({markers:{size:7},legend:{showForSingleSeries:!0,onItemClick:{toggleDataSeries:!1}},xaxis:{type:t.chartData.dataType===ee.date?"datetime":"numeric",categories:t.chartData.xValues},chart:{type:"area",stacked:!1,stackOnlyBar:!1,zoom:{type:"x",autoScaleYaxis:!0},animations:{animateGradually:{enabled:!1,delay:150}}},dataLabels:{enabled:!1},stroke:{curve:"straight"},tooltip:{intersect:!0,shared:!1,custom:function({series:p,seriesIndex:u,dataPointIndex:b,w:S}){const z=t.chartData.series[u].data[b];let $='<div style="display: grid; grid-template-columns: repeat(5, 1fr); grid-gap: 5px;">';z.images.forEach((P,r)=>{r<10&&($+=`<div style="width: 75px; height: 75px;"><img src="${P}" style="width: 100%; height: 100%;" /></div>`)}),$+="</div>";let C=`<span style="display: flex; align-items: center; justify-content: center;min-height:40px"><b>${t.chartData.series[u].name} — </b> ${z.y} Images</span>`;return C+=`<div>${$}</div>`,C}}}),v=()=>{l.value.chart.stacked=!l.value.chart.stacked,s.value=!s.value,e.value+=1},h=()=>{let p;l.value.chart.type==="area"?p={chart:{...l.value.chart,type:"bar"}}:p={chart:{...l.value.chart,type:"area"}},l.value={...l.value,...p},e.value+=1},c=(p,u,b)=>{const z=t.chartData.series[u];let $=Math.max(...z.data.map(C=>C.y));if(document.querySelectorAll(".apexcharts-custom-image").forEach(C=>C.remove()),o[u]){o[u]=!1;return}z.data.forEach((C,P)=>{const d=Math.floor(C.y/$*17),x=C.images.slice(0,d),O=`circle[index="${u}"][j="${P}"]`,A=document.querySelector(O),g=parseFloat(A.getAttribute("cx"));x.forEach((y,_)=>{const f=document.createElement("img");f.src=y,f.width=40,f.height=40,f.style.position="absolute";let k=g+40/1.5,F=65+_*40;f.style.left=`${k}px`,f.style.bottom=`${F}px`,f.classList.add("apexcharts-custom-image"),f.addEventListener("mouseover",G=>i(k,F,y)),f.addEventListener("mouseout",n),p.el.appendChild(f)})}),Object.keys(o).forEach(C=>o[C]=!1),o[u]=!0};function i(p,u,b){const S=document.getElementById("zoomed-image");S.style.left=`${p+120*1.5}px`,S.src=b,S.style.bottom=`${u}px`,S.style.display="block"}function n(){const p=document.getElementById("zoomed-image");p.style.display="none"}return(p,u)=>{const b=Ct("apexchart");return m(),w(Z,null,[a("div",Tn,[a("button",{class:"mt-2",onClick:h},L(l.value.chart.type==="area"?p.$t("main.graph-view.histo"):p.$t("main.graph-view.curve")),1),t.chartData.series.length>1?(m(),w("button",{key:0,class:"mt-2",style:{"margin-left":"1em"},onClick:v},L(s.value?p.$t("main.graph-view.over"):p.$t("main.graph-view.stack")),1)):E("",!0)]),(m(),U(b,{style:{position:"relative"},key:e.value,height:t.height,type:l.value.chart.type,options:l.value,series:t.chartData.series,onLegendClick:c},null,8,["height","type","options","series"])),a("i",An,L(p.$t("main.graph-view.info")),1),u[0]||(u[0]=a("img",{id:"zoomed-image",style:{display:"none",position:"absolute","z-index":"1000",width:"120px",height:"120px","pointer-events":"none"}},null,-1))],64)}}},On={key:1},Vn=H({__name:"GraphView",props:{collection:{},height:{}},emits:[],setup(M,{emit:t}){const e=X(),s=M,o=V(""),l=V(h());function v(){const c=new Set;let i=s.collection.groupManager.getGroupIterator();for(;i;){const n=i.group;if(n.id===0||n.meta.propertyValues&&n.meta.propertyValues[0].value==null){i=i.nextGroup();continue}for(let p of n.children)c.add(p.meta.propertyValues[0].value);n.children.forEach(()=>i=i.nextGroup()),i=i.nextGroup()}return c}function h(){const c={};let i,n=s.collection.groupManager.state.groupBy;if(n.length===0){o.value="Choose at least one date or numeric value to group the images by";return}const p=e.properties[n[0]],u=p.type;if(n.length>2){o.value="Only max two levels of grouping are supported";return}else if(n.length===1)c[p.name]={name:p.name,data:[]};else if(i=Array.from(v()),i.length>20){o.value="Too many curves to draw, select a subgrouping with less than 20 possible values";return}if(u!==ee.number&&u!==ee.date){o.value="First level of grouping needs to be a date or a numeric property";return}let b=s.collection.groupManager.getGroupIterator();const S=[];for(;b;){const z=b.group;if(z.id===0||z.meta.propertyValues&&z.meta.propertyValues[0].value==null){b=b.nextGroup();continue}let $=z.meta.propertyValues[0];const C=u===ee.date?new Date($.value).getTime():$.value;if(S.push(C),p.name in c)c[p.name].data.push({x:C,y:z.images.length,images:z.images.slice(0,20).map(P=>P.urlSmall)});else{const P=z.children.map(d=>d.meta.propertyValues[0].value),r=i.filter(d=>!P.includes(d));for(let d of z.children){const x=d.meta.propertyValues[0].value;if(c[x]===void 0){let O=x;x in e.tags&&(O=e.tags[x].value),c[x]={data:[],name:O}}c[d.meta.propertyValues[0].value].data.push({x:C,y:d.images.length,images:d.images.slice(0,20).map(O=>O.urlSmall)})}for(let d of r){if(c[d]===void 0){let x=d;d in e.tags&&(x=e.tags[d].value),c[d]={data:[],name:x}}c[d].data.push({x:C,y:0,images:[]})}z.children.forEach(()=>b=b.nextGroup())}b=b.nextGroup()}return o.value="",{series:Object.values(c),xValues:S,dataType:u}}return s.collection.groupManager.onResultChange.addListener(()=>l.value=h()),(c,i)=>(m(),w("div",{class:"",style:te({height:s.height+"px"})},[o.value===""?(m(),U(Ln,{key:0,chartData:l.value,height:s.height-50+"px"},null,8,["chartData","height"])):(m(),w("span",On,L(o.value),1))],4))}});class Fn{camera;domElement;spatialIndex;mode="pan";isDragging=!1;isLassoing=!1;prevPos={x:0,y:0};mouse=new Cs;animationId=null;lasso;minZoom=.01;maxZoom=20;zoomSpeed=.001;onUpdate=()=>{};constructor(t,e,s,o){this.camera=t,this.domElement=e,this.lasso=s,this.spatialIndex=o,this.init()}init(){this.domElement.addEventListener("wheel",this.handleWheel,{passive:!1}),this.domElement.addEventListener("mousedown",this.handleMouseDown),window.addEventListener("mousemove",this.handleMouseMove),window.addEventListener("mouseup",this.handleMouseUp)}handleMouseMove=t=>{const e=this.domElement.getBoundingClientRect();if(this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1,this.isLassoing){this.lasso.move(this.getMouseWorldPos(),{x:t.clientX,y:t.clientY}),this.onUpdate();return}if(this.isDragging&&this.mode==="pan"){const s=t.clientX-this.prevPos.x,o=t.clientY-this.prevPos.y,l=(this.camera.right-this.camera.left)/this.camera.zoom,v=(this.camera.top-this.camera.bottom)/this.camera.zoom;this.camera.position.x-=s*(l/e.width),this.camera.position.y+=o*(v/e.height),this.prevPos={x:t.clientX,y:t.clientY},this.onUpdate()}};getHoveredPoint(t){if(this.mode.startsWith("lasso"))return null;const e=this.getMouseWorldPos(),s=this.camera.zoom,{h:o,z1:l,z2:v}=t;let h=o;s>=l&&s<v?h=o*(l/s):s>=v&&(h=o*(l/v));const c=this.spatialIndex.getPointsInRect({minX:e.x-h,maxX:e.x+h,minY:e.y-h,maxY:e.y+h});c.sort((i,n)=>{const p=Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2),u=Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2);return p-u});for(const i of c){const n=i.ratio>1?1:i.ratio,p=i.ratio>1?1/i.ratio:1,u=n*h/2,b=p*h/2;if(e.x>=i.x-u&&e.x<=i.x+u&&e.y>=i.y-b&&e.y<=i.y+b)return i}return null}handleWheel=t=>{t.preventDefault();const e=this.getMouseWorldPos(),s=t.deltaY*-this.zoomSpeed*this.camera.zoom;this.camera.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.camera.zoom+s)),this.camera.updateProjectionMatrix();const o=this.getMouseWorldPos();this.camera.position.x+=e.x-o.x,this.camera.position.y+=e.y-o.y,this.onUpdate()};handleMouseDown=t=>{this.mode.startsWith("lasso")?(this.isLassoing=!0,this.lasso.start(this.getMouseWorldPos(),{x:t.clientX,y:t.clientY})):this.mode==="pan"&&(this.isDragging=!0,this.prevPos={x:t.clientX,y:t.clientY}),this.updateCursor(),this.onUpdate()};handleMouseUp=()=>{this.isLassoing&&(this.isLassoing=!1,this.lasso.end()),this.isDragging=!1,this.updateCursor(),this.onUpdate()};setMode(t){this.isLassoing&&this.lasso.clear(),this.isLassoing=!1,this.isDragging=!1,this.mode=t,this.updateCursor()}getMode(){return this.mode}updateCursor(){this.isLassoing||this.mode.startsWith("lasso")?this.domElement.style.cursor="crosshair":this.isDragging?this.domElement.style.cursor="grabbing":this.mode==="pan"?this.domElement.style.cursor="grab":this.domElement.style.cursor="default"}getMouseWorldPos(){const t=new Pe,e=(this.camera.right-this.camera.left)/this.camera.zoom,s=(this.camera.top-this.camera.bottom)/this.camera.zoom;return t.x=this.camera.position.x+this.mouse.x*e/2,t.y=this.camera.position.y+this.mouse.y*s/2,t}lookAtRect(t,e=500){console.log(t);const s=(t.minX+t.maxX)/2,o=(t.minY+t.maxY)/2,l=t.maxX-t.minX,v=t.maxY-t.minY,h=this.camera.right-this.camera.left,c=this.camera.top-this.camera.bottom,i=h/l,n=c/v,p=Math.max(this.minZoom,Math.min(this.maxZoom,Math.min(i,n)*.9)),u=new Pe(s,o,this.camera.position.z),b=this.camera.position.clone(),S=this.camera.zoom,z=performance.now();this.animationId&&cancelAnimationFrame(this.animationId);const $=C=>{const P=C-z,r=Math.min(P/e,1),d=1-Math.pow(1-r,3);this.camera.position.lerpVectors(b,u,d),this.camera.zoom=S+(p-S)*d,this.camera.updateProjectionMatrix(),this.onUpdate(),r<1?this.animationId=requestAnimationFrame($):this.animationId=null};this.animationId=requestAnimationFrame($)}dispose(){this.domElement.removeEventListener("wheel",this.handleWheel),this.domElement.removeEventListener("mousedown",this.handleMouseDown),window.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("mouseup",this.handleMouseUp)}}const gt=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],Be=1,xe=8;class lt{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[e,s]=new Uint8Array(t,0,2);if(e!==219)throw new Error("Data does not appear to be in a KDBush format.");const o=s>>4;if(o!==Be)throw new Error(`Got v${o} data when expected v${Be}.`);const l=gt[s&15];if(!l)throw new Error("Unrecognized array type.");const[v]=new Uint16Array(t,2,1),[h]=new Uint32Array(t,4,1);return new lt(h,v,l,t)}constructor(t,e=64,s=Float64Array,o){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=s,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const l=gt.indexOf(this.ArrayType),v=t*2*this.ArrayType.BYTES_PER_ELEMENT,h=t*this.IndexArrayType.BYTES_PER_ELEMENT,c=(8-h%8)%8;if(l<0)throw new Error(`Unexpected typed array class: ${s}.`);o&&o instanceof ArrayBuffer?(this.data=o,this.ids=new this.IndexArrayType(this.data,xe,t),this.coords=new this.ArrayType(this.data,xe+h+c,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(xe+v+h+c),this.ids=new this.IndexArrayType(this.data,xe,t),this.coords=new this.ArrayType(this.data,xe+h+c,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(Be<<4)+l]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=t,this.coords[this._pos++]=e,s}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return st(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,e,s,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:v,nodeSize:h}=this,c=[0,l.length-1,0],i=[];for(;c.length;){const n=c.pop()||0,p=c.pop()||0,u=c.pop()||0;if(p-u<=h){for(let $=u;$<=p;$++){const C=v[2*$],P=v[2*$+1];C>=t&&C<=s&&P>=e&&P<=o&&i.push(l[$])}continue}const b=u+p>>1,S=v[2*b],z=v[2*b+1];S>=t&&S<=s&&z>=e&&z<=o&&i.push(l[b]),(n===0?t<=S:e<=z)&&(c.push(u),c.push(b-1),c.push(1-n)),(n===0?s>=S:o>=z)&&(c.push(b+1),c.push(p),c.push(1-n))}return i}within(t,e,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:l,nodeSize:v}=this,h=[0,o.length-1,0],c=[],i=s*s;for(;h.length;){const n=h.pop()||0,p=h.pop()||0,u=h.pop()||0;if(p-u<=v){for(let $=u;$<=p;$++)yt(l[2*$],l[2*$+1],t,e)<=i&&c.push(o[$]);continue}const b=u+p>>1,S=l[2*b],z=l[2*b+1];yt(S,z,t,e)<=i&&c.push(o[b]),(n===0?t-s<=S:e-s<=z)&&(h.push(u),h.push(b-1),h.push(1-n)),(n===0?t+s>=S:e+s>=z)&&(h.push(b+1),h.push(p),h.push(1-n))}return c}}function st(M,t,e,s,o,l){if(o-s<=e)return;const v=s+o>>1;Yt(M,t,v,s,o,l),st(M,t,e,s,v-1,1-l),st(M,t,e,v+1,o,1-l)}function Yt(M,t,e,s,o,l){for(;o>s;){if(o-s>600){const i=o-s+1,n=e-s+1,p=Math.log(i),u=.5*Math.exp(2*p/3),b=.5*Math.sqrt(p*u*(i-u)/i)*(n-i/2<0?-1:1),S=Math.max(s,Math.floor(e-n*u/i+b)),z=Math.min(o,Math.floor(e+(i-n)*u/i+b));Yt(M,t,e,S,z,l)}const v=t[2*e+l];let h=s,c=o;for(we(M,t,s,e),t[2*o+l]>v&&we(M,t,s,o);h<c;){for(we(M,t,h,c),h++,c--;t[2*h+l]<v;)h++;for(;t[2*c+l]>v;)c--}t[2*s+l]===v?we(M,t,s,c):(c++,we(M,t,c,o)),c<=e&&(s=c+1),e<=c&&(o=c-1)}}function we(M,t,e,s){Ge(M,e,s),Ge(t,2*e,2*s),Ge(t,2*e+1,2*s+1)}function Ge(M,t,e){const s=M[t];M[t]=M[e],M[e]=s}function yt(M,t,e,s){const o=M-e,l=t-s;return o*o+l*l}class Un{tree=null;idToPointMap=new Map;initTree(t){this.idToPointMap.clear(),this.tree=new lt(t.length);for(const e of t){const s=this.tree.add(e.x,e.y);this.idToPointMap.set(s,e),e.id=s}this.tree.finish()}getPointsInRect(t){return this.tree?this.tree.range(t.minX,t.minY,t.maxX,t.maxY).map(s=>this.idToPointMap.get(s)):[]}getNearestPoint(t,e,s=1/0){if(!this.tree)return null;const o=this.tree.within(t,e,s);return o.length===0?null:this.idToPointMap.get(o[0])||null}clear(){this.tree=null,this.idToPointMap.clear()}}class Dn extends nt{_zoomRef={value:1};_zoomParams=new Pe(1,.1,.8);_ratio={value:1};_borderColor={value:new ze(0)};_borderWidth={value:0};_radius={value:.05};constructor(t){super(t),this.onBeforeCompile=e=>{e.uniforms.uZoom=this._zoomRef,e.uniforms.uZoomParams={value:this._zoomParams},e.uniforms.uRatio=this._ratio,e.uniforms.uBorderColor=this._borderColor,e.uniforms.uBorderWidth=this._borderWidth,e.uniforms.uRadius=this._radius,e.vertexShader=`
                varying vec2 vRawUv;
                uniform float uZoom;
                uniform vec3 uZoomParams;
                uniform float uRatio;
                ${e.vertexShader}
            `.replace("#include <begin_vertex>",`
                vec3 transformed = vec3( position );
                float h  = uZoomParams.x;
                float z1 = uZoomParams.y;
                float z2 = uZoomParams.z;

                float zoomScale = h;
                if(uZoom >= z1 && uZoom < z2) {
                    zoomScale = h * (z1 / uZoom);
                } else if(uZoom >= z2) {
                    zoomScale = h * (z1 / z2);
                }

                // Calculate vector scale to fit in 1.0 x 1.0 box while keeping aspect ratio
                vec2 sizeScale;
                if(uRatio > 1.0) {
                    // Landscape: Width fixed to 1.0, Height reduces
                    sizeScale = vec2(1.0, 1.0 / uRatio);
                } else {
                    // Portrait/Square: Height fixed to 1.0, Width reduces
                    sizeScale = vec2(uRatio, 1.0);
                }

                // Apply specific X and Y scaling
                transformed.xy *= sizeScale * zoomScale;
                `).replace("#include <uv_vertex>",`#include <uv_vertex>
                 vRawUv = uv;`),e.fragmentShader=`
                varying vec2 vRawUv;
                uniform float uBorderWidth;
                uniform float uRatio;
                uniform vec3 uBorderColor;
                uniform float uRadius;

                float sdRoundedBox(vec2 p, vec2 b, float r) {
                    vec2 q = abs(p) - b + r;
                    return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r;
                }

                ${e.fragmentShader}
            `.replace("#include <map_fragment>",`
                vec2 dimensions;
                if(uRatio > 1.0) {
                    dimensions = vec2(1.0, 1.0 / uRatio);
                } else {
                    dimensions = vec2(uRatio, 1.0);
                }
                
                vec2 p = (vRawUv - 0.5) * dimensions;
                vec2 b = dimensions * 0.5;
                
                float d = sdRoundedBox(p, b, uRadius);
                
                float edgeSoftness = 0.002;
                float outsideMask = smoothstep(edgeSoftness, 0.0, d);
                float borderMask = smoothstep(edgeSoftness, 0.0, d + uBorderWidth);

                vec4 texelColor = texture2D( map, vRawUv );
                texelColor.rgb *= diffuse;

                vec3 finalRGB = mix(uBorderColor, texelColor.rgb, borderMask);
                
                diffuseColor = vec4(finalRGB, texelColor.a * outsideMask);
                `),this.userData.shader=e}}setZoomReference(t){this._zoomRef=t}setZoomParams(t){this._zoomParams.set(t.h,t.z1,t.z2)}setRatio(t){this._ratio.value=t}setRadius(t){this._radius.value=t}setBorder(t,e){this._borderWidth.value=t,this._borderColor.value=new ze(e)}}const Bn=new Ht(1,1),Gn=new Dt,He=1.5,$e=1,bt=2,Hn=.2,Zn=.005;class Nn{group;scene;baseImgUrl;animationMap=new Map;textureCache=new Map;zoomRef={value:1};zoomParams={h:1,z1:.2,z2:.8};currentHoveredId=null;constructor(t,e){this.scene=t,this.baseImgUrl=e,this.group=new Ps,this.scene.add(this.group)}updatePositions(){this.animationMap.forEach(t=>{const e=t.point;t.mesh.position.set(e.x,e.y,He),t.mesh.scale.set(t.currentScale,t.currentScale,1)})}updateTints(){this.animationMap.forEach(t=>{t.mesh.material.color.set(t.point.tint||"#FFFFFF")})}updateBorder(){this.animationMap.forEach(t=>{const e=t.mesh.material;e.setBorder&&e.setBorder(t.point.border,t.point.borderColor)})}setZoomReference(t){this.zoomRef=t}show(t){t.sort((s,o)=>o.order-s.order);const e=new Set(t.map(s=>s.id));this.animationMap.forEach((s,o)=>{s.isInShowList=e.has(o)}),this.cleanupUnusedImages(),t.forEach(s=>{this.animationMap.has(s.id)?(this.animationMap.get(s.id).point=s,this.updateImagePosition(s)):this.createImage(s)}),this.setZoomParams(this.zoomParams),this.updateTints(),this.updateBorder()}cleanupUnusedImages(){this.animationMap.forEach((t,e)=>{const s=Math.abs(t.targetScale-t.currentScale)>Zn;!t.isInShowList&&!t.isHovered&&!s&&this.removeImage(e)})}getResolutionUrl(t){const e=this.zoomRef.value>7?"large":"medium";return`${this.baseImgUrl}${e}/${t}`}createImage(t){const e=this.getResolutionUrl(t.sha1);this.textureCache.has(e)?this.setupMesh(t,this.textureCache.get(e)):Gn.load(e,s=>{s.colorSpace=rt,this.textureCache.set(e,s),this.group.parent&&this.setupMesh(t,s)})}setupMesh(t,e){if(this.animationMap.has(t.id))return;const s=new Dn({map:e,transparent:!0,side:Bt});s.setZoomReference(this.zoomRef),s.setBorder(t.border,t.borderColor),s.setRatio(t.ratio);const o=new Gt(Bn,s);o.position.set(t.x,t.y,He),o.renderOrder=2e3+(t.order||0),o.scale.set(1,1,1),this.group.add(o);const l=this.currentHoveredId===t.id;this.animationMap.set(t.id,{mesh:o,point:t,currentScale:$e,targetScale:l?bt:$e,isHovered:l,isInShowList:!0}),l&&(o.renderOrder=Number.MAX_SAFE_INTEGER)}updateImagePosition(t){const e=this.animationMap.get(t.id);e&&e.mesh.position.set(t.x,t.y,He)}hover(t){this.currentHoveredId=t.id,this.animationMap.forEach((e,s)=>{s===t.id?(e.isHovered=!0,e.targetScale=bt,e.mesh.renderOrder=Number.MAX_SAFE_INTEGER):e.isHovered&&(e.isHovered=!1,e.targetScale=$e,e.mesh.renderOrder=2e3+(e.point.order||0))}),this.animationMap.has(t.id)||this.createImage(t)}unhover(){this.currentHoveredId=null,this.animationMap.forEach(t=>{t.isHovered&&(t.isHovered=!1,t.targetScale=$e,t.mesh.renderOrder=2e3+(t.point.order||0))})}updateAnimations(){let t=!1;this.animationMap.forEach(e=>{const s=e.targetScale-e.currentScale;Math.abs(s)>.001?(e.currentScale+=s*Hn,e.mesh.scale.set(e.currentScale,e.currentScale,1)):!e.isInShowList&&!e.isHovered&&(t=!0)}),t&&this.cleanupUnusedImages()}removeImage(t){const e=this.animationMap.get(t);e&&(this.group.remove(e.mesh),Array.isArray(e.mesh.material)?e.mesh.material.forEach(s=>s.dispose()):e.mesh.material.dispose(),this.animationMap.delete(t))}setZoomParams(t){this.zoomParams=t,this.animationMap.forEach(e=>{const s=e.mesh.material;s.setZoomParams&&s.setZoomParams(t)})}dispose(){Array.from(this.animationMap.keys()).forEach(e=>this.removeImage(e)),this.group.clear(),this.textureCache.forEach(e=>e.dispose()),this.textureCache.clear(),this.scene.remove(this.group)}}class Wn extends nt{_zoomRef={value:1};_zoomParams=new Pe(1,.1,.8);_radius={value:.05};_showAsPoint={value:0};constructor(t,e,s){super(t),this.onBeforeCompile=o=>{o.uniforms.uGridCols={value:e},o.uniforms.uGridRows={value:s},o.uniforms.uRadius=this._radius,o.uniforms.uZoom=this._zoomRef,o.uniforms.uZoomParams={value:this._zoomParams},o.uniforms.uShowAsPoint=this._showAsPoint,o.vertexShader=`
                attribute vec2 vOffset;
                attribute vec4 vUvTransform; 
                attribute vec4 vTint;
                attribute vec3 vBorderCol;
                attribute float vBorderWidth;
                attribute float vRatioAttr;

                varying vec2 vMappedUv;
                varying vec2 vRawUv; 
                varying vec4 vInstanceTint;
                varying vec3 vInstanceBorder;
                varying float vInstanceBorderWidth;
                varying float vRatio; 

                uniform float uGridCols;
                uniform float uGridRows;
                uniform float uZoom;
                uniform vec3 uZoomParams;
                uniform float uShowAsPoint;

                ${o.vertexShader}
            `.replace("#include <begin_vertex>",`
                vec3 transformed = vec3( position );
                float h  = uZoomParams.x;
                float z1 = uZoomParams.y;
                float z2 = uZoomParams.z;

                // Use the attribute directly
                vRatio = vRatioAttr; 

                // When showing as point, use uniform 1:1 scale
                if(uShowAsPoint > 0.5) {
                    // Point size is always h/uZoom for consistent sizing
                    float pointScale = h/10.0 / uZoom;
                    transformed.xy *= pointScale;
                } else {
                    // Normal image rendering with zoom scaling
                    float zoomScale = h;
                    if(uZoom >= z1 && uZoom < z2) {
                        zoomScale = h * (z1 / uZoom);
                    } else if(uZoom >= z2) {
                        zoomScale = h * (z1 / z2);
                    }

                    // FIT LOGIC: Calculate scale to fit in 1.0 x 1.0 box
                    vec2 sizeScale;
                    if(vRatio > 1.0) {
                        // Landscape: Width is 1.0, Height is 1/Ratio
                        sizeScale = vec2(1.0, 1.0 / vRatio);
                    } else {
                        // Portrait: Height is 1.0, Width is Ratio
                        sizeScale = vec2(vRatio, 1.0);
                    }
                    if(uZoom < z1/2.0) {
                        sizeScale = vec2(1.0, 1.0);
                    }

                    transformed.xy *= sizeScale * zoomScale;
                }
                `).replace("#include <uv_vertex>",`
                #include <uv_vertex>
                vRawUv = uv;
                
                float margin = 0.0005; 
                vec2 safeUv = mix(vec2(margin), vec2(1.0 - margin), uv);
                vec2 correctedUv = safeUv * vUvTransform.xy + vUvTransform.zw;
                vMappedUv = (correctedUv / vec2(uGridCols, uGridRows)) + vOffset;
                
                vInstanceTint = vTint;
                vInstanceBorder = vBorderCol;
                vInstanceBorderWidth = vBorderWidth;
                `),o.fragmentShader=`
                varying vec2 vMappedUv;
                varying vec2 vRawUv;
                varying vec4 vInstanceTint;
                varying vec3 vInstanceBorder;
                varying float vInstanceBorderWidth;
                varying float vRatio;

                uniform float uRadius;
                uniform float uShowAsPoint;

                float sdRoundedBox(vec2 p, vec2 b, float r) {
                    vec2 q = abs(p) - b + r;
                    return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r;
                }

                ${o.fragmentShader}
            `.replace("#include <map_fragment>",`
                // If showing as point, render a colored circle
                if(uShowAsPoint > 0.5) {
                    vec2 p = vRawUv - 0.5;
                    float dist = length(p);
                    float pointRadius = 0.3;
                    float aa = 0.05;
                    float pointMask = smoothstep(pointRadius + aa, pointRadius, dist);
                    
                    vec3 pointColor = vInstanceBorder * vInstanceTint.rgb;
                    diffuseColor = vec4(pointColor, pointMask);
                } else {
                    // Normal image rendering
                    vec2 dimensions;
                    if(vRatio > 1.0) {
                        dimensions = vec2(1.0, 1.0 / vRatio);
                    } else {
                        dimensions = vec2(vRatio, 1.0);
                    }
                    
                    vec2 p = (vRawUv - 0.5) * dimensions;
                    vec2 b = dimensions * 0.5;
                    
                    float d = sdRoundedBox(p, b, uRadius);
                    
                    float aa = 0.002; 
                    float outsideMask = smoothstep(aa, 0.0, d);
                    float borderMask = smoothstep(aa, 0.0, d + vInstanceBorderWidth);

                    vec4 texelColor = texture2D( map, vMappedUv );
                    
                    // Mix between original texture and tint color based on tint alpha
                    vec3 tintedColor = mix(texelColor.rgb, vInstanceTint.rgb, vInstanceTint.a);
                    vec3 tintedBorderColor = mix(vInstanceBorder.rgb, vInstanceTint.rgb, vInstanceTint.a);

                    vec3 finalRGB = mix(tintedBorderColor, tintedColor, borderMask);
                    diffuseColor = vec4(finalRGB, texelColor.a * outsideMask);
                }
                `),this.userData.shader=o}}setRadius(t){this._radius.value=t,this.userData.shader&&(this.userData.shader.uniforms.uRadius.value=t)}setZoomParams(t){this._zoomParams.set(t.h,t.z1,t.z2),this.userData.shader&&(this.userData.shader.uniforms.uZoomParams.value=this._zoomParams)}setZoomReference(t){this._zoomRef=t,this.userData.shader&&(this.userData.shader.uniforms.uZoom=t)}setShowAsPoint(t){this._showAsPoint.value=t?1:0,this.userData.shader&&(this.userData.shader.uniforms.uShowAsPoint.value=this._showAsPoint.value)}}class qn{mesh;geometry;material;points;atlas;matrixHelper=new zs;colorHelper=new ze;constructor(t,e,s,o){this.points=s,this.atlas=t;const l=t.width/t.cellWidth,v=t.height/t.cellHeight,h=s.length;this.geometry=new Ht(1,1),this.material=new Wn({map:e,transparent:!0,alphaTest:.1,depthTest:!0,depthWrite:!0},l,v),this.mesh=new Rs(this.geometry,this.material,h),this.geometry.setAttribute("vOffset",new ve(new Float32Array(h*2),2)),this.geometry.setAttribute("vUvTransform",new ve(new Float32Array(h*4),4)),this.geometry.setAttribute("vTint",new ve(new Float32Array(h*4),4)),this.geometry.setAttribute("vBorderCol",new ve(new Float32Array(h*3),3)),this.geometry.setAttribute("vBorderWidth",new ve(new Float32Array(h),1)),this.geometry.setAttribute("vRatioAttr",new ve(new Float32Array(h),1)),this.updateUVsAndOffsets(),this.updatePositions(),this.updateRatios(),this.updateTints(),this.updateBorderColors(),this.updateBorderWidths(),this.mesh.frustumCulled=!1,this.mesh.matrixAutoUpdate=!1,this.mesh.updateMatrixWorld(!0)}updatePositions(){this.points.forEach((t,e)=>{this.matrixHelper.makeScale(1,1,1),this.matrixHelper.setPosition(t.x,t.y,t.z),this.mesh.setMatrixAt(e,this.matrixHelper)}),this.mesh.instanceMatrix.needsUpdate=!0}updateRatios(){const t=this.geometry.getAttribute("vRatioAttr"),e=t.array;this.points.forEach((s,o)=>{e[o]=s.ratio}),t.needsUpdate=!0}updateTints(){const t=this.geometry.getAttribute("vTint"),e=t.array;this.points.forEach((s,o)=>{this.colorHelper.set(s.tint||"#FFFFFF"),e[o*4]=this.colorHelper.r,e[o*4+1]=this.colorHelper.g,e[o*4+2]=this.colorHelper.b,e[o*4+3]=s.tintAlpha??0}),t.needsUpdate=!0}updateBorderColors(){const t=this.geometry.getAttribute("vBorderCol"),e=t.array;this.points.forEach((s,o)=>{this.colorHelper.set(s.borderColor||"#000000"),e[o*3]=this.colorHelper.r,e[o*3+1]=this.colorHelper.g,e[o*3+2]=this.colorHelper.b}),t.needsUpdate=!0}updateBorderWidths(){const t=this.geometry.getAttribute("vBorderWidth"),e=t.array;this.points.forEach((s,o)=>{e[o]=s.border??0}),t.needsUpdate=!0}updateUVsAndOffsets(){const t=this.atlas.width/this.atlas.cellWidth,e=this.atlas.height/this.atlas.cellHeight,s=this.atlas.cellWidth/this.atlas.cellHeight,o=.5,l=o/this.atlas.width*t,v=o/this.atlas.height*e,h=this.geometry.getAttribute("vOffset"),c=this.geometry.getAttribute("vUvTransform"),i=h.array,n=c.array;this.points.forEach((p,u)=>{const b=this.atlas.sha1Mapping[p.sha1];if(b){const C=b[1];i[u*2]=C%t/t,i[u*2+1]=(e-1-Math.floor(C/t))/e}const S=p.ratio;let z=1,$=1;S>s?$=s/S:z=S/s,n[u*4]=z-l*2,n[u*4+1]=$-v*2,n[u*4+2]=(1-z)*.5+l,n[u*4+3]=(1-$)*.5+v}),h.needsUpdate=!0,c.needsUpdate=!0}setZoomReference(t){this.material.setZoomReference(t)}setZoomParams(t){this.material.setZoomParams(t)}setShowAsPoint(t){this.material.setShowAsPoint(t)}dispose(){this.geometry.dispose(),this.material.dispose(),this.mesh.dispose()}}class Yn{scene;layers=[];_isVisible=!0;_zoomParams;constructor(t){this.scene=t}async loadLayers(t,e,s,o){this.dispose();const l=new Dt,v=Array.from({length:t.atlasNb},()=>[]);for(let c of e){if(!t.sha1Mapping[c.sha1])continue;let i=t.sha1Mapping[c.sha1][0];v[i].push(c)}let h=Math.max(...v.map(c=>c.length));for(let c=0;c<t.atlasNb;c++){const i=v[c];if(i.length===0)continue;const n=`${s}atlas_sheet/${t.id}/${c}`;i.forEach((p,u)=>p.order=c*h+u);try{const p=await l.loadAsync(n);p.colorSpace=rt,p.generateMipmaps=!0,p.minFilter=Es;const u=new qn(t,p,i,c);u.setZoomReference(o),u.mesh.visible=this._isVisible,u.setZoomParams(this._zoomParams),this.layers.push(u),this.scene.add(u.mesh)}catch(p){console.error(`Failed to load atlas sheet ${c}:`,p)}}}show(){this._isVisible=!0,this.layers.forEach(t=>t.mesh.visible=!0)}hide(){this._isVisible=!1,this.layers.forEach(t=>t.mesh.visible=!1)}dispose(){this.layers.forEach(t=>{this.scene.remove(t.mesh),t.dispose()}),this.layers=[]}setZoomParams(t){this._zoomParams=t,this.layers.forEach(e=>e.setZoomParams(t))}updateTints(){this.layers.forEach(t=>t.updateTints())}updateBorderColors(){this.layers.forEach(t=>t.updateBorderColors())}updatePositions(){this.layers.forEach(t=>t.updatePositions())}updateBorderWidths(){this.layers.forEach(t=>t.updateBorderWidths())}setShowAsPoint(t){this.layers.forEach(e=>e.setShowAsPoint(t))}}var Ze,_t;function Xn(){if(_t)return Ze;_t=1,Ze=o;function M(l,v){var h=l.x-v.x,c=l.y-v.y;return h*h+c*c}function t(l,v,h){var c=v.x,i=v.y,n=h.x-c,p=h.y-i,u;return(n!==0||p!==0)&&(u=((l.x-c)*n+(l.y-i)*p)/(n*n+p*p),u>1?(c=h.x,i=h.y):u>0&&(c+=n*u,i+=p*u)),n=l.x-c,p=l.y-i,n*n+p*p}function e(l,v){var h,c=l.length,i,n=l[0],p=[n];for(h=1;h<c;h++)i=l[h],M(i,n)>v&&(p.push(i),n=i);return n!==i&&p.push(i),p}function s(l,v){var h=l.length,c=typeof Uint8Array<"u"?Uint8Array:Array,i=new c(h),n=0,p=h-1,u,b,S,z,$=[],C=[],P=[];for(i[n]=i[p]=1;p;){for(b=0,u=n+1;u<p;u++)S=t(l[u],l[n],l[p]),S>b&&(z=u,b=S);b>v&&(i[z]=1,$.push(n),C.push(z),$.push(z),C.push(p)),n=$.pop(),p=C.pop()}for(u=0;u<h;u++)i[u]&&P.push(l[u]);return P}function o(l,v,h){var c=v!==void 0?v*v:1;return h||(l=e(l,c)),l=s(l,c),l}return Ze}var jn=Xn();const Kn=Ft(jn);var Ne={exports:{}},We,xt;function Xt(){if(xt)return We;xt=1,We=t;var M=+(Math.pow(2,27)+1);function t(e,s,o){var l=e*s,v=M*e,h=v-e,c=v-h,i=e-c,n=M*s,p=n-s,u=n-p,b=s-u,S=l-c*u,z=S-i*u,$=z-c*b,C=i*b-$;return o?(o[0]=C,o[1]=l,o):[C,l]}return We}var qe,wt;function Qn(){if(wt)return qe;wt=1,qe=t;function M(e,s){var o=e+s,l=o-e,v=o-l,h=s-l,c=e-v,i=c+h;return i?[i,o]:[o]}function t(e,s){var o=e.length|0,l=s.length|0;if(o===1&&l===1)return M(e[0],s[0]);var v=o+l,h=new Array(v),c=0,i=0,n=0,p=Math.abs,u=e[i],b=p(u),S=s[n],z=p(S),$,C;b<z?(C=u,i+=1,i<o&&(u=e[i],b=p(u))):(C=S,n+=1,n<l&&(S=s[n],z=p(S))),i<o&&b<z||n>=l?($=u,i+=1,i<o&&(u=e[i],b=p(u))):($=S,n+=1,n<l&&(S=s[n],z=p(S)));for(var P=$+C,r=P-$,d=C-r,x=d,O=P,A,g,y,_,f;i<o&&n<l;)b<z?($=u,i+=1,i<o&&(u=e[i],b=p(u))):($=S,n+=1,n<l&&(S=s[n],z=p(S))),C=x,P=$+C,r=P-$,d=C-r,d&&(h[c++]=d),A=O+P,g=A-O,y=A-g,_=P-g,f=O-y,x=f+_,O=A;for(;i<o;)$=u,C=x,P=$+C,r=P-$,d=C-r,d&&(h[c++]=d),A=O+P,g=A-O,y=A-g,_=P-g,f=O-y,x=f+_,O=A,i+=1,i<o&&(u=e[i]);for(;n<l;)$=S,C=x,P=$+C,r=P-$,d=C-r,d&&(h[c++]=d),A=O+P,g=A-O,y=A-g,_=P-g,f=O-y,x=f+_,O=A,n+=1,n<l&&(S=s[n]);return x&&(h[c++]=x),O&&(h[c++]=O),c||(h[c++]=0),h.length=c,h}return qe}var Ye,kt;function Jn(){if(kt)return Ye;kt=1,Ye=M;function M(t,e,s){var o=t+e,l=o-t,v=o-l,h=e-l,c=t-v;return s?(s[0]=c+h,s[1]=o,s):[c+h,o]}return Ye}var Xe,$t;function er(){if($t)return Xe;$t=1;var M=Xt(),t=Jn();Xe=e;function e(s,o){var l=s.length;if(l===1){var v=M(s[0],o);return v[0]?v:[v[1]]}var h=new Array(2*l),c=[.1,.1],i=[.1,.1],n=0;M(s[0],o,c),c[0]&&(h[n++]=c[0]);for(var p=1;p<l;++p){M(s[p],o,i);var u=c[1];t(u,i[0],c),c[0]&&(h[n++]=c[0]);var b=i[1],S=c[1],z=b+S,$=z-b,C=S-$;c[1]=z,C&&(h[n++]=C)}return c[1]&&(h[n++]=c[1]),n===0&&(h[n++]=0),h.length=n,h}return Xe}var je,Mt;function tr(){if(Mt)return je;Mt=1,je=t;function M(e,s){var o=e+s,l=o-e,v=o-l,h=s-l,c=e-v,i=c+h;return i?[i,o]:[o]}function t(e,s){var o=e.length|0,l=s.length|0;if(o===1&&l===1)return M(e[0],-s[0]);var v=o+l,h=new Array(v),c=0,i=0,n=0,p=Math.abs,u=e[i],b=p(u),S=-s[n],z=p(S),$,C;b<z?(C=u,i+=1,i<o&&(u=e[i],b=p(u))):(C=S,n+=1,n<l&&(S=-s[n],z=p(S))),i<o&&b<z||n>=l?($=u,i+=1,i<o&&(u=e[i],b=p(u))):($=S,n+=1,n<l&&(S=-s[n],z=p(S)));for(var P=$+C,r=P-$,d=C-r,x=d,O=P,A,g,y,_,f;i<o&&n<l;)b<z?($=u,i+=1,i<o&&(u=e[i],b=p(u))):($=S,n+=1,n<l&&(S=-s[n],z=p(S))),C=x,P=$+C,r=P-$,d=C-r,d&&(h[c++]=d),A=O+P,g=A-O,y=A-g,_=P-g,f=O-y,x=f+_,O=A;for(;i<o;)$=u,C=x,P=$+C,r=P-$,d=C-r,d&&(h[c++]=d),A=O+P,g=A-O,y=A-g,_=P-g,f=O-y,x=f+_,O=A,i+=1,i<o&&(u=e[i]);for(;n<l;)$=S,C=x,P=$+C,r=P-$,d=C-r,d&&(h[c++]=d),A=O+P,g=A-O,y=A-g,_=P-g,f=O-y,x=f+_,O=A,n+=1,n<l&&(S=-s[n]);return x&&(h[c++]=x),O&&(h[c++]=O),c||(h[c++]=0),h.length=c,h}return je}var St;function sr(){return St||(St=1,function(M){var t=Xt(),e=Qn(),s=er(),o=tr(),l=5,v=11102230246251565e-32,h=(3+16*v)*v,c=(7+56*v)*v;function i(r,d,x,O){return function(g,y,_){var f=r(r(d(y[1],_[0]),d(-_[1],y[0])),r(d(g[1],y[0]),d(-y[1],g[0]))),k=r(d(g[1],_[0]),d(-_[1],g[0])),F=O(f,k);return F[F.length-1]}}function n(r,d,x,O){return function(g,y,_,f){var k=r(r(x(r(d(_[1],f[0]),d(-f[1],_[0])),y[2]),r(x(r(d(y[1],f[0]),d(-f[1],y[0])),-_[2]),x(r(d(y[1],_[0]),d(-_[1],y[0])),f[2]))),r(x(r(d(y[1],f[0]),d(-f[1],y[0])),g[2]),r(x(r(d(g[1],f[0]),d(-f[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),f[2])))),F=r(r(x(r(d(_[1],f[0]),d(-f[1],_[0])),g[2]),r(x(r(d(g[1],f[0]),d(-f[1],g[0])),-_[2]),x(r(d(g[1],_[0]),d(-_[1],g[0])),f[2]))),r(x(r(d(y[1],_[0]),d(-_[1],y[0])),g[2]),r(x(r(d(g[1],_[0]),d(-_[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),_[2])))),G=O(k,F);return G[G.length-1]}}function p(r,d,x,O){return function(g,y,_,f,k){var F=r(r(r(x(r(x(r(d(f[1],k[0]),d(-k[1],f[0])),_[2]),r(x(r(d(_[1],k[0]),d(-k[1],_[0])),-f[2]),x(r(d(_[1],f[0]),d(-f[1],_[0])),k[2]))),y[3]),r(x(r(x(r(d(f[1],k[0]),d(-k[1],f[0])),y[2]),r(x(r(d(y[1],k[0]),d(-k[1],y[0])),-f[2]),x(r(d(y[1],f[0]),d(-f[1],y[0])),k[2]))),-_[3]),x(r(x(r(d(_[1],k[0]),d(-k[1],_[0])),y[2]),r(x(r(d(y[1],k[0]),d(-k[1],y[0])),-_[2]),x(r(d(y[1],_[0]),d(-_[1],y[0])),k[2]))),f[3]))),r(x(r(x(r(d(_[1],f[0]),d(-f[1],_[0])),y[2]),r(x(r(d(y[1],f[0]),d(-f[1],y[0])),-_[2]),x(r(d(y[1],_[0]),d(-_[1],y[0])),f[2]))),-k[3]),r(x(r(x(r(d(f[1],k[0]),d(-k[1],f[0])),y[2]),r(x(r(d(y[1],k[0]),d(-k[1],y[0])),-f[2]),x(r(d(y[1],f[0]),d(-f[1],y[0])),k[2]))),g[3]),x(r(x(r(d(f[1],k[0]),d(-k[1],f[0])),g[2]),r(x(r(d(g[1],k[0]),d(-k[1],g[0])),-f[2]),x(r(d(g[1],f[0]),d(-f[1],g[0])),k[2]))),-y[3])))),r(r(x(r(x(r(d(y[1],k[0]),d(-k[1],y[0])),g[2]),r(x(r(d(g[1],k[0]),d(-k[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),k[2]))),f[3]),r(x(r(x(r(d(y[1],f[0]),d(-f[1],y[0])),g[2]),r(x(r(d(g[1],f[0]),d(-f[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),f[2]))),-k[3]),x(r(x(r(d(_[1],f[0]),d(-f[1],_[0])),y[2]),r(x(r(d(y[1],f[0]),d(-f[1],y[0])),-_[2]),x(r(d(y[1],_[0]),d(-_[1],y[0])),f[2]))),g[3]))),r(x(r(x(r(d(_[1],f[0]),d(-f[1],_[0])),g[2]),r(x(r(d(g[1],f[0]),d(-f[1],g[0])),-_[2]),x(r(d(g[1],_[0]),d(-_[1],g[0])),f[2]))),-y[3]),r(x(r(x(r(d(y[1],f[0]),d(-f[1],y[0])),g[2]),r(x(r(d(g[1],f[0]),d(-f[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),f[2]))),_[3]),x(r(x(r(d(y[1],_[0]),d(-_[1],y[0])),g[2]),r(x(r(d(g[1],_[0]),d(-_[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),_[2]))),-f[3]))))),G=r(r(r(x(r(x(r(d(f[1],k[0]),d(-k[1],f[0])),_[2]),r(x(r(d(_[1],k[0]),d(-k[1],_[0])),-f[2]),x(r(d(_[1],f[0]),d(-f[1],_[0])),k[2]))),g[3]),x(r(x(r(d(f[1],k[0]),d(-k[1],f[0])),g[2]),r(x(r(d(g[1],k[0]),d(-k[1],g[0])),-f[2]),x(r(d(g[1],f[0]),d(-f[1],g[0])),k[2]))),-_[3])),r(x(r(x(r(d(_[1],k[0]),d(-k[1],_[0])),g[2]),r(x(r(d(g[1],k[0]),d(-k[1],g[0])),-_[2]),x(r(d(g[1],_[0]),d(-_[1],g[0])),k[2]))),f[3]),x(r(x(r(d(_[1],f[0]),d(-f[1],_[0])),g[2]),r(x(r(d(g[1],f[0]),d(-f[1],g[0])),-_[2]),x(r(d(g[1],_[0]),d(-_[1],g[0])),f[2]))),-k[3]))),r(r(x(r(x(r(d(_[1],k[0]),d(-k[1],_[0])),y[2]),r(x(r(d(y[1],k[0]),d(-k[1],y[0])),-_[2]),x(r(d(y[1],_[0]),d(-_[1],y[0])),k[2]))),g[3]),x(r(x(r(d(_[1],k[0]),d(-k[1],_[0])),g[2]),r(x(r(d(g[1],k[0]),d(-k[1],g[0])),-_[2]),x(r(d(g[1],_[0]),d(-_[1],g[0])),k[2]))),-y[3])),r(x(r(x(r(d(y[1],k[0]),d(-k[1],y[0])),g[2]),r(x(r(d(g[1],k[0]),d(-k[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),k[2]))),_[3]),x(r(x(r(d(y[1],_[0]),d(-_[1],y[0])),g[2]),r(x(r(d(g[1],_[0]),d(-_[1],g[0])),-y[2]),x(r(d(g[1],y[0]),d(-y[1],g[0])),_[2]))),-k[3])))),W=O(F,G);return W[W.length-1]}}function u(r){var d=r===3?i:r===4?n:p;return d(e,t,s,o)}var b=u(3),S=u(4),z=[function(){return 0},function(){return 0},function(d,x){return x[0]-d[0]},function(d,x,O){var A=(d[1]-O[1])*(x[0]-O[0]),g=(d[0]-O[0])*(x[1]-O[1]),y=A-g,_;if(A>0){if(g<=0)return y;_=A+g}else if(A<0){if(g>=0)return y;_=-(A+g)}else return y;var f=h*_;return y>=f||y<=-f?y:b(d,x,O)},function(d,x,O,A){var g=d[0]-A[0],y=x[0]-A[0],_=O[0]-A[0],f=d[1]-A[1],k=x[1]-A[1],F=O[1]-A[1],G=d[2]-A[2],W=x[2]-A[2],Q=O[2]-A[2],K=y*F,ne=_*k,oe=_*f,de=g*F,_e=g*k,ut=y*f,Oe=G*(K-ne)+W*(oe-de)+Q*(_e-ut),jt=(Math.abs(K)+Math.abs(ne))*Math.abs(G)+(Math.abs(oe)+Math.abs(de))*Math.abs(W)+(Math.abs(_e)+Math.abs(ut))*Math.abs(Q),dt=c*jt;return Oe>dt||-Oe>dt?Oe:S(d,x,O,A)}];function $(r){var d=z[r.length];return d||(d=z[r.length]=u(r.length)),d.apply(void 0,r)}function C(r,d,x,O,A,g,y){return function(f,k,F,G,W){switch(arguments.length){case 0:case 1:return 0;case 2:return O(f,k);case 3:return A(f,k,F);case 4:return g(f,k,F,G);case 5:return y(f,k,F,G,W)}for(var Q=new Array(arguments.length),K=0;K<arguments.length;++K)Q[K]=arguments[K];return r(Q)}}function P(){for(;z.length<=l;)z.push(u(z.length));M.exports=C.apply(void 0,[$].concat(z));for(var r=0;r<=l;++r)M.exports[r]=z[r]}P()}(Ne)),Ne.exports}var Ke,It;function or(){if(It)return Ke;It=1,Ke=t;var M=sr();function t(e,s){for(var o=s[0],l=s[1],v=e.length,h=1,c=v,i=0,n=v-1;i<c;n=i++){var p=e[i],u=e[n],b=p[1],S=u[1];if(S<b){if(S<l&&l<b){var z=M(p,u,s);if(z===0)return 0;h^=0<z|0}else if(l===b){var $=e[(i+1)%v],C=$[1];if(b<C){var z=M(p,u,s);if(z===0)return 0;h^=0<z|0}}}else if(b<S){if(b<l&&l<S){var z=M(p,u,s);if(z===0)return 0;h^=z<0|0}else if(l===b){var $=e[(i+1)%v],C=$[1];if(C<b){var z=M(p,u,s);if(z===0)return 0;h^=z<0|0}}}else if(l===b){var P=Math.min(p[0],u[0]),r=Math.max(p[0],u[0]);if(i===0){for(;n>0;){var d=(n+v-1)%v,x=e[d];if(x[1]!==l)break;var O=x[0];P=Math.min(P,O),r=Math.max(r,O),n=d}if(n===0)return P<=o&&o<=r?0:1;c=n+1}for(var A=e[(n+v-1)%v][1];i+1<c;){var x=e[i+1];if(x[1]!==l)break;var O=x[0];P=Math.min(P,O),r=Math.max(r,O),i+=1}if(P<=o&&o<=r)return 0;var g=e[(i+1)%v][1];o<P&&A<l!=g<l&&(h^=1)}}return 2*h-1}return Ke}var ar=or();const ir=Ft(ar);class nr{scene;spatialIndex;onLassoComplete;lassoPoints=[];lastScreenPos=null;lassoMesh=null;lassoLine=null;clearTimeoutId=null;FILL_COLOR=43775;FILL_OPACITY=.3;STROKE_COLOR=30668;MIN_PIXEL_DIST_SQ=100;CURVE_TENSION=.5;SMOOTHNESS_MULTIPLIER=10;constructor(t,e,s){this.scene=t,this.spatialIndex=e,this.onLassoComplete=s}initMesh(){if(!this.lassoMesh){const t=new nt({color:this.FILL_COLOR,transparent:!0,opacity:this.FILL_OPACITY,side:Bt,depthTest:!1});this.lassoMesh=new Gt(new Fe,t),this.lassoMesh.renderOrder=999,this.scene.add(this.lassoMesh)}if(!this.lassoLine){const t=new Ts({color:this.STROKE_COLOR,depthTest:!1});this.lassoLine=new As(new Fe,t),this.lassoLine.renderOrder=999,this.scene.add(this.lassoLine)}}start(t,e){this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.initMesh(),this.lassoPoints=[t],this.lastScreenPos=e,this.lassoMesh&&(this.lassoMesh.visible=!0),this.lassoLine&&(this.lassoLine.visible=!0),this.updateGeometry()}move(t,e){if(this.lassoPoints.length===0||!this.lastScreenPos)return;const s=e.x-this.lastScreenPos.x,o=e.y-this.lastScreenPos.y;s*s+o*o<this.MIN_PIXEL_DIST_SQ||(this.lassoPoints.push(t),this.lastScreenPos=e,this.updateGeometry())}end(){if(this.lassoPoints.length<3){this.clear();return}const t=this.updateGeometry(!0);this.computeSelectedPoints(t),this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.clear()}updateGeometry(t=!1){if(!this.lassoMesh||!this.lassoLine||this.lassoPoints.length===0)return[];let e=[];if(this.lassoPoints.length>2){const o=new Ls(this.lassoPoints);o.closed=t,o.curveType="centripetal",o.tension=this.CURVE_TENSION;const l=this.lassoPoints.length*this.SMOOTHNESS_MULTIPLIER;e=o.getPoints(l)}else e=[...this.lassoPoints],t&&e.push(this.lassoPoints[0]);const s=new Os;if(e.length>0){s.moveTo(e[0].x,e[0].y);for(let o=1;o<e.length;o++)s.lineTo(e[o].x,e[o].y)}return this.lassoMesh.geometry.dispose(),this.lassoMesh.geometry=new Vs(s),this.lassoLine.geometry.dispose(),this.lassoLine.geometry=new Fe().setFromPoints(e),e}clear(){this.lassoMesh&&(this.lassoMesh.visible=!1,this.lassoMesh.geometry&&this.lassoMesh.geometry.dispose()),this.lassoLine&&(this.lassoLine.visible=!1,this.lassoLine.geometry&&this.lassoLine.geometry.dispose()),this.lassoPoints=[],this.lastScreenPos=null}computeSelectedPoints(t){const e=Kn(t,.1),s=gs(e),o=this.spatialIndex.getPointsInRect(s),l=e.map(h=>[h.x,h.y]),v=o.filter(h=>ir(l,[h.x,h.y])<=0);this.onLassoComplete(v)}dispose(){this.clearTimeoutId&&clearTimeout(this.clearTimeoutId),this.lassoMesh&&(this.scene.remove(this.lassoMesh),this.lassoMesh.geometry&&this.lassoMesh.geometry.dispose(),this.lassoMesh.material instanceof ft&&this.lassoMesh.material.dispose(),this.lassoMesh=null),this.lassoLine&&(this.scene.remove(this.lassoLine),this.lassoLine.geometry&&this.lassoLine.geometry.dispose(),this.lassoLine.material instanceof ft&&this.lassoLine.material.dispose(),this.lassoLine=null)}}class rr{container;scene;camera;renderer;controls;requestID=null;resizeObserver;frustumSize=20;zoomParams={h:5,z1:.1,z2:1.1};atlasLayers;hdLayer;lassoLayer;spatialIndex=new Un;globalUniforms={uZoom:{value:1}};onPointSelection=null;onHover=new ys;constructor(t,e){this.container=t,this.scene=new Fs,this.scene.background=new ze(16777215),this.initCamera(),this.initRenderer(),this.atlasLayers=new Yn(this.scene),this.atlasLayers.setZoomParams(this.zoomParams),this.hdLayer=new Nn(this.scene,e),this.hdLayer.setZoomReference(this.globalUniforms.uZoom),this.hdLayer.setZoomParams(this.zoomParams),this.lassoLayer=new nr(this.scene,this.spatialIndex,s=>{this.onPointSelection&&this.onPointSelection(s)}),this.controls=new Fn(this.camera,this.renderer.domElement,this.lassoLayer,this.spatialIndex),this.resizeObserver=new ResizeObserver(()=>this.onResize()),this.resizeObserver.observe(this.container),this.animate()}initCamera(){const t=this.container.clientWidth/this.container.clientHeight;this.camera=new Us(this.frustumSize*t/-2,this.frustumSize*t/2,this.frustumSize/2,this.frustumSize/-2,.1,1e3),this.camera.position.z=10,this.camera.zoom=.08,this.camera.updateProjectionMatrix(),this.globalUniforms.uZoom.value=this.camera.zoom}initRenderer(){this.renderer=new Ds({antialias:!0,alpha:!1,powerPreference:"high-performance"}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.outputColorSpace=rt,this.renderer.setClearColor(16777215,1),this.container.appendChild(this.renderer.domElement)}async createMap(t,e){const s=X();this.spatialIndex.initTree(e),await this.atlasLayers.loadLayers(t,e,s.baseUrl,this.globalUniforms.uZoom)}animate(){if(this.requestID=requestAnimationFrame(()=>this.animate()),this.globalUniforms.uZoom.value!==this.camera.zoom&&(this.globalUniforms.uZoom.value=this.camera.zoom),this.hdLayer){this.hdLayer.updateAnimations();const t=this.getCameraRect(),e=this.spatialIndex.getPointsInRect(t);e.length<50?this.hdLayer.show(e):this.hdLayer.show([])}this.updateHoverState(),this.renderer.render(this.scene,this.camera)}updateHoverState(){const t=this.controls.getHoveredPoint(this.zoomParams);(t?t.id:null)?(this.hdLayer.hover(t),this.onHover.emit(X().sha1Index[t.sha1][0].id)):(this.hdLayer.unhover(),this.onHover.emit())}setMouseMode(t){this.controls.setMode(t)}updateTints(){this.atlasLayers.updateTints(),this.hdLayer.updateTints()}updateBorder(){this.atlasLayers.updateBorderColors(),this.atlasLayers.updateBorderWidths(),this.hdLayer.updateBorder()}updatePosition(){this.atlasLayers.updatePositions()}setShowAsPoint(t){this.atlasLayers.setShowAsPoint(t)}setZoomParams(t,e){this.zoomParams.h=t/2,this.zoomParams.z2=this.zoomParams.z1+e*.2,this.hdLayer.setZoomParams(this.zoomParams),this.atlasLayers.setZoomParams(this.zoomParams)}onResize(){const t=this.container.clientWidth/this.container.clientHeight;this.camera.left=this.frustumSize*t/-2,this.camera.right=this.frustumSize*t/2,this.camera.top=this.frustumSize/2,this.camera.bottom=this.frustumSize/-2,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)}getImageMaxSize(){const t=this.camera.zoom,{h:e,z1:s,z2:o}=this.zoomParams;let l;return t>=s&&t<o?l=e*(s/t):t>=o?l=e*(s/o):l=e,l}getCameraRect(){const t=this.camera.zoom;return{minX:this.camera.left/t+this.camera.position.x,maxX:this.camera.right/t+this.camera.position.x,minY:this.camera.bottom/t+this.camera.position.y,maxY:this.camera.top/t+this.camera.position.y}}lookAtRect(t){let e=this.getImageMaxSize(),s=bs(t);s.minX-=e,s.minY-=e,s.maxX+=e,s.maxY+=e,this.controls.lookAtRect(s)}dispose(){this.requestID&&cancelAnimationFrame(this.requestID),this.resizeObserver.disconnect(),this.controls.dispose(),this.renderer.dispose(),this.atlasLayers.dispose(),this.hdLayer?.dispose(),this.scene.clear()}}function lr(M){const t=Ut(null),e=V(null),s=X();return se(()=>{if(!M.value){console.error("MapRenderer: Container ref is null on mount.");return}console.log("Initializing MapRenderer..."),t.value=new rr(M.value,s.baseImgUrl),t.value.onHover.addListener(o=>e.value=o),t.value.animate()}),ke(()=>{t.value&&(console.log("Disposing MapRenderer..."),t.value.dispose(),t.value=null)}),{map:t,hoverInstanceId:e}}const ur={key:0,class:"text-center",style:{position:"relative",top:"1px"}},dr={class:"image-container"},cr={key:0,class:"menu-section-card scrollable-section"},pr={class:"section-title"},hr={class:"badge"},vr={class:"groups-list"},mr=["onMouseover","onMouseleave","onClick"],fr={class:"group-name"},gr={class:"group-count"},yr=H({__name:"MapMenu",props:{selectedMap:{},colorOption:{},groups:{},images:{},hoverImageId:{}},emits:["update:selectedMap","update:spatialFunction","update:colorOption","clusters","hoverGroup","clickGroup"],setup(M,{emit:t}){const{t:e}=Ee(),s=X(),o=M,l=t,v=V(!1),h=D(()=>s.instances[o.hoverImageId]);function c(){v.value=!v.value}return(i,n)=>(m(),w("div",{class:Y(["map-menu",{collapsed:v.value}])},[a("div",{class:"toggle-header",onClick:c},[a("i",{class:Y(v.value?"bi bi-arrow-left-circle":"bi bi-arrow-right-circle")},null,2)]),v.value?E("",!0):(m(),w("div",ur,L(i.$t("map.main_menu")),1)),n[0]||(n[0]=a("div",{class:"mb-2"},null,-1)),a("div",dr,[h.value?(m(),U(Lt,{key:0,image:h.value,class:""},{default:T(()=>[R(Ot,{image:h.value,width:260,height:200,style:{"margin-left":"10px"}},null,8,["image"])]),_:1},8,["image"])):E("",!0)]),a("div",{class:Y(["menu-content mt-2",{hidden:v.value}])},[o.groups.length?(m(),w("div",cr,[a("div",pr,[a("span",null,L(o.colorOption=="property"?i.$t("map.group_property"):i.$t("map.group_cluster")),1),a("span",hr,L(o.groups.length),1)]),a("div",vr,[(m(!0),w(Z,null,J(o.groups,p=>(m(),w("div",{key:p.id,class:"group-item",onMouseover:u=>l("hoverGroup",{groupId:p.id,value:!0}),onMouseleave:u=>l("hoverGroup",{groupId:p.id,value:!1}),onClick:u=>l("clickGroup",p)},[a("div",{class:"group-color",style:te({backgroundColor:p.color})},null,4),a("span",fr,L(p.name),1),a("span",gr,L(p.count),1)],40,mr))),128))])])):E("",!0)],2)],2))}}),br=j(yr,[["__scopeId","data-v-84ae5b27"]]),_r="/icons/network2_white.svg",xr={class:"cont3"},wr=H({__name:"PointMapSelection",props:{modelValue:{}},emits:["update:modelValue"],setup(M,{emit:t}){const e=X(),s=M,o=t,l=V(null),v=V([]),h=V(s.modelValue);function c(){v.value=Vt(e.maps).map(i=>({value:i.id,label:i.id+": "+i.source+"."+i.name,icon:"geo"})),h.value&&!e.maps[h.value]&&(h.value=null),!h.value&&v.value.length&&(h.value=v.value[0].value),o("update:modelValue",h.value)}return N(()=>e.maps,()=>c()),N(h,i=>o("update:modelValue",i)),N(()=>s.modelValue,i=>h.value=i),se(()=>{c()}),q.ctrlF.on(()=>l.value?.focus()),(i,n)=>(m(),w("div",xr,[R(it,{options:v.value,modelValue:h.value,"onUpdate:modelValue":n[0]||(n[0]=p=>h.value=p),placeholder:i.$t("map.select_map"),"no-border":!0,teleport:!0},null,8,["options","modelValue","placeholder"])]))}}),kr=j(wr,[["__scopeId","data-v-76090b78"]]),$r={class:"glass-box2 d-flex align-items-center"},Mr={class:"toolbar-item px-1 d-flex align-items-center gap-1"},Sr={key:1,style:{"min-width":"150px"},class:"map-select"},Ir={class:"toolbar-item text-secondary"},Cr={class:"toolbar-item d-flex align-items-center gap-1"},Pr={style:{"min-width":"120px"}},zr={key:0,class:"toobar-item"},Rr=H({__name:"Toolbar",props:{mouseMode:{},imageSize:{},zoomDelay:{},showPoint:{type:Boolean},selectedMap:{},colorOption:{},hasMaps:{type:Boolean},images:{}},emits:["update:mouseMode","update:imageSize","update:zoomDelay","update:showPoint","update:selectedMap","update:colorOption","clusters","delete:map"],setup(M,{emit:t}){const{t:e}=Ee(),s=X(),o=M,l=t,v=D(()=>[{value:"property",label:e("map.color_prop"),icon:"stack"},{value:"cluster",label:e("map.color_cluster"),icon:"stack"}]);function h(p){l("update:mouseMode",p)}function c(){X().deleteMap(o.selectedMap)}function i(p){console.log(p),l("update:selectedMap",p.value.id)}const n=D(()=>Object.keys(ye().getMainTab().collection.groupManager.selectedImages.value).map(Number).map(p=>s.instances[p]));return(p,u)=>(m(),w("div",$r,[a("div",Mr,[o.hasMaps?(m(),w("div",{key:0,class:"tool sb",onClick:c},u[9]||(u[9]=[a("i",{class:"bi bi-trash",style:{opacity:"0.8"}},null,-1)]))):E("",!0),o.hasMaps?(m(),w("div",Sr,[R(kr,{"model-value":o.selectedMap,"onUpdate:modelValue":u[0]||(u[0]=b=>l("update:selectedMap",b))},null,8,["model-value"])])):E("",!0)]),a("div",Ir,[R(ht,{action:"map",class:"bb ps-1 pe-1",style:{"font-size":"14px"},"no-border":!0,onCall:i,images:n.value},{default:T(()=>[u[10]||(u[10]=a("i",{class:"bi bi-boxes"},null,-1)),ae(" "+L(p.$t("map.create")),1)]),_:1},8,["images"])]),u[16]||(u[16]=a("div",{class:"divider"},null,-1)),a("div",Cr,[a("div",Pr,[R(it,{teleport:!0,options:v.value,"model-value":o.colorOption,"onUpdate:modelValue":u[1]||(u[1]=b=>l("update:colorOption",b)),"no-border":!0},null,8,["options","model-value"])])]),o.colorOption==="cluster"?(m(),w("div",zr,[R(ht,{images:o.images,action:"group",class:"sb ps-1 pe-1",style:{"font-size":"14px"},"no-border":!0,onGroups:u[2]||(u[2]=b=>l("clusters",b))},{default:T(()=>u[11]||(u[11]=[a("img",{class:"cluster-icon",src:_r},null,-1)])),_:1},8,["images"])])):E("",!0),u[17]||(u[17]=a("div",{class:"divider"},null,-1)),a("div",{class:Y(["tool",{selected:o.showPoint}]),onClick:u[3]||(u[3]=b=>l("update:showPoint",!o.showPoint)),title:"Show Points"},u[12]||(u[12]=[a("i",{class:"bi bi-dot"},null,-1)]),2),a("div",{class:Y(["tool",{selected:o.mouseMode=="pan"}]),onClick:u[4]||(u[4]=b=>h("pan")),title:"Pan"},u[13]||(u[13]=[a("i",{class:"bi bi-hand-index-thumb"},null,-1)]),2),a("div",{class:Y(["tool",{selected:o.mouseMode=="lasso-plus"}]),onClick:u[5]||(u[5]=b=>h("lasso-plus")),title:"Lasso Add"},u[14]||(u[14]=[a("i",{class:"bi bi-plus-circle-dotted"},null,-1)]),2),a("div",{class:Y(["tool",{selected:o.mouseMode=="lasso-minus"}]),onClick:u[6]||(u[6]=b=>h("lasso-minus")),title:"Lasso Remove"},u[15]||(u[15]=[a("i",{class:"bi bi-dash-circle-dotted"},null,-1)]),2),u[18]||(u[18]=a("div",{class:"divider"},null,-1)),u[19]||(u[19]=a("div",{class:"tool-icon ms-1"},[a("i",{class:"bi bi-aspect-ratio"})],-1)),R(tt,{style:{width:"60px"},min:1,max:10,modelValue:o.imageSize,"onUpdate:modelValue":u[7]||(u[7]=b=>l("update:imageSize",b))},null,8,["modelValue"]),u[20]||(u[20]=a("div",{class:"tool-icon ms-1"},[a("i",{class:"bi bi-border"})],-1)),R(tt,{style:{width:"60px"},min:1,max:10,modelValue:o.zoomDelay,"onUpdate:modelValue":u[8]||(u[8]=b=>l("update:zoomDelay",b))},null,8,["modelValue"])]))}}),Er=j(Rr,[["__scopeId","data-v-405d4091"]]),Tr={class:"main-layout"},Ar={class:"toolbar-container"},Lr={class:"map-view-container"},Or=.05,Vr="#FFFFFF",Fr="#888888",Ur="#5DACFF",Me="#777777",Dr=H({__name:"MapView",props:{tab:{}},setup(M){const t=X(),e=M,s=V(null),{map:o,hoverInstanceId:l}=lr(s),v=V(5),h=V(2),c=V(!1),i=V("pan"),n=V(1e3),p=V(l.value),u=V([]);let b=[],S={},z={};const $=V({}),C=Ut([]);function P(_,f){let k=0,F=0,G=0,W=0,Q=!1;for(let K=0;K<_.length;K++){let ne=_[K],oe=S[ne.sha1];oe&&(Q?(k=Math.min(k,oe.x),F=Math.min(F,oe.y),G=Math.max(G,oe.x),W=Math.max(W,oe.y)):(k=oe.x,F=oe.y,G=oe.x,W=oe.y,Q=!0))}return{minX:k,minY:F,maxX:G,maxY:W,color:f}}function r(_,f=0){if(_.name)return _.name;if(_.meta.propertyValues?.length){const k=_.meta.propertyValues[0],F=t.properties[k.propertyId];return Ce(F.type)?t.tags[k.value]?.value??"undefined":F.name+": "+k.value}return"Group "+f}function d(){C.value.forEach(k=>{k.color=Me,k.borderColor=Me,k.border=0,k.tint=Vr,k.tintAlpha=0,k.z=1});const _=Object.keys($.value).length>0;for(let k of u.value){const F=$.value[k.id];for(let G of k.points)G.border=Or,G.borderColor=k.color,F?(G.tintAlpha=0,G.z=1.1):_?(G.tintAlpha=.7,G.tint=Fr,G.z=1):(G.tintAlpha=0,G.z=1)}const f=e.tab.collection.groupManager.selectedImages.value;Object.keys(f).map(Number).forEach(k=>{const F=S[t.instances[k].sha1];F&&(F.tint=Ur,F.tintAlpha=.5)}),o.value&&(o.value.updateBorder(),o.value.updateTints(),o.value.updatePosition())}function x(){let _=[];if(e.tab.state.mapOptions.groupOption==="property"?_=e.tab.collection.groupManager.result.root.children:_=b,!_.length&&u.value.length){u.value=[],d();return}const k=_.length,F=xs(k),G=[];z={},_.forEach((W,Q)=>{let K=F[Q];const ne=W.meta?.propertyValues?.[0]?.propertyId;if(ne){const de=t.properties[ne];if(Ce(de.type)){const _e=W.meta.propertyValues[0].value;_e!==void 0?K=ws[t.tags[_e].color].color:K=$s.color}}z[W.id]=W.images.map(de=>de.sha1);const oe=Array.from(new Set(W.images.map(de=>S[de.sha1]).filter(Boolean)));G.push({id:W.id,name:r(W,Q),count:W.images.length,color:K,box:P(W.images,K),points:oe})}),u.value=G,d()}async function O(_){if(!t.maps[_])return;t.maps[_].data||await t.loadMapData(_),S={};const f=[],k=t.maps[_].data;for(let F=0;F<k.length;F+=3){const G=k[F],W=k[F+1],Q=k[F+2],K=t.sha1Index[G]?.[0];if(!K)continue;const ne={id:K.id,x:W,y:Q,z:1,color:Me,sha1:G,ratio:K.containerRatio,order:1,border:0,tintAlpha:0,borderColor:Me};f.push(ne),S[G]=ne}if(C.value=f,x(),o.value){const F=await ks(0);o.value.createMap(F,C.value)}}function A(_){_.value?$.value[_.groupId]=!0:delete $.value[_.groupId],$.value={...$.value},d()}const g=_=>{let f=[];for(let k of _)t.sha1Index[k.sha1]&&f.push(...t.sha1Index[k.sha1].map(F=>F.id));i.value=="lasso-plus"&&e.tab.collection.groupManager.selectImages(f),i.value=="lasso-minus"&&e.tab.collection.groupManager.unselectImages(f)};async function y(_){await t.deleteMap(_)}return N(i,_=>{o.value?.setMouseMode(_)}),N(e.tab.collection.groupManager.selectedImages,()=>d()),N(()=>e.tab.state.mapOptions.selectedMap,_=>{_!=null&&O(_)}),N(()=>e.tab.state.mapOptions.groupOption,()=>x()),N(c,()=>o.value.setShowAsPoint(c.value)),N(v,()=>o.value.setZoomParams(v.value,h.value)),N(h,()=>o.value.setZoomParams(v.value,h.value)),N(l,()=>{l.value&&(p.value=l.value)}),N(o,_=>{_&&(_.onPointSelection=g,C.value.length>0&&_.atlasLayers&&d(),_.setZoomParams(v.value,h.value))}),se(async()=>{e.tab.collection.groupManager.onResultChange.addListener(x),await t.loadMaps(),O(e.tab.state.mapOptions.selectedMap),o.value&&o.value.setMouseMode(i.value)}),ke(()=>{e.tab.collection.groupManager.onResultChange.removeListener(x)}),(_,f)=>(m(),w("div",Tr,[a("div",Ar,[R(Er,{"mouse-mode":i.value,"onUpdate:mouseMode":f[0]||(f[0]=k=>i.value=k),"image-size":v.value,"onUpdate:imageSize":f[1]||(f[1]=k=>v.value=k),"zoom-delay":h.value,"onUpdate:zoomDelay":f[2]||(f[2]=k=>h.value=k),"show-point":c.value,"onUpdate:showPoint":f[3]||(f[3]=k=>c.value=k),"selected-map":e.tab.state.mapOptions.selectedMap,"onUpdate:selectedMap":f[4]||(f[4]=k=>e.tab.state.mapOptions.selectedMap=k),"color-option":e.tab.state.mapOptions.groupOption,"onUpdate:colorOption":f[5]||(f[5]=k=>{e.tab.state.mapOptions.groupOption=k,e.tab.saveState()}),"has-maps":I(t).hasMaps,images:_.tab.collection.groupManager.result.root.images,onClusters:f[6]||(f[6]=k=>{vt(b)?b.value=k:b=k,x()}),"onDelete:map":y},null,8,["mouse-mode","image-size","zoom-delay","show-point","selected-map","color-option","has-maps","images"])]),a("div",Lr,[R(_s,{onResize:f[7]||(f[7]=k=>n.value=k),class:"map-resizable-wrapper",disabled:!0},{default:T(()=>[a("div",{class:Y(["map-container",{"cursor-grab":i.value=="pan","cursor-lasso":i.value.startsWith("lasso")}])},[a("div",{ref_key:"canvasContainer",ref:s,class:"canvas-wrapper"},null,512)],2)]),_:1}),R(br,{"selected-map":e.tab.state.mapOptions.selectedMap,"onUpdate:selectedMap":f[8]||(f[8]=k=>e.tab.state.mapOptions.selectedMap=k),"color-option":e.tab.state.mapOptions.groupOption,"onUpdate:colorOption":f[9]||(f[9]=k=>e.tab.state.mapOptions.groupOption=k),"hover-image-id":p.value,groups:u.value,images:_.tab.collection.groupManager.result.root.images,onClusters:f[10]||(f[10]=k=>{vt(b)?b.value=k:b=k,x()}),onHoverGroup:A,onClickGroup:f[11]||(f[11]=k=>I(o)?.lookAtRect(k.box))},null,8,["selected-map","color-option","hover-image-id","groups","images"])])]))}}),Br=j(Dr,[["__scopeId","data-v-1e7400c7"]]),Gr={key:0,class:"m-0 p-0"},Hr={key:0},Zr=H({__name:"MainView",props:{tab:{},height:{},filterOpen:{type:Boolean}},setup(M,{expose:t}){ge();const e=X(),s=M;t({updateScrollerWidth:$});const o=V({}),l=V(!0),v=V(null),h=V(null),c=V(null),i=V(0),n=V(0),p=Ie({groups:!1}),u=D(()=>s.tab.getVisibleProperties());function b(){v.value&&h.value?i.value=s.height-v.value.clientHeight-h.value.clientHeight:v.value?i.value=s.height-v.value.clientHeight:i.value=0}function S(C){o.value=s.tab.collection.groupManager.result.index[C],re(()=>b())}function z(){o.value={},re(()=>b())}async function $(){await re(),n.value=v.value?.clientWidth??n.value}return se(()=>{n.value=v.value.clientWidth,window.addEventListener("resize",$)}),ke(()=>{window.removeEventListener("resize",$)}),N(()=>s.tab.state.imageSize,()=>re(b)),N(()=>s.filterOpen,()=>re(b)),N(()=>s.height,async()=>{await re(b)}),se(b),(C,P)=>(m(),w(Z,null,[a("div",{id:"main-content",ref_key:"filterElem",ref:v},[s.filterOpen?(m(),U(nn,{key:0,tab:s.tab,"compute-status":p},null,8,["tab","compute-status"])):E("",!0)],512),a("div",{ref_key:"boxElem",ref:h,class:"m-0 p-0"},[o.value.id?(m(),w("div",Gr,[R(En,{tab:s.tab,group:o.value,"image-size":s.tab.state.imageSize,width:n.value,height:50,onClose:z,onScroll:c.value.scrollTo,onUpdate:P[0]||(P[0]=r=>re(()=>b()))},null,8,["tab","group","image-size","width","onScroll"])])):E("",!0)],512),I(e).isLoaded&&n.value>0&&i.value>0&&l.value?(m(),w("div",Hr,[s.tab.state.display=="tree"?(m(),U(Ms,{key:0,"input-key":"main-view-tree","group-manager":s.tab.collection.groupManager,"image-size":s.tab.state.imageSize,height:i.value-0,properties:u.value,"hide-if-modal":!0,"selected-images":s.tab.collection.groupManager.selectedImages,ref_key:"imageList",ref:c,width:n.value-30,onRecommend:S,style:{"margin-left":"10px"}},null,8,["group-manager","image-size","height","properties","selected-images","width"])):E("",!0),s.tab.state.display=="grid"?(m(),w("div",{key:1,style:te([{width:n.value-12+"px"},{"margin-left":"10px"}]),class:"grid-container"},[R(Ss,{tab:C.tab,manager:s.tab.collection.groupManager,height:i.value-15,width:n.value-12,"selected-properties":u.value,class:"p-0 m-0","show-images":!0,"selected-images":s.tab.collection.groupManager.selectedImages,ref_key:"imageList",ref:c,"hide-if-modal":!0},null,8,["tab","manager","height","width","selected-properties","selected-images"])],4)):E("",!0),s.tab.state.display=="graph"?(m(),U(Vn,{key:2,collection:s.tab.collection,height:i.value-15,style:{"margin-left":"10px"}},null,8,["collection","height"])):E("",!0),s.tab.state.display=="map"?(m(),U(Br,{key:3,style:te({height:i.value-0+"px"}),tab:s.tab},null,8,["style","tab"])):E("",!0)])):E("",!0)],64))}}),Nr=j(Zr,[["__scopeId","data-v-6c218724"]]),Wr=H({__name:"TabButton",props:{tab:{}},setup(M){const t=ye(),e=V(""),s=V(null),o=V(!1),l=V(!1),v=M,h=D(()=>v.tab.state.id);function c(){t.selectMainTab(v.tab.state.id)}function i(){l.value=!0,e.value=v.tab.state.name,re(()=>s.value.focus())}function n(){v.tab.renameTab(e.value),l.value=!1}async function p(){confirm("Are you sure to delete Tab: "+v.tab.state.name)&&t.deleteTab(v.tab.state.id)}return se(()=>{v.tab.isNew&&i()}),(u,b)=>(m(),w("div",{class:"d-flex d-row me-2",onMouseenter:b[1]||(b[1]=S=>o.value=!0),onMouseleave:b[2]||(b[2]=S=>o.value=!1)},[l.value?(m(),w("div",{key:1,class:Y(["tab-button",h.value==I(t).mainTab?" active":""])},[a("form",{onSubmit:ce(n,["stop","prevent"])},[Te(a("input",{onFocusout:n,onKeydown:At(n,["escape"]),type:"text",class:"text-input","onUpdate:modelValue":b[0]||(b[0]=S=>e.value=S),ref_key:"inputElem",ref:s},null,544),[[Ae,e.value]])],32)],2)):(m(),w(Z,{key:0},[R(B,{message:"main.menu.rename_tab_tooltip"},{default:T(()=>[a("i",{onClick:i,class:Y(["bi bi-pencil me-1 tab-icon hover-light",o.value&&I(t).mainTab==h.value?"":"hidden"]),style:{"font-size":"10px"}},null,2)]),_:1}),a("div",{class:Y(["tab-button",h.value==I(t).mainTab?" active":""]),onClick:c},[a("span",null,L(v.tab.state.name),1)],2),R(B,{message:"main.menu.delete_tab_tooltip"},{default:T(()=>[a("i",{onClick:p,class:Y(["btn-icon bi bi-x tab-icon hover-light",o.value?"":"hidden"]),style:{"font-size":"15px"}},null,2)]),_:1})],64))],32))}}),qr={class:"d-flex d-row",style:{cursor:"pointer"}},Yr={class:"pt-1"},Xr={key:0,class:"bb bi bi-chevron-down"},jr={key:1,class:"bb bi bi-chevron-right"},Kr={style:{"padding-top":"2px","margin-right":"2px"}},Qr={class:"lang"},Jr=["value"],el=["value"],tl=H({__name:"TabNav",props:{reRender:{type:Function},filterOpen:{type:Boolean}},emits:["update:filterOpen"],setup(M,{emit:t}){const{locale:e}=Ee(),s=be(),o=ye(),l=M,v=t;async function h(p){await o.addTab("New Tab")}const c=["fr","en"];function i(){v("update:filterOpen",!l.filterOpen)}function n(p){l.reRender();const u=p.target.value;e.value=u,ge().setLang(u)}return(p,u)=>(m(),w("nav",null,[a("div",qr,[a("div",Yr,[a("span",{onClick:i},[l.filterOpen?(m(),w("i",Xr)):(m(),w("i",jr))])]),(m(!0),w(Z,null,J(I(o).loadedTabs,b=>(m(),w("div",null,[R(Wr,{tab:I(o).getTab(b)},null,8,["tab"])]))),256)),R(B,{message:"main.menu.add_tab_tooltip"},{default:T(()=>[a("button",{class:"tab-icon hover-light ps-1 pe-1",onClick:h,id:"add-tab-button"},u[2]||(u[2]=[a("span",{class:"bi bi-plus"},null,-1)]))]),_:1}),u[5]||(u[5]=a("div",{class:"flex-grow-1"},null,-1)),I(s).clientState.user?(m(),w("div",{key:0,style:{margin:"2px"},class:"bb me-3 text-secondary",onClick:u[0]||(u[0]=b=>I(Is)().disconnectUser())},L(I(s).clientState.user.name),1)):E("",!0),a("div",Kr,[R(B,{message:"modals.notif.icon"},{default:T(()=>[a("span",{class:"bb",onClick:u[1]||(u[1]=b=>I(s).showModal(I(le).NOTIF))},u[3]||(u[3]=[a("i",{class:"bi bi-bell"},null,-1)]))]),_:1})]),a("div",Qr,[u[4]||(u[4]=a("i",{class:"bi bi-translate",style:{"margin-right":"0.5rem"}},null,-1)),a("select",{value:p.$i18n.locale,onChange:n},[(m(),w(Z,null,J(c,(b,S)=>a("option",{key:`Lang${S}`,value:b},L(b.toUpperCase()),9,el)),64))],40,Jr)])])]))}}),sl={key:0},ol={key:0,class:"spinner-border spinner-border-sm text-primary",style:{position:"relative",top:"1px"},strole:"status"},fe=H({__name:"LoadWheel",props:{loading:{type:Boolean}},setup(M){const t=M;return(e,s)=>t.loading?(m(),w("div",sl,[e.loading?(m(),w("div",ol,s[0]||(s[0]=[a("span",{class:"visually-hidden"},"Loading...",-1)]))):E("",!0)])):E("",!0)}}),Qe=H({__name:"Percentage",props:{current:{},max:{},force:{type:Boolean}},setup(M){const t=M,e=D(()=>t.force?"100%":t.max==0?"0%":t.current>=t.max?"100%":Math.floor(t.current/t.max*100)+"%");return(s,o)=>(m(),w("span",null,L(e.value),1))}}),al={key:0,class:"center"},il={class:"text-start",style:{display:"inline-block",width:"200px",height:"300px"}},nl={class:"d-flex text-secondary"},rl={key:0,style:{"font-size":"14px"},class:"bi bi-check text-success"},ll={class:"d-flex text-secondary",style:{"font-size":"14px"}},ul={key:0,class:"bi bi-check text-success"},dl={class:"d-flex text-secondary",style:{"font-size":"14px"}},cl={key:0,class:"bi bi-check text-success"},pl={class:"d-flex text-secondary",style:{"font-size":"14px"}},hl={key:0,class:"bi bi-check text-success"},vl={class:"d-flex text-secondary",style:{"font-size":"14px"}},ml={key:0,class:"bi bi-check text-success"},fl={class:"d-flex text-secondary",style:{"font-size":"14px"}},gl={key:0,class:"bi bi-check text-success"},yl=H({__name:"DataLoad",setup(M){const t=X();return(e,s)=>I(t).loadState?(m(),w("div",al,[a("div",il,[a("div",null,[a("div",nl,[s[0]||(s[0]=a("div",{class:"me-1",style:{"font-size":"14px"}},"Properties",-1)),R(fe,{class:"me-2",loading:!I(t).loadState.finishedProperty},null,8,["loading"]),I(t).loadState.finishedProperty?(m(),w("i",rl)):E("",!0)]),a("div",ll,[s[1]||(s[1]=a("div",{class:"me-1"},"PropertyGroups",-1)),R(fe,{class:"me-2",loading:!I(t).loadState.finishedPropertyGroups},null,8,["loading"]),I(t).loadState.finishedPropertyGroups?(m(),w("i",ul)):E("",!0)]),a("div",dl,[s[2]||(s[2]=a("div",{class:"me-1"},"Tags",-1)),R(fe,{class:"me-2",loading:!I(t).loadState.finishedTags},null,8,["loading"]),I(t).loadState.finishedTags?(m(),w("i",cl)):E("",!0)]),a("div",pl,[s[3]||(s[3]=a("div",{class:"me-1"},"Instances",-1)),R(fe,{class:"me-2",loading:!I(t).loadState.finishedInstance},null,8,["loading"]),I(t).loadState.finishedInstance?(m(),w("i",hl)):E("",!0),R(Qe,{current:I(t).loadState.counterInstance,max:I(t).loadState.maxInstance,force:I(t).loadState.finishedInstance},null,8,["current","max","force"])]),a("div",vl,[s[4]||(s[4]=a("div",{class:"me-1"},"InstanceValues",-1)),R(fe,{class:"me-2",loading:!I(t).loadState.finishedInstanceValues},null,8,["loading"]),I(t).loadState.finishedInstanceValues?(m(),w("i",ml)):E("",!0),R(Qe,{current:I(t).loadState.counterInstanceValue,max:I(t).loadState.maxInstanceValue,force:I(t).loadState.finishedInstanceValues},null,8,["current","max","force"])]),a("div",fl,[s[5]||(s[5]=a("div",{class:"me-1"},"ImageValues",-1)),R(fe,{class:"me-2",loading:!I(t).loadState.finishedImageValues},null,8,["loading"]),I(t).loadState.finishedImageValues?(m(),w("i",gl)):E("",!0),R(Qe,{current:I(t).loadState.counterImageValue,max:I(t).loadState.maxImageValue,force:I(t).loadState.finishedImageValues},null,8,["current","max","force"])])])])])):E("",!0)}}),bl=j(yl,[["__scopeId","data-v-0db6d675"]]),_l={key:0},xl={id:"panoptic"},wl={class:"d-flex flex-row m-0 p-0 overflow-hidden"},kl={class:"w-100"},$l={key:0,class:"custom-hr"},Ml={key:2,class:"loading"},Sl={class:"text-center"},Il={key:3,class:"loading"},Cl=H({__name:"ProjectView",setup(M){const t=ge(),e=X(),s=be(),o=ye(),l=V(null),v=V(null),h=V(window.innerHeight),c=V(!1),i=V(!0),n=V(!0),p=D(()=>h.value-(v.value?.clientHeight??0)),u=D(()=>l.value?.filteredImages.map(r=>r.id));let b=navigator.userAgent.indexOf("Mac OS X")!==-1;async function S(){i.value=!1,await re(),i.value=!0}se(async()=>{if(!s.isProjectLoaded){mt.push("/");return}t.init(),re(()=>{window.addEventListener("resize",z),z()}),window.addEventListener("keydown",r=>{r.key=="Meta"&&(q.cmd=!0),r.key=="Control"&&(q.ctrl=!0),r.key=="Alt"&&(b&&(q.ctrl=!0),q.alt=!0),r.key=="Shift"&&(q.shift=!0),r.key=="ArrowLeft"&&(q.left=!0),r.key=="ArrowRight"&&(q.right=!0),r.key=="Z"&&q.ctrl&&e.redo(),r.key=="z"&&q.ctrl&&e.undo(),r.key=="f"&&(q.ctrl||q.cmd)&&(r.preventDefault(),q.ctrlF.emit())}),window.addEventListener("keyup",r=>{r.key=="Meta"&&(q.cmd=!1),r.key=="Control"&&(q.ctrl=!1),r.key=="Alt"&&(b&&(q.ctrl=!1),q.alt=!1),r.key=="Shift"&&(q.shift=!1),r.key=="ArrowLeft"&&(q.left=!1),r.key=="ArrowRight"&&(q.right=!1)}),window.addEventListener("mousemove",r=>{q.ctrl=r.ctrlKey,q.alt=r.altKey,q.shift=r.shiftKey,q.cmd=r.metaKey,b&&(q.ctrl=q.ctrl||q.alt)})}),ke(()=>{window.removeEventListener("resize",z),ge().clear()});function z(){h.value=window.innerHeight,c.value=!0}function $(){s.showModal(le.EXPORT,u)}function C(){mt.push("/")}function P(){l.value&&l.value.updateScrollerWidth()}return(r,d)=>i.value?(m(),w("div",_l,[l.value&&!l.value.imageList?(m(),U(Bs,{key:0,tutorial:"project"})):E("",!0),a("div",xl,[a("div",wl,[I(e).isLoaded?I(e).isLoaded?(m(),w(Z,{key:1},[a("div",null,[R(Ko,{onExport:d[0]||(d[0]=x=>$()),onToggle:P})]),a("div",kl,[a("div",{class:"ms-1",ref_key:"navElem",ref:v},[R(tl,{"re-render":S,filterOpen:n.value,"onUpdate:filterOpen":d[1]||(d[1]=x=>n.value=x)},null,8,["filterOpen"])],512),c.value?(m(),w("div",$l)):E("",!0),R(Zt,{id:I(o).mainTab},{default:T(({tab:x})=>[R(Nr,{tab:x,height:p.value,ref_key:"mainViewRef",ref:l,"filter-open":n.value},null,8,["tab","height","filter-open"])]),_:1},8,["id"])])],64)):I(s).isProjectLoaded?(m(),w("div",Il,d[2]||(d[2]=[a("i",{class:"spinner-border",role:"status"},null,-1),a("span",{class:"ms-1"},"Loading...",-1)]))):(m(),w("div",Ml,[a("div",Sl,[a("div",null,L(r.$t("main.status.no_project")),1),a("div",{class:"bi bi-house p-3",onClick:C,style:{"font-size":"50px",cursor:"pointer"}})])])):(m(),w("div",{key:0,class:"d-flex flex-column w-100",style:te({height:h.value+"px"})},[R(bl,{class:"flex-grow-1"})],4))])])])):E("",!0)}}),El=j(Cl,[["__scopeId","data-v-bd31bdaa"]]);export{El as default};
