import{d as H,B as X,k as F,D as ne,l as T,b as a,i as ie,t as A,C as Qt,o as m,E as at,r as V,c as U,a as x,f as se,n as Y,F as N,s as J,h as R,G as pe,q as E,e as I,H as Ct,I as Ue,J as ct,_ as j,K as ve,m as oe,L as W,N as Pt,j as re,O as Le,u as be,Q as ke,R as Ce,w as Ae,v as Oe,S as ze,M as le,y as G,T as te,U as tt,V as it,W as Jt,X as me,Y as zt,Z as es,g as st,$ as pt,a0 as ts,a1 as ss,a2 as os,a3 as as,a4 as is,a5 as ns,a6 as rs,a7 as ls,a8 as us,a9 as ds,aa as Et,ab as Rt,ac as cs,ad as he,ae as de,af as ps,ag as Ve,ah as Tt,ai as q,aj as nt,ak as Lt,al as hs,am as At,an as vs,ao as Ot,ap as Vt,aq as Ft,ar as Pe,A as $e,as as ms,at as fs,au as gs,av as Ut,aw as ys,ax as bs,ay as _s,az as Dt,aA as ht,aB as vt,aC as xs,aD as ws,aE as ks,aF as $s,aG as Ms,aH as Ss,aI as Is,p as mt}from"./index-CjECibCW.js";import{V as Cs,c as Ee,M as rt,a as Re,G as Ps,T as Bt,d as lt,D as Gt,e as Ht,P as Nt,f as zs,I as Es,g as fe,L as Rs,B as De,h as Ts,i as Ls,j as As,k as Os,l as Vs,m as ft,S as Fs,O as Us,W as Ds}from"./three.module-Cl0ZyOCO.js";import{_ as Bs}from"./Tutorial.vue_vue_type_style_index_0_lang-DrsXcINg.js";const Gs={class:"text-nowrap"},Hs=["onClick"],Ns=["onClick"],Zs=H({__name:"FolderOptionDropdown",props:{folder:{}},setup(S){const t=X(),e=S;function o(){t.reImportFolder(e.folder.id)}function s(){confirm(Qt.global.t("main.nav.folders.del_alert"))&&t.deleteFolder(e.folder.id)}return(l,v)=>(m(),F(ne,{teleport:!0},{button:T(()=>v[0]||(v[0]=[a("i",{class:"bi bi-three-dots-vertical base-hover"},null,-1)])),popup:T(({hide:h})=>[a("div",Gs,[a("div",{class:"p-2 bb",onClick:p=>{o(),h()}},v[1]||(v[1]=[a("i",{class:"bi bi-arrow-clockwise me-1"},null,-1),ie("Re import")]),8,Hs),v[3]||(v[3]=a("div",{class:"custom-hr"},null,-1)),a("div",{class:"bb p-2",onClick:p=>{s(),h()}},[v[2]||(v[2]=a("i",{class:"bi bi-trash me-1"},null,-1)),ie(A(l.$t("main.nav.folders.del")),1)],8,Ns)])]),_:1}))}}),Ws=["onMouseenter"],qs=["onClick"],Ys={class:"text-secondary"},Xs=["onClick"],js=H({__name:"FolderList2",props:{folders:Array,visibleFolders:Object,filterManager:at,root:{type:Boolean,default:!0},tab:Object},setup(S){const t=X(),e=S,o=V(null),s=U(()=>{let i={};const c=new Set(e.filterManager.state.folders);return e.folders.map(u=>u.id).forEach(u=>{c.has(u)&&(i[u]=!0)}),i}),l=U(()=>{let i={};return e.folders.map(c=>c.id).forEach(c=>{e.visibleFolders[c]&&(i[c]=!0)}),i}),v=U(()=>{let i={};return e.folders.forEach(c=>{let u=[];s.value[c.id]&&u.push("selected"),i[c.id]=u.join(" ")}),i});function h(i){let c=e.visibleFolders;c[i]?delete c[i]:c[i]=!0}function p(i){let c=new Set(e.filterManager.state.folders);const u=c.has(i),_=t.folders[i].parent!=null&&c.has(t.folders[i].parent);u&&!_?(c.delete(i),Ue(i).forEach($=>c.delete($.id))):(n(i,c),c.add(i),Ue(i).forEach($=>c.add($.id)),ct(t.folders[i]).forEach($=>c.delete($.id))),e.filterManager.setFolders(Array.from(c)),e.tab.setSelectedFolder(c),e.filterManager.update(!0)}function n(i,c){const u=ct(t.folders[i]);let _;for(let $ of u)if(c.has($.id))_=$;else break;_!=null&&Ue(_.id).forEach($=>c.delete($.id))}return(i,c)=>{const u=Ct("FolderList2",!0);return m(),x("ul",{class:Y(e.root?"tree":""),style:se(e.root?"padding-left:0px;":"")},[(m(!0),x(N,null,J(S.folders,_=>(m(),x("li",{style:se(e.root?"padding-left:0px;":""),class:"no-break"},[a("div",{style:{display:"inline"},onMouseenter:$=>o.value=_.id,onMouseleave:c[1]||(c[1]=$=>o.value=null)},[a("summary",{class:Y(v.value[_.id]),onClick:$=>p(_.id)},[a("span",{class:Y(o.value===_.id?"visible-option":"invisible-option"),onClick:c[0]||(c[0]=pe(()=>{},["stop"]))},[E(Zs,{folder:_},null,8,["folder"])],2),ie(" "+A(_.name)+" ",1),a("span",Ys,A(I(t).folders[_.id].count),1)],10,qs)],40,Ws),_.children&&_.children.length>0?(m(),x("i",{key:0,onClick:$=>h(_.id),class:Y("bi bi-chevron-"+(l.value[_.id]?"down":"right")+" ms-2 btn-icon"),style:{"font-size":"9px"}},null,10,Xs)):R("",!0),_.children&&_.children.length>0&&l.value[_.id]?(m(),F(u,{key:1,folders:_.children,root:!1,"visible-folders":e.visibleFolders,"filter-manager":e.filterManager,tab:e.tab},null,8,["folders","visible-folders","filter-manager","tab"])):R("",!0)],4))),256))],6)}}}),Ks=j(js,[["__scopeId","data-v-08c57041"]]),Qs={class:"text-center"},Js={class:"w-100 text-center",style:{"font-size":"10px"}},eo={key:0,class:"progress",role:"progressbar","aria-label":"Example 1px high","aria-valuemin":"0","aria-valuemax":"100",style:{height:"1px"}},to=H({__name:"TaskStatus",props:{task:{}},setup(S){const t=S,e=U(()=>t.task.total-t.task.remain-t.task.computing),o=U(()=>t.task.total);return(s,l)=>(m(),x("div",Qs,[ie(A(t.task.name)+" ",1),a("div",Js,A(e.value)+" / "+A(o.value)+" "+A(s.$t("main.nav.tasks.done")),1),o.value>0?(m(),x("div",eo,[a("div",{class:"progress-bar",style:se(`width: ${e.value/o.value*100}%`)},null,4)])):R("",!0)]))}}),Zt=H({__name:"TabContainer",props:{id:{}},setup(S){const t=ve(),e=S;let o;const s=V(!1);function l(){o=t.getTab(e.id),s.value=!0}return oe(l),W(()=>e.id,async()=>{s.value=!1,await re(),l()}),(v,h)=>s.value&&I(t).loaded?Pt(v.$slots,"default",{key:0,tab:I(o)}):R("",!0)}}),Te={},so={class:"d-flex flex-row"},oo={key:2,class:"d-flex",style:{width:"150px"}},ao={class:"flex-grow-1"},io={key:1,style:{"padding-top":"1px"}},no={class:"text-center",style:{width:"24px","margin-top":"2px"}},ro={style:{width:"20px","margin-top":"2px","flex-shrink":"0"},class:"text-center"},lo={key:0},uo={key:0,class:"ms-3 pt-1"},co={key:1},po=H({__name:"PropertyOptions",props:{tab:{},property:{},open:{type:Boolean}},setup(S){const{t}=Le({useScope:"global"}),e=be();ke();const o=X(),s=S,l=V(!1),v=V(!1),h=V(""),p=V(!1),n=U(()=>s.tab.state.visibleProperties[s.property.id]==!0),i=U(()=>s.tab.collection.filterManager.state.filter.filters.some(y=>!y.isGroup&&y.propertyId==s.property.id)),c=U(()=>s.tab.collection.groupManager.state.groupBy.includes(s.property.id)),u=U(()=>s.tab.collection.sortManager.state.sortBy.includes(s.property.id)),_=U(()=>{if(i.value)return s.tab.collection.filterManager.state.filter.filters.find(y=>!y.isGroup&&y.propertyId==s.property.id).id}),$=()=>s.tab.collection.filterManager,z=U(()=>s.tab.getSha1Mode());function M(){n.value?s.tab.setVisibleProperty(s.property.id,!1):s.tab.setVisibleProperty(s.property.id,!0)}function P(){s.open&&(l.value?l.value=!1:(l.value=!0,h.value=s.property.name),v.value=!1)}function C(){s.property.type!=te.tag&&s.property.type!=te.multi_tags||(v.value?v.value=!1:v.value=!0,l.value=!1)}function r(){u.value?s.tab.collection.sortManager.delSort(s.property.id):s.tab.collection.sortManager.setSort(s.property.id),s.tab.collection.sortManager.update(!0)}function d(){c.value?s.tab.collection.groupManager.delGroupOption(s.property.id):s.tab.collection.groupManager.setGroupOption(s.property.id),s.tab.collection.groupManager.update(!0)}function w(){confirm(t("common.properties.delete")+": "+s.property.name+" ?   "+s.property.id)&&o.deleteProperty(s.property.id)}async function O(){h.value!=""&&(await o.updateProperty(s.property.id,h.value),P())}function L(){const y=$();i.value?(y.deleteFilter(_.value),Te.filter.hide()):(y.addNewFilter(s.property.id),Te.filter.show())}return W(()=>s.property,()=>{l.value=!1}),(y,b)=>(m(),x("div",{class:Y(p.value?"hover-light":"")},[a("div",so,[s.open?(m(),x(N,{key:0},[l.value?R("",!0):(m(),x("div",{key:0,class:"option-holder hover-light btn-icon",style:{width:"150px"},onClick:P},[E(Ce,{type:s.property.type,class:"me-2 btn-icon",onMouseenter:b[0]||(b[0]=f=>p.value=!0),onMouseleave:b[1]||(b[1]=f=>p.value=!1)},null,8,["type"]),a("span",null,A(s.property.name),1)]))],64)):(m(),F(Ce,{key:1,type:s.property.type,class:"me-2",style:{position:"relative",top:"2px"}},null,8,["type"])),l.value&&s.open?(m(),x("div",oo,[a("div",null,[a("i",{class:"btn-icon me-1 bi bi-x-lg",style:{padding:"2px"},onClick:P,onMouseenter:b[2]||(b[2]=f=>p.value=!0),onMouseleave:b[3]||(b[3]=f=>p.value=!1)},null,32)]),a("div",ao,[s.property.id>=0?Ae((m(),x("input",{key:0,style:{position:"relative",top:"1px"},type:"text",class:"text-input","onUpdate:modelValue":b[4]||(b[4]=f=>h.value=f),onChange:O},null,544)),[[Oe,h.value]]):(m(),x("span",io,[E(Ce,{type:s.property.type,class:"me-2 btn-icon"},null,8,["type"]),a("span",null,A(s.property.name),1)]))])])):R("",!0),s.open?(m(),x(N,{key:3},[I(ze)(s.property.type)?(m(),x("div",{key:0,style:{width:"20px","margin-top":"2px",cursor:"pointer"},class:"text-center",onClick:b[5]||(b[5]=f=>I(e).showModal(I(le).TAG,{propId:s.property.id}))},[E(G,{click:!1,message:"main.nav.properties.open_tags"},{default:T(()=>b[7]||(b[7]=[a("i",{class:"bi bi-arrows-fullscreen"},null,-1)])),_:1})])):R("",!0)],64)):R("",!0),s.open?(m(),x(N,{key:4},[a("div",no,[s.property.type==I(te).tag||s.property.type==I(te).multi_tags?(m(),x("div",{key:0,onClick:C,style:{cursor:"pointer"}},[v.value?(m(),F(G,{key:0,message:"main.nav.properties.collapse_property_tooltip"},{default:T(()=>b[8]||(b[8]=[a("i",{class:"bi bi-chevron-down"},null,-1)])),_:1})):(m(),F(G,{key:1,message:"main.nav.properties.expand_property_tooltip"},{default:T(()=>b[9]||(b[9]=[a("i",{class:"bi bi-chevron-right ms-1"},null,-1)])),_:1}))])):R("",!0)]),a("div",ro,[s.property.mode==I(tt).id?(m(),F(G,{key:0,click:!1,message:"main.nav.properties.linked_property_tooltip"},{default:T(()=>b[10]||(b[10]=[a("i",{class:"bi bi-link-45deg"},null,-1)])),_:1})):R("",!0)])],64)):R("",!0),a("div",{style:{width:"20px","margin-top":"2px","flex-shrink":"0"},onClick:M,class:"btn-icon text-center"},[z.value&&s.property.mode==I(tt).id?(m(),F(G,{key:0,message:"main.nav.properties.hidden_property_tooltip"},{default:T(()=>[a("span",{class:"bi bi-eye-slash",onClick:b[6]||(b[6]=pe(()=>{},["stop"]))})]),_:1})):(m(),F(G,{key:1,pos:"right",message:"main.nav.properties.hide_property_tooltip"},{default:T(()=>[a("span",{class:Y("bi bi-eye text-"+(n.value?"primary":"secondary"))},null,2)]),_:1}))])]),s.open?(m(),x("div",lo,[l.value?(m(),x("div",uo,[y.property.id!=I(it).folders?(m(),x("div",{key:0,class:Y(["options hover-light",i.value?" text-primary":""]),onClick:L},[a("div",null,[b[11]||(b[11]=a("i",{class:"bi bi-funnel-fill me-2"},null,-1)),ie(A(y.$t("main.menu.filters")),1)])],2)):R("",!0),a("div",{class:Y(["options hover-light",u.value?" text-primary":""]),onClick:r},[b[12]||(b[12]=a("i",{class:"bi bi-filter me-2"},null,-1)),ie(A(y.$t("main.menu.sort.title")),1)],2),a("div",{class:Y(["options hover-light",c.value?" text-primary":""]),onClick:d},[b[13]||(b[13]=a("i",{class:"bi bi-collection me-2"},null,-1)),ie(A(y.$t("main.menu.groupby")),1)],2),s.property.id>=0?(m(),x("div",{key:1,class:"options hover-light",onClick:w},[b[14]||(b[14]=a("i",{class:"bi bi-trash me-2"},null,-1)),ie(A(y.$t("main.nav.properties.delete_property")),1)])):R("",!0)])):v.value?(m(),x("div",co,[E(Jt,{property:s.property,"can-create":!0,"can-customize":!0,"can-delete":!0,"can-link":!0},null,8,["property"])])):R("",!0)])):R("",!0)],2))}}),ho=j(po,[["__scopeId","data-v-878a3d2a"]]),vo={key:0,class:"prop-container"},mo={key:0},fo={key:1},go={key:0,class:"ms-2 text-capitalize overflow-hidden"},yo={key:1,class:"ms-2"},bo={class:"p-1"},_o=["onClick"],xo=["onClick"],wo={key:0,class:"ps-1 pe-1"},ko={class:"property-item"},$o=H({__name:"PropertyGroup",props:{tab:{},node:{},menuOpen:{type:Boolean}},setup(S){const t=X(),e=be(),o=S,s=V(!0),l=V(!1),v=V(""),h=U(()=>o.node.propertyIds.map(C=>t.properties[C])),p=U(()=>o.node.propertyIds.map(C=>o.tab.isVisibleProperty(C)).filter(C=>!C).length==0),n=U(()=>{if(o.node.groupId>=0)return t.propertyGroups[o.node.groupId];if(o.node.groupId==me.DEFAULT)return{id:me.DEFAULT,name:"default"};if(o.node.groupId==me.COMPUTED)return{id:me.COMPUTED,name:"computed"}}),i=U(()=>n.value.id>=0);function c(){s.value=!s.value}function u(C){t.updatePropertyGroup(n.value.id,v.value)}function _(){v.value=n.value.name}function $(){t.deletePropertyGroup(n.value.id)}async function z(){const r={emptyProperties:t.propertyList.filter(w=>w.propertyGroupId==o.node.groupId).map(w=>w.id)};await t.sendCommit(r);const d={emptyPropertyGroups:[o.node.groupId]};await t.sendCommit(d)}async function M(C){if(C.added){let r=C.added.element;const d=t.properties[r];let w=o.node.groupId;w<0&&(w=null),await t.updateProperty(d.id,d.name,w),await t.triggerPropertyTreeChange()}C.moved&&await t.triggerPropertyTreeChange()}function P(){p.value?o.tab.setVisibleProperties(o.node.propertyIds,!1):o.tab.setVisibleProperties(o.node.propertyIds,!0)}return oe(_),W(o,_),(C,r)=>I(t).propertyGroups[o.node.groupId]||o.node.groupId<0?(m(),x("div",vo,[E(I(zt),{list:o.node.propertyIds,"item-key":d=>d,group:o.node.groupId>0||o.node.groupId==I(me).DEFAULT?"properties":void 0,onChange:M},{header:T(()=>[a("div",{class:"d-flex group-container",onClick:c},[s.value?(m(),x("div",mo,r[4]||(r[4]=[a("i",{class:"bi bi-caret-down-fill"},null,-1)]))):R("",!0),s.value?R("",!0):(m(),x("div",fo,r[5]||(r[5]=[a("i",{class:"bi bi-caret-right-fill"},null,-1)]))),o.menuOpen?(m(),x(N,{key:2},[l.value?R("",!0):(m(),x("div",go,A(n.value.name),1)),l.value?(m(),x("div",yo,[E(es,{"auto-focus":!0,modelValue:v.value,"onUpdate:modelValue":r[0]||(r[0]=d=>v.value=d),style:{"background-color":"white"},"min-height":25,width:135,onSubmit:u,onCancel:_,onBlur:r[1]||(r[1]=d=>l.value=!1)},null,8,["modelValue"])])):R("",!0),r[8]||(r[8]=a("div",{class:"flex-grow-1"},null,-1)),o.node.groupId>=I(me).DEFAULT?(m(),F(ne,{key:2,onClick:r[2]||(r[2]=pe(()=>{},["prevent","stop"]))},{button:T(()=>r[6]||(r[6]=[a("i",{class:"bb bi bi-three-dots"},null,-1)])),popup:T(({hide:d})=>[a("div",bo,[i.value?(m(),x(N,{key:0},[a("div",{class:"bb",onClick:w=>{l.value=!0,d()}},A(C.$t("main.menu.editName")),9,_o),a("div",{class:"bb",onClick:$},A(C.$t("main.menu.removeGroup")),1)],64)):R("",!0),a("div",{class:"bb",onClick:w=>{z(),d()}},A(C.$t("main.menu.deleteGroupAndProperties")),9,xo)])]),_:1})):R("",!0),o.node.groupId>=-1?(m(),x("div",{key:3,class:"bb me-1",onClick:r[3]||(r[3]=pe(d=>I(e).showModal(I(le).PROPERTY,{group:o.node.groupId}),["stop","prevent"]))},[E(G,{message:C.$t("main.menu.addNewPropertyToGroup")},{default:T(()=>r[7]||(r[7]=[a("i",{class:"bi bi-plus"},null,-1)])),_:1},8,["message"])])):R("",!0)],64)):R("",!0),o.node.propertyIds.length?(m(),x("div",{key:3,style:{cursor:"pointer","flex-shrink":"0","margin-right":"11px"},onClick:pe(P,["stop"])},[a("span",{class:Y("bi bi-eye text-"+(p.value?"primary":"secondary"))},null,2)])):R("",!0)])]),item:T(({element:d,index:w})=>[s.value&&h.value.length&&I(t).properties[d]?(m(),x("div",wo,[a("div",ko,[E(ho,{tab:o.tab,property:I(t).properties[d],open:o.menuOpen},null,8,["tab","property","open"])])])):R("",!0)]),_:1},8,["list","item-key","group"])])):R("",!0)}}),Be=j($o,[["__scopeId","data-v-f64e1371"]]),Mo={key:0,class:"mb-1"},So=H({__name:"DraggablePropertyList",props:{tab:{},menuOpen:{type:Boolean}},emits:[],setup(S,{emit:t}){const e=X(),o=S;function s(l){e.triggerPropertyTreeChange()}return(l,v)=>(m(),F(I(zt),{list:I(e).propertyTree,onChange:s,"item-key":h=>h.groupId},{item:T(({element:h})=>[h.groupId>=0?(m(),x("div",Mo,[E(Be,{tab:o.tab,node:h,"menu-open":o.menuOpen},null,8,["tab","node","menu-open"])])):R("",!0)]),footer:T(()=>[E(Be,{class:"mb-1",tab:o.tab,node:I(e).propertyTree[I(e).propertyTree.length-2],"menu-open":o.menuOpen},null,8,["tab","node","menu-open"]),E(Be,{class:"mb-1",tab:o.tab,node:I(e).propertyTree[I(e).propertyTree.length-1],"menu-open":o.menuOpen},null,8,["tab","node","menu-open"])]),_:1},8,["list","item-key"]))}}),Io={class:""},Co={class:"m-0",style:{padding:"4px 0px 4px 8px"}},Po={class:"d-flex align-items-center",style:{"font-size":"15px","line-height":"14px"}},zo={class:"flex-grow-1 text-capitalize overflow-hidden"},Eo={key:0,class:"bi bi-chevron-left"},Ro={key:1,class:"bi bi-chevron-right"},To={class:"ps-2 pe-2",style:{"padding-bottom":"9.5px"}},Lo={class:"d-flex align-items-center"},Ao={style:{"max-height":"300px",overflow:"auto"}},Oo={key:0,id:"import"},Vo={class:"pt-1 pb-2"},Fo={class:"d-flex align-items-center ps-2 pe-2",style:{height:"30px"}},Uo={key:0,class:"ps-2 pe-2"},Do={class:"p-1"},Bo={key:0,class:"custom-hr"},Go={class:"p-1 mt-0"},Ho={key:0,class:"d-flex p-1"},No={key:0,class:"spinner-grow spinner-grow-sm float-end",style:{width:"10px",height:"10px","margin-top":"5px"}},Zo={key:1,class:"bb me-1"},Wo={class:"bb me-2"},qo={key:1,class:"mt-2"},Yo=200,Xo=55,jo=H({__name:"Menu",emits:["export","toggle"],setup(S,{emit:t}){const e=ke(),o=X(),s=be(),l=ve(),v=t,h=V(!1),p=V(!0),n=U(()=>p.value?Yo:Xo),i=async()=>{s.showModal(le.IMPORT)},c=U(()=>e.state.tasks.filter(z=>!z.done)??[]);function u(){s.showModal(le.FOLDERSELECTION,{callback:_,mode:"images"})}function _(z){z&&o.addFolder(z)}function $(){p.value=!p.value,v("toggle")}return(z,M)=>(m(),F(Zt,{id:I(l).mainTab},{default:T(({tab:P})=>[a("div",{class:"menu overflow-scroll",style:se({width:n.value+"px"})},[a("div",Io,[a("div",null,[a("div",Co,[a("div",Po,[p.value?(m(),x(N,{key:0},[a("div",zo,A(I(e).state.name),1),E(G,{message:"main.menu.close_project"},{default:T(()=>[a("div",{class:"base-hover p-1",onClick:M[0]||(M[0]=C=>I(s).closeProject(I(e).state.id))},M[6]||(M[6]=[a("i",{class:"bi bi-arrow-up-left-square red-hover"},null,-1)]))]),_:1}),a("div",{class:"base-hover p-1",onClick:M[1]||(M[1]=C=>I(s).showModal(I(le).SETTINGS))},M[7]||(M[7]=[a("i",{class:"bi bi-gear"},null,-1)]))],64)):R("",!0),a("div",{class:Y(["base-hover p-1",p.value?"":"flex-grow-1 text-center"]),style:{"margin-right":"6px"},onClick:$},[p.value?(m(),x("i",Eo)):(m(),x("i",Ro))],2)])]),p.value?(m(),x(N,{key:0},[M[9]||(M[9]=a("div",{class:"custom-hr"},null,-1)),a("div",To,[a("div",Lo,[a("div",null,[a("b",null,A(z.$t("main.nav.folders.title")),1)]),a("div",{id:"add_folder",class:"ms-auto plus",onClick:M[2]||(M[2]=C=>{u(),I(st)()})},[E(G,{message:"main.nav.folders.add"},{default:T(()=>M[8]||(M[8]=[a("i",{class:"bi bi-plus"},null,-1)])),_:1})])]),a("div",Ao,[E(Ks,{folders:I(o).folderRoots,"filter-manager":P.collection.filterManager,"visible-folders":P.state.visibleFolders,tab:P},null,8,["folders","filter-manager","visible-folders","tab"])])])],64)):R("",!0),p.value?(m(),x(N,{key:1},[c.value&&c.value.length?(m(),x("div",Oo,[M[11]||(M[11]=a("div",{class:"custom-hr"},null,-1)),a("div",Vo,[a("div",Fo,[a("div",null,[a("b",null,A(z.$t("main.nav.tasks.title")),1)])]),M[10]||(M[10]=a("div",{class:"custom-hr"},null,-1)),I(e).state.tasks?(m(),x("div",Uo,[(m(!0),x(N,null,J(c.value,(C,r)=>(m(),x("div",Do,[r?(m(),x("div",Bo)):R("",!0),E(to,{task:C},null,8,["task"])]))),256))])):R("",!0)])])):R("",!0)],64)):R("",!0),M[18]||(M[18]=a("div",{class:"custom-hr"},null,-1)),a("div",Go,[p.value?(m(),x("div",Ho,[E(G,{message:"main.nav.properties.properties_tooltip",pos:"top",icon:!0},{default:T(()=>[a("b",null,A(z.$t("main.nav.properties.title")),1)]),_:1}),M[13]||(M[13]=a("span",{class:"flex-grow-1"},null,-1)),h.value?(m(),x("span",No,M[12]||(M[12]=[a("span",{class:"sr-only"},null,-1)]))):(m(),x("span",Zo,[E(G,{pos:"right",message:"main.nav.properties.import_properties_tooltip"},{default:T(()=>[a("i",{class:"bi bi-box-arrow-in-up text-secondary",style:{position:"relative",top:"0px","font-size":"15px"},onClick:i})]),_:1})])),a("span",Wo,[E(G,{pos:"right",message:"main.nav.properties.export_properties_tooltip"},{default:T(()=>[a("i",{class:"bi bi-box-arrow-up text-secondary",style:{position:"relative",top:"0px","font-size":"15px"},onClick:M[3]||(M[3]=C=>I(s).showModal(I(le).EXPORT,void 0))})]),_:1})])])):R("",!0),I(e).loaded?(m(),x("div",qo,[E(So,{tab:P,"menu-open":p.value},null,8,["tab","menu-open"]),p.value?(m(),x(N,{key:0},[M[16]||(M[16]=a("div",{class:"property-item m-0 p-0"},null,-1)),a("div",{id:"add-property",onClick:M[4]||(M[4]=C=>{I(s).showModal(I(le).PROPERTY,void 0),I(st)()}),class:"btn-icon base-hover mt-1",style:{"line-height":"25px"}},[M[14]||(M[14]=a("i",{class:"bi bi-plus btn-icon float-start",style:{"font-size":"25px"}},null,-1)),a("span",null,A(z.$t("main.nav.properties.add_property")),1)]),M[17]||(M[17]=a("div",{class:"custom-hr mt-1"},null,-1)),a("div",{onClick:M[5]||(M[5]=C=>I(o).addPropertyGroup("New Group")),class:"btn-icon base-hover mt-1",style:{"line-height":"25px"}},[M[15]||(M[15]=a("i",{class:"bi bi-plus btn-icon float-start",style:{"font-size":"25px"}},null,-1)),a("span",null,A(z.$t("main.nav.properties.add_property_group")),1)])],64)):R("",!0)])):R("",!0)])])])],4)]),_:1},8,["id"]))}}),Ko=j(jo,[["__scopeId","data-v-89a8f03a"]]),Qo={class:"p-0 hover-light ps-1 bb",style:{width:"50px"}},Jo={class:""},ea=["onClick"],ta=H({__name:"FilterGroupOperator",props:{modelValue:{}},emits:["update:modelValue"],setup(S,{emit:t}){const e=S,o=t;function s(l){o("update:modelValue",l)}return(l,v)=>(m(),F(ne,null,{button:T(()=>[a("div",Qo,[a("span",Jo,A(l.$t("modals.filters."+e.modelValue)),1)])]),popup:T(({hide:h})=>[a("div",{class:"ps-2 pt-1 pb-1 pe-2",onClick:h},[a("div",{class:"base-btn",onClick:v[0]||(v[0]=p=>s(I(pt).and))},A(l.$t("modals.filters.and")),1),v[2]||(v[2]=a("hr",{class:"m-0 p-0 mt-1 mb-1"},null,-1)),a("div",{class:"base-btn",onClick:v[1]||(v[1]=p=>s(I(pt).or))},A(l.$t("modals.filters.or")),1)],8,ea)]),_:1}))}}),sa=["disabled"],oa={class:"m-0 p-1"},aa=["onClick"],ia=H({__name:"OperatorChoice",props:{propertyId:{},modelValue:{},disabled:{type:Boolean}},emits:["hide","update:modelValue"],setup(S,{emit:t}){const e=X(),o=S,s=t,l=U(()=>e.properties[o.propertyId]),v=U(()=>ts(l.value.type));async function h(p){s("update:modelValue",p)}return(p,n)=>(m(),F(ne,{onHide:n[0]||(n[0]=i=>s("hide")),placement:"bottom"},{button:T(()=>[a("div",{class:"text-nowrap sb ps-1 pe-1",disabled:o.disabled},[a("span",null,A(p.$t("modals.filters.operators."+o.modelValue)),1)],8,sa)]),popup:T(({hide:i})=>[a("div",oa,[(m(!0),x(N,null,J(v.value,c=>(m(),x("div",{class:"hover-light p-1 rounded",style:{cursor:"pointer"},onClick:u=>{h(c),i()}},[a("a",null,A(p.$t("modals.filters.operators."+c)),1)],8,aa))),256))])]),_:1}))}}),na=j(ia,[["__scopeId","data-v-0b3d97be"]]),ra={class:"d-flex text-nowrap overflow-hidden",style:{"font-size":"14px"}},la=H({__name:"FilterValueInput",props:{modelValue:{},property:{},width:{}},emits:["update:modelValue"],setup(S,{emit:t}){const e=S,o=t;function s(l){o("update:modelValue",l)}return(l,v)=>(m(),x("div",ra,[I(ze)(l.property.type)?(m(),F(ss,{key:0,"model-value":e.modelValue,"onUpdate:modelValue":s,"no-wrap":!0,"auto-focus":!0,"can-create":!1,"can-customize":!1,property:e.property,teleport:!1,width:e.width,class:"sb","force-multi":!0},null,8,["model-value","property","width"])):e.property.type==I(te).color?(m(),F(os,{key:1,"model-value":e.modelValue,"onUpdate:modelValue":s,width:e.width,rounded:!0,"min-height":22,teleport:!1,offset:2,class:"sb"},null,8,["model-value","width"])):e.property.type==I(te).number?(m(),F(as,{key:2,"model-value":e.modelValue,"onUpdate:modelValue":s,width:e.width,height:26,"input-offset":0,class:"sb"},null,8,["model-value","width"])):e.property.type==I(te).url?(m(),F(is,{key:3,"model-value":e.modelValue,"onUpdate:modelValue":s,width:e.width,offset:-22,class:"sb"},null,8,["model-value","width"])):e.property.type==I(te).checkbox?(m(),F(ns,{key:4,"model-value":e.modelValue,"onUpdate:modelValue":s,label:e.property.name,width:e.width,class:"sb"},null,8,["model-value","label","width"])):e.property.type==I(te).date?(m(),F(rs,{key:5,"model-value":e.modelValue,teleport:!1,"onUpdate:modelValue":s,width:e.width,class:"sb"},null,8,["model-value","width"])):(m(),F(ls,{key:6,"model-value":e.modelValue,"onUpdate:modelValue":s,width:e.width,offset:-22,class:"sb"},null,8,["model-value","width"]))]))}}),ua={class:"p-0 m-0 ps-2"},da=H({__name:"FilterRow",props:{manager:{},filter:{}},emits:[],setup(S,{emit:t}){const e=X(),o=S,s=U(()=>e.properties[o.filter.propertyId]),l=U(()=>us(o.filter.operator));function v(n){o.manager.updateFilter(o.filter.id,{operator:n})}function h(n){o.manager.updateFilter(o.filter.id,{value:n})}function p(n){o.manager.updateFilter(o.filter.id,{propertyId:n.id})}return(n,i)=>(m(),x(N,null,[a("td",ua,[E(ds,{"model-value":s.value,"onUpdate:modelValue":p},null,8,["model-value"])]),a("td",null,[E(na,{"property-id":s.value.id,"model-value":o.filter.operator,"onUpdate:modelValue":v},null,8,["property-id","model-value"])]),a("td",null,[l.value?(m(),F(la,{key:0,"model-value":o.filter.value,"onUpdate:modelValue":h,property:s.value,width:140,style:{width:"150px"},class:""},null,8,["model-value","property"])):R("",!0)])],64))}}),ca={style:{"max-height":"500px",overflow:"auto"}},Wt=H({__name:"AddFilterBtn",props:{group:{},manager:{}},emits:[],setup(S,{emit:t}){const e=S;function o(s){e.manager.addNewFilter(s,e.group.id),Te.filter.show()}return(s,l)=>(m(),F(ne,{placement:"auto"},{button:T(()=>[Pt(s.$slots,"default")]),popup:T(({hide:v})=>[a("div",ca,[E(Et,{onSelect:h=>{o(h),v()},"ignore-ids":[I(it).folders]},null,8,["onSelect","ignore-ids"])])]),_:3}))}}),pa={class:"filter-group"},ha={class:"table table-sm"},va={style:{height:"33px"}},ma={class:""},fa={key:0,class:"m-0 p-0"},ga={key:2,class:"text-secondary"},ya={class:"border rounded"},ba={class:""},_a=["onClick"],xa={class:"d-flex text-secondary ms-2"},wa={class:"add-options hover-light"},ka=H({__name:"FilterGroup",props:{filter:{},manager:{},parent:{}},emits:["delete"],setup(S,{emit:t}){X();const e=S,o=U(()=>e.filter),s=U(()=>o.value.filters),l=U(()=>{let n=255-(o.value.depth+1)*5;return`background: rgb(${n},${n},${n});`});function v(n){e.manager.deleteFilter(n.id)}function h(n){e.manager.addNewFilterGroup(n)}function p(n,i){e.manager.updateFilterGroup(n,i)}return(n,i)=>(m(),x("div",pa,[a("table",ha,[(m(!0),x(N,null,J(s.value,(c,u)=>(m(),x("tr",va,[a("td",ma,[u==0?(m(),x("div",fa,A(n.$t("modals.filters.where")),1)):u==1?(m(),F(ta,{key:1,"model-value":o.value.groupOperator,"onUpdate:modelValue":i[0]||(i[0]=_=>p(o.value.id,_))},null,8,["model-value"])):(m(),x("span",ga,A(n.$t("modals.filters."+o.value.groupOperator)),1))]),c.propertyId!==void 0?(m(),F(da,{key:0,filter:c,manager:e.manager},null,8,["filter","manager"])):(m(),x("td",{key:1,colspan:"3",style:se(l.value)},[a("div",ya,[E(qt,{filter:c,manager:e.manager},null,8,["filter","manager"])])],4)),a("td",ba,[a("span",{class:"base-btn",onClick:_=>v(c)},i[2]||(i[2]=[a("i",{class:"bi bi-trash"},null,-1)]),8,_a)])]))),256))]),a("div",xa,[E(Wt,{group:e.filter,manager:e.manager},{default:T(()=>[a("div",wa,[i[3]||(i[3]=a("i",{class:"bi bi-plus"},null,-1)),ie(A(n.$t("modals.filters.new_filter")),1)])]),_:1},8,["group","manager"]),a("div",{class:"add-options hover-light",onClick:i[1]||(i[1]=c=>h(o.value.id))},[i[4]||(i[4]=a("i",{class:"bi bi-plus"},null,-1)),ie(A(n.$t("modals.filters.new_group")),1)])])]))}}),qt=j(ka,[["__scopeId","data-v-cbadcac5"]]),$a={key:0,class:"d-flex flex-row m-0 ms-1 p-1 bg hover-light bg-medium",style:{cursor:"pointer"}},Ma={key:0},Sa={key:0,class:"or-separator"},Ia={key:0,class:"or-separator"},Ca={key:0,class:"m-1 p-1"},Pa=H({__name:"MainFilterDropdown",props:{manager:at},emits:["update:modelValue"],setup(S,{emit:t}){const e=X(),o=S,s=V(null),l=V(null),v=U(()=>{let p=h(o.manager.state.filter),n={};return p.forEach(i=>n[i.propertyId]=i),Object.values(n)});function h(p){let n=[];for(let i of p.filters)i.isGroup?n.push(...h(i)):n.push(i);return n}return W(()=>o.manager.state.filter.filters,()=>{o.manager.state.filter.filters.length==0&&l.value.hide()}),oe(async()=>{await re(),Te.filter=l.value}),(p,n)=>(m(),F(ne,{ref_key:"dropdownElem",ref:l,placement:"top-start"},{button:T(()=>[a("div",null,[v.value.length||o.manager.state.query?.text?(m(),x("div",$a,[o.manager.state.query?.text?(m(),x("div",Ma,[n[0]||(n[0]=a("span",{class:"text-primary"},"Text Query",-1)),v.value.length?(m(),x("span",Sa,"|")):R("",!0)])):R("",!0),(m(!0),x(N,null,J(v.value,(i,c)=>(m(),x("div",null,[c>0?(m(),x("span",Ia,"|")):R("",!0),i.propertyId==I(it).id?(m(),F(Ce,{key:1,type:I(e).properties[i.propertyId].type,style:{"margin-right":"2px"}},null,8,["type"])):R("",!0),a("span",null,A(I(e).properties[i.propertyId].name),1)]))),256))])):R("",!0)])]),popup:T(()=>[a("div",{class:"m-0 p-0",ref_key:"popupElem",ref:s},[Object.keys(I(e).properties).length>0?(m(),x("div",Ca,[E(qt,{filter:o.manager.state.filter,manager:o.manager,parent:s.value},null,8,["filter","manager","parent"])])):R("",!0)],512)]),_:1},512))}}),za=j(Pa,[["__scopeId","data-v-dd2d67a7"]]),Ea={class:"d-flex flex-row filter-form"},Ra={class:"pt-1 pb-1"},Ta=H({__name:"FilterForm",props:{manager:at},setup(S){const t=S;return(e,o)=>(m(),x("div",Ea,[a("div",Ra,A(e.$t("main.menu.filters"))+": ",1),E(za,{manager:t.manager},null,8,["manager"]),E(Wt,{manager:t.manager,group:t.manager.state.filter,class:"p-1"},{default:T(()=>o[0]||(o[0]=[a("span",{class:"base-hover plus-btn text-secondary"},[a("i",{class:"bi bi-plus"})],-1)])),_:1},8,["manager","group"])]))}}),La=j(Ta,[["__scopeId","data-v-aad7b24a"]]),Aa={class:"p-1",style:{"max-height":"400px","overflow-y":"scroll"}},Oa=H({__name:"PropertyDropdown",props:{groupIds:Array},emits:["select"],setup(S,{emit:t}){const e=S,o=t,s=V(null);return(l,v)=>(m(),F(ne,{ref_key:"dropdownElem",ref:s,"auto-focus":!1},{button:T(()=>v[2]||(v[2]=[a("div",{class:"text-secondary p-1"},[a("span",{class:"base-hover plus-btn"},[a("i",{class:"bi bi-plus"})])],-1)])),popup:T(()=>[a("div",Aa,[E(Et,{onClick:v[0]||(v[0]=h=>I(st)()),onSelect:v[1]||(v[1]=h=>{o("select",h),s.value.hide()}),"ignore-ids":e.groupIds},null,8,["ignore-ids"])])]),_:1},512))}}),Yt=j(Oa,[["__scopeId","data-v-2f10e29f"]]),Va={class:"base-hover ps-1 pe-1"},Fa={class:"main"},Ua=["onClick"],Da=H({__name:"TimeUnitDropdown",props:{modelValue:{}},emits:["update:modelValue"],setup(S,{emit:t}){const e=S,o=t,s=Object.values(Rt);function l(v){o("update:modelValue",v)}return(v,h)=>(m(),F(ne,null,{button:T(()=>[a("div",Va,A(e.modelValue),1)]),popup:T(({hide:p})=>[a("div",Fa,[(m(!0),x(N,null,J(I(s),n=>(m(),x("div",{class:"base-hover option",onClick:i=>{l(n),p()}},A(n),9,Ua))),256))])]),_:1}))}}),Ba=j(Da,[["__scopeId","data-v-cc9d0d61"]]),Ga={class:""},Ha={class:"d-flex ipt"},Na={class:"ms-2",min:"1"},Za=H({__name:"GroupOptionDropdown",props:{option:{}},emits:["change"],setup(S,{emit:t}){const e=S,o=t,s=V(1),l=V(Rt.Year);function v(){e.option.stepSize==s.value&&e.option.stepUnit==l.value||o("change",{stepSize:s.value,stepUnit:l.value})}function h(){s.value=e.option.stepSize??1,l.value=e.option.stepUnit}return W(()=>e.option,h),oe(h),W(s,()=>{(s.value<1||s.value==null||isNaN(s.value))&&(s.value=1)}),(p,n)=>(m(),F(ne,{onHide:v},{button:T(()=>n[2]||(n[2]=[a("i",{class:"bi bi-three-dots-vertical"},null,-1)])),popup:T(({hide:i,focus:c})=>[a("div",Ga,[a("div",Ha,[a("div",null,[Ae(a("input",{type:"number","onUpdate:modelValue":n[0]||(n[0]=u=>s.value=u)},null,512),[[Oe,s.value]])]),a("div",Na,[E(Ba,{modelValue:l.value,"onUpdate:modelValue":n[1]||(n[1]=u=>l.value=u),onHide:c},null,8,["modelValue","onHide"])])])])]),_:1}))}}),Wa=j(Za,[["__scopeId","data-v-a27bea28"]]),qa={class:"d-flex flex-row group-form"},Ya={class:"pt-1 pb-1"},Xa={key:0,class:"bg-selected bg d-flex flex-row m-0 ms-1 p-0 align-items-center"},ja={key:0,class:"bi bi-chevron-right smaller"},Ka=["onClick"],Qa=["onClick"],Ja=["onClick"],ei=["onClick"],ti=["onClick"],si=["onClick"],oi=["onClick"],ai=["onClick"],ii=["onClick"],ni={key:5,class:"sm-btn"},ri={key:0,class:"spinner-grow spinner-grow-sm loading ms-1"},li=H({__name:"GroupForm",props:{isLoading:Boolean,manager:cs},setup(S){const t=X(),e=S;function o(i){e.manager.setGroupOption(i),e.manager.update(!0)}function s(i){e.manager.delGroupOption(i),e.manager.update(!0)}function l(i,c){e.manager.setGroupOption(i,{direction:c}),e.manager.sortGroups(!0)}function v(i,c){e.manager.setGroupOption(i,{type:c}),e.manager.sortGroups(!0)}function h(i,c){e.manager.setGroupOption(i,c),e.manager.update(!0)}const p=U(()=>e.manager.state.groupBy.map(i=>t.properties[i])),n=U(()=>{const i=[];return e.manager.state.groupBy.forEach(c=>{i.push({option:e.manager.state.options[c],property:t.properties[c]})}),i});return(i,c)=>(m(),x("div",qa,[a("div",Ya,A(i.$t("main.menu.groupby"))+": ",1),p.value.length?(m(),x("div",Xa,[(m(!0),x(N,null,J(n.value,(u,_)=>(m(),x(N,null,[_>0?(m(),x("i",ja)):R("",!0),a("div",{class:"base-hover m-1 ps-1 pe-1",onClick:$=>s(u.property.id),id:"remove-group-button"},A(u.property.name),9,Ka),u.option.type==I(he).Size?(m(),F(G,{key:1,message:"main.menu.sort.group_order_nb_tooltip"},{default:T(()=>[u.option.direction==I(de).Ascending?(m(),x("i",{key:0,class:"bi bi-sort-up-alt sm-btn",onClick:$=>v(u.property.id,I(he).Property)},null,8,Qa)):(m(),x("i",{key:1,class:"bi bi-sort-down sm-btn",onClick:$=>v(u.property.id,I(he).Property)},null,8,Ja))]),_:2},1024)):(m(),F(G,{key:2,message:"main.menu.sort.group_order_az_tooltip"},{default:T(()=>[u.property.type==I(te).number?(m(),x(N,{key:0},[u.option.direction==I(de).Ascending?(m(),x("i",{key:0,class:"bi bi-sort-numeric-up sm-btn",onClick:$=>v(u.property.id,I(he).Size)},null,8,ei)):(m(),x("i",{key:1,class:"bi bi-sort-numeric-down-alt sm-btn",onClick:$=>v(u.property.id,I(he).Size)},null,8,ti))],64)):(m(),x(N,{key:1},[u.option.direction==I(de).Ascending?(m(),x("i",{key:0,class:"bi bi-sort-alpha-up sm-btn",onClick:$=>v(u.property.id,I(he).Size)},null,8,si)):(m(),x("i",{key:1,class:"bi bi-sort-alpha-down-alt sm-btn",onClick:$=>v(u.property.id,I(he).Size)},null,8,oi))],64))]),_:2},1024)),u.option.direction==I(de).Ascending?(m(),F(G,{key:3,message:"main.menu.sort.order_asc"},{default:T(()=>[a("i",{class:"bi bi-arrow-up sm-btn",onClick:$=>l(u.property.id,I(de).Descending)},null,8,ai)]),_:2},1024)):(m(),F(G,{key:4,message:"main.menu.sort.order_desc"},{default:T(()=>[a("i",{class:"bi bi-arrow-down sm-btn",onClick:$=>l(u.property.id,I(de).Ascending)},null,8,ii)]),_:2},1024)),u.property.type==I(te).date?(m(),x("div",ni,[E(Wa,{option:u.option,onChange:$=>h(u.property.id,$)},null,8,["option","onChange"])])):R("",!0)],64))),256)),e.isLoading?(m(),x("i",ri)):R("",!0)])):R("",!0),E(Yt,{id:"add-group-button","group-ids":e.manager.state.groupBy,onSelect:c[0]||(c[0]=u=>o(u))},null,8,["group-ids"])]))}}),ui=j(li,[["__scopeId","data-v-beb2e1ca"]]),di={class:"d-flex flex-row sort-form"},ci={class:"pt-1 pb-1"},pi={key:0,class:"d-flex flex-row m-0 p-0 bg-medium bg ms-1 align-items-center"},hi={key:0,class:"bi bi-chevron-right smaller"},vi=["onClick"],mi=["onClick"],fi=["onClick"],gi=H({__name:"SortForm",props:{manager:ps},setup(S){const t=X(),e=S,o=U(()=>e.manager.state.sortBy.map(p=>({propertyId:p,direction:e.manager.state.options[p].direction}))),s=U(()=>o.value.map(p=>p.propertyId));function l(p){e.manager.setSort(p),e.manager.update(!0)}function v(p){e.manager.delSort(p),e.manager.update(!0)}function h(p,n){e.manager.setSort(p,{direction:n}),e.manager.update(!0)}return(p,n)=>(m(),x("div",di,[a("div",ci,A(p.$t("main.menu.sort.title"))+": ",1),o.value.length?(m(),x("div",pi,[(m(!0),x(N,null,J(o.value,(i,c)=>(m(),x(N,null,[c>0?(m(),x("i",hi)):R("",!0),a("div",{class:"me-0 ms-1 ps-1 mt-1 mb-1 pe-1 base-hover",onClick:u=>v(i.propertyId)},A(I(t).properties[i.propertyId].name),9,vi),i.direction==I(de).Ascending?(m(),F(G,{key:1,message:"main.menu.sort.order_asc"},{default:T(()=>[a("i",{class:"bi bi-arrow-up sm-btn",onClick:u=>h(i.propertyId,I(de).Descending)},null,8,mi)]),_:2},1024)):(m(),F(G,{key:2,message:"main.menu.sort.order_desc"},{default:T(()=>[a("i",{class:"bi bi-arrow-down sm-btn",onClick:u=>h(i.propertyId,I(de).Ascending)},null,8,fi)]),_:2},1024))],64))),256))])):R("",!0),E(Yt,{"group-ids":s.value,onSelect:n[0]||(n[0]=i=>l(i))},null,8,["group-ids"])]))}}),yi=j(gi,[["__scopeId","data-v-80dc564a"]]),bi={class:"p-2"},_i={key:0,class:"border mb-1 p-1 text-center text-secondary",style:{"background-color":"#f7f7f7"}},xi={class:"border mb-1 p-1"},wi={class:"me"},ki={key:0},$i={key:1},Mi={class:"border mb-1 p-1",style:{"background-color":"#f7f7f7"}},Si={class:"d-flex center justify-content-center"},Ii={key:1,class:"bi bi-arrow-down text-secondary"},Ci={key:3,class:"bi bi-arrow-up text-secondary"},Pi={class:"border mb-1 p-1"},zi={class:"me"},Ei={key:0},Ri={key:1},Ti={key:1,class:"border mb-1 p-1 text-center text-secondary",style:{"background-color":"#f7f7f7"}},ge=5,Li=H({__name:"HistoryDropdown",emits:[],setup(S,{emit:t}){const e=X(),o=V(!1),s=U(()=>o.value?{backgroundColor:"blue"}:{backgroundColor:"white"}),l=U(()=>[...e.history.undo].reverse().slice(0,ge)),v=U(()=>e.history.redo.slice(Math.max(e.history.redo.length-ge,0)));return W(()=>e.onUndo,()=>{console.log("changed"),o.value=!0,setTimeout(()=>o.value=!1,100)}),(h,p)=>l.value.length||v.value.length?(m(),F(ne,{key:0},{button:T(()=>[E(G,{message:"dropdown.history.info"},{default:T(()=>[a("div",{class:"d-flex sb flash",style:se([{"font-size":"14px"},s.value])},[p[2]||(p[2]=a("i",{class:"bi bi-clock-history me-1"},null,-1)),a("div",null,A(h.$t("dropdown.history.button")),1)],4)]),_:1})]),popup:T(()=>[a("div",bi,[I(e).history.redo.length>ge?(m(),x("div",_i," + "+A(I(e).history.redo.length-ge),1)):R("",!0),(m(!0),x(N,null,J(v.value,n=>(m(),x("div",xi,[a("span",wi,A(new Date(n.timestamp).toLocaleTimeString("fr-Fr",{hour:"2-digit",minute:"2-digit"})),1),p[3]||(p[3]=a("span",{class:"sep ms-1 me-1"},null,-1)),n.tags?(m(),x("span",ki,A(n.tags)+" "+A(h.$t("dropdown.history.tags")),1)):R("",!0),n.values?(m(),x("span",$i,A(n.values)+" "+A(h.$t("dropdown.history.values")),1)):R("",!0)]))),256)),a("div",Mi,[a("div",Si,[l.value.length?(m(),F(G,{key:0,message:"dropdown.history.undo"},{default:T(()=>[a("div",{class:"bi bi-arrow-down sb",onClick:p[0]||(p[0]=(...n)=>I(e).undo&&I(e).undo(...n))})]),_:1})):(m(),x("div",Ii)),p[4]||(p[4]=a("div",{style:{width:"30px"}},null,-1)),v.value.length?(m(),F(G,{key:2,message:"dropdown.history.redo"},{default:T(()=>[a("div",{class:"bi bi-arrow-up sb",onClick:p[1]||(p[1]=(...n)=>I(e).redo&&I(e).redo(...n))})]),_:1})):(m(),x("div",Ci))])]),(m(!0),x(N,null,J(l.value,n=>(m(),x("div",Pi,[a("span",zi,A(new Date(n.timestamp).toLocaleTimeString("fr-Fr",{hour:"2-digit",minute:"2-digit"})),1),p[5]||(p[5]=a("span",{class:"sep ms-1 me-1"},null,-1)),n.tags?(m(),x("span",Ei,A(n.tags)+" "+A(h.$t("dropdown.history.tags")),1)):R("",!0),n.values?(m(),x("span",Ri,A(n.values)+" "+A(h.$t("dropdown.history.values")),1)):R("",!0)]))),256)),I(e).history.undo.length>ge?(m(),x("div",Ti," + "+A(I(e).history.undo.length-ge),1)):R("",!0)])]),_:1})):R("",!0)}}),Ai=j(Li,[["__scopeId","data-v-b5086318"]]),Oi=H({__name:"ToggleReload",props:{tab:{}},emits:[],setup(S,{emit:t}){const e=S,o=U(()=>e.tab.collection.state.autoReload?2:e.tab.collection.runState.isDirty?0:1);function s(){o.value==0?e.tab.collection.update():o.value==1?e.tab.collection.setAutoReload(!0):e.tab.collection.setAutoReload(!1)}return(l,v)=>(m(),x("div",{class:"bb font",onClick:s,style:{width:"26px",height:"30px",overflow:"hidde"}},[o.value==0?(m(),F(G,{key:0,message:"btn.reload.dirty",pos:"bottom"},{default:T(()=>v[0]||(v[0]=[a("span",{class:"bi bi-arrow-repeat text-warning"},null,-1)])),_:1})):R("",!0),o.value==1?(m(),F(G,{key:1,message:"btn.reload.valid",pos:"bottom"},{default:T(()=>v[1]||(v[1]=[a("span",{class:"bi bi-check2-all text-success"},null,-1)])),_:1})):R("",!0),o.value==2?(m(),F(G,{key:2,message:"btn.reload.auto",pos:"bottom"},{default:T(()=>v[2]||(v[2]=[a("div",{style:{height:"30px"}},[a("span",{class:"bi bi-check2-all text-success small-valid"}),a("span",{class:"bi bi-arrow-repeat big-arrow text-warning",style:{opacity:"0.3"}})],-1)])),_:1})):R("",!0)]))}}),Vi=j(Oi,[["__scopeId","data-v-4047bb79"]]),Fi=["onSubmit"],Ui={class:"mb-1"},Di={class:"d-flex flex-center mt-3",style:{height:"20px"}},Bi=["onClick"],Gi=["onClick"],Hi=H({__name:"InputOptions",props:{functionId:{},size:{},hideText:{type:Boolean}},emits:["changed"],setup(S,{emit:t}){const e=Ve(),o=S,s=t,l=V([]),v=U(()=>o.size?o.size:12),h=U(()=>o.functionId.slice(0,o.functionId.indexOf(".")));function p(){if(!o.functionId||!e.index[o.functionId])return;const c=e.index[o.functionId].params,u=e.getContext(o.functionId).uiInputs;for(let _ of c)_.defaultValue=u[_.name];l.value=JSON.parse(JSON.stringify(c))}async function n(){for(let c in l.value)e.index[o.functionId].params[c].defaultValue=l.value[c].defaultValue;await e.updateDefaultParams(),s("changed")}function i(){p()}return oe(p),(c,u)=>l.value.length?(m(),x("div",{key:0,style:se({fontSize:v.value+"px"})},[E(ne,null,{button:T(()=>[a("div",null,[E(G,{message:"Options"},{default:T(()=>u[0]||(u[0]=[a("span",{class:"bbb"},[a("i",{class:"bi bi-gear"})],-1)])),_:1})])]),popup:T(({hide:_})=>[a("form",{onSubmit:pe($=>{n(),_()},["prevent"]),class:"p-2"},[(m(!0),x(N,null,J(l.value,($,z)=>(m(),x("div",Ui,[$.name=="text"&&o.hideText?R("",!0):(m(),F(Tt,{key:0,input:$,source:h.value},null,8,["input","source"]))]))),256)),a("div",Di,[u[1]||(u[1]=a("div",{class:"flex-grow-1"},null,-1)),a("div",{class:"bb",onClick:$=>{i(),_()}},A(c.$t("cancel")),9,Bi),a("div",{class:"bb",onClick:$=>{n(),_()}},A(c.$t("confirm")),9,Gi)])],40,Fi)]),_:1})],4)):R("",!0)}}),Ni={class:"cont3"},Zi={class:"select-wrapper"},Wi=["placeholder"],qi={style:{width:"22px"}},Yi={key:0},Xi=H({__name:"TextSearchInput",props:{query:{}},emits:["update:query"],setup(S,{emit:t}){const e=Ve(),o=S,s=t,l=V(null),v=V(!1),h=[{value:"text",icon:"search"},{value:"regex",icon:"regex"}],p=V([]),n=V("text"),i=V(""),c=U(()=>n.value!="text"&&n.value!="regex");function u(){const P=e.textSearchFunctions.map(C=>({value:C.id,icon:"boxes"}));p.value=[...h,...P]}function _(){o.query&&(n.value=o.query.type||"text",i.value=o.query.text||"")}function $(){i.value="",M()}function z(){M()}function M(){const P={type:n.value,text:i.value};if(c.value){if(!e.index[n.value]){n.value="text",$();return}const C=e.getContext(n.value);C.uiInputs.text=i.value,P.ctx=C}s("update:query",P)}return u(),W(()=>o.query,_,{deep:!0}),W(()=>e.textSearchFunctions,u),W(n,M),oe(()=>{u(),_()}),q.ctrlF.on(()=>l.value?.focus()),(P,C)=>(m(),x("div",Ni,[a("div",Zi,[E(nt,{options:p.value,modelValue:n.value,"onUpdate:modelValue":C[0]||(C[0]=r=>n.value=r),placeholder:"Search Mode",class:"bg-white",size:16},null,8,["options","modelValue"])]),a("div",{class:Y(["input-field d-flex items-align-center",{focus:v.value}])},[Ae(a("input",{class:"text-input2",type:"text","onUpdate:modelValue":C[1]||(C[1]=r=>i.value=r),placeholder:P.$t("main.menu.search"),ref_key:"inputElem",ref:l,onFocusin:C[2]||(C[2]=r=>v.value=!0),onFocusout:C[3]||(C[3]=r=>v.value=!1),onKeypress:Lt(z,["enter"])},null,40,Wi),[[Oe,i.value]]),a("div",qi,[i.value.length?(m(),x("i",{key:0,class:"bi bi-x sb",onClick:$})):R("",!0)])],2),c.value?(m(),x("div",Yi,[E(Hi,{"function-id":n.value,size:14,"hide-text":!0,onChanged:M},null,8,["function-id"])])):R("",!0)]))}}),ji=j(Xi,[["__scopeId","data-v-0636227e"]]),Ki={class:"d-flex flex-row p-2 align-items-center"},Qi={class:"me-3 d-flex"},Ji={class:"ms-5",style:{"font-size":"13px"}},en=["checked"],tn={class:"ms-1"},sn={class:"ms-4"},on={class:"d-flex flex-wrap content-container ps-2"},an=H({__name:"ContentFilter",props:{tab:{},computeStatus:{}},emits:["compute-ml","search-images","remove:selected"],setup(S,{emit:t}){hs();const e=S,o=V({type:"text",text:""}),s=U(()=>Object.keys(e.tab.collection.groupManager.selectedImages.value).map(Number)),l=U(()=>s.value.length);function v(n){const i=n.target.checked;e.tab.collection.groupManager.setSha1Mode(i,!0)}function h(){o.value=e.tab.state.filterState.query}function p(n){o.value=n,e.tab.collection.filterManager.setQuery(o.value),e.tab.collection.filterManager.update(!0),e.tab.saveState()}return oe(h),W(()=>e.tab.collection.filterManager.state.query,h),(n,i)=>(m(),x(N,null,[a("div",Ki,[E(ji,{class:"me-3",style:{"flex-shrink":"0"},query:o.value,"onUpdate:query":p},null,8,["query"]),a("div",Qi,[E(G,{message:"main.menu.grid_tooltip"},{default:T(()=>[a("i",{class:Y("bi bi-grid-3x3-gap-fill me-2 btn-icon"+(e.tab.state.display=="tree"?"":" text-secondary")),onClick:i[0]||(i[0]=c=>e.tab.setViewMode("tree"))},null,2)]),_:1}),E(G,{message:"main.menu.table_tooltip"},{default:T(()=>[a("i",{id:"toot",class:Y("bi bi-table btn-icon me-2"+(e.tab.state.display=="grid"?"":" text-secondary")),onClick:i[1]||(i[1]=c=>e.tab.setViewMode("grid"))},null,2)]),_:1}),E(G,{message:"main.menu.graph_tooltip"},{default:T(()=>[a("i",{id:"toot",class:Y("bi bi-bar-chart btn-icon me-2"+(e.tab.state.display=="graph"?"":" text-secondary")),onClick:i[2]||(i[2]=c=>e.tab.setViewMode("graph"))},null,2)]),_:1}),E(G,{message:"main.menu.map_tooltip"},{default:T(()=>[a("i",{id:"toot",class:Y("bi bi-map btn-icon"+(e.tab.state.display=="map"?"":" text-secondary")),onClick:i[3]||(i[3]=c=>e.tab.setViewMode("map"))},null,2)]),_:1})]),E(G,{message:"main.menu.image_size_tooltip",click:!1},{default:T(()=>i[7]||(i[7]=[a("div",{class:"bi bi-aspect-ratio me-1"},null,-1)])),_:1}),a("div",null,[E(At,{min:30,max:500,modelValue:e.tab.state.imageSize,"onUpdate:modelValue":i[4]||(i[4]=c=>e.tab.state.imageSize=c)},null,8,["modelValue"])]),a("div",Ji,[E(G,{message:"main.menu.image_mode_tooltip"},{default:T(()=>[a("input",{type:"checkbox",checked:e.tab.collection.groupManager.state.sha1Mode,onChange:v},null,40,en),a("span",tn,A(n.$t("main.menu.image_mode")),1)]),_:1})]),a("div",sn,[E(Ai)]),a("div",null,[l.value?(m(),F(vs,{key:0,class:"ms-5",style:{"font-size":"14px"},"selected-images-ids":s.value,"onRemove:selected":i[5]||(i[5]=c=>e.tab.collection.groupManager.clearSelection()),onStamped:i[6]||(i[6]=c=>e.tab.collection.groupManager.clearSelection())},null,8,["selected-images-ids"])):R("",!0)]),i[9]||(i[9]=a("div",{class:"flex-grow-1"},null,-1)),E(G,{message:"main.menu.issue",class:"bb"},{default:T(()=>i[8]||(i[8]=[a("a",{href:"https://github.com/CERES-Sorbonne/Panoptic/issues/new/choose",target:"_blank",class:"bi bi-cone-striped",style:{color:"grey"}},null,-1)])),_:1})]),a("div",on,[E(Vi,{tab:e.tab,class:"me-1"},null,8,["tab"]),E(La,{manager:e.tab.collection.filterManager},null,8,["manager"]),E(ui,{"is-loading":e.computeStatus.groups,manager:e.tab.collection.groupManager},null,8,["is-loading","manager"]),E(yi,{manager:e.tab.collection.sortManager},null,8,["manager"]),i[10]||(i[10]=a("div",null,null,-1))])],64))}}),nn=j(an,[["__scopeId","data-v-efa67cb9"]]),rn={class:""},ln={class:"d-flex flex-row"},un=H({__name:"ImageRecomended",props:{pile:Object,size:{type:Number,default:100}},emits:["accept","refuse"],setup(S,{emit:t}){const e=be(),o=S,s=t,l=U(()=>`width: ${o.size}px; height: ${o.size}px;`);U(()=>`max-width: ${o.size-2}px; max-height: ${o.size-1}px;`);const v=U(()=>o.pile.images[0]);return(h,p)=>(m(),x("div",rn,[E(Ot,{image:v.value},{default:T(()=>[a("div",{style:se(l.value),class:"img-container",onClick:p[0]||(p[0]=n=>I(e).showModal(I(le).IMAGE,{image:v.value}))},[E(Vt,{image:v.value,width:o.size-2,height:o.size-1},null,8,["image","width","height"])],4)]),_:1},8,["image"]),a("div",ln,[E(G,{message:"main.recommand.accept"},{default:T(()=>[a("div",{style:se(["width: "+o.size/2+"px;",{"font-size":"10px"}]),class:"text-center text-success validate clickable unselectable",onClick:p[1]||(p[1]=n=>s("accept",v.value))}," ✓ ",4)]),_:1}),E(G,{message:"main.recommand.refuse"},{default:T(()=>[a("div",{style:se(["width: "+o.size/2+"px;",{"font-size":"10px"}]),class:"text-center text-danger refuse clickable unselectable",onClick:p[2]||(p[2]=n=>s("refuse",v.value))}," ✕ ",4)]),_:1})])]))}}),dn=j(un,[["__scopeId","data-v-809d667b"]]),cn={class:"bbb"},pn={class:"p-2"},hn=["onClick"],vn={key:0,class:"ms-1"},mn=["onSubmit"],fn={class:"mb-1"},gn={class:"d-flex flex-center mt-3",style:{height:"20px"}},yn=["onClick"],bn=["onClick"],_n=H({__name:"ActionSelect",props:{action:{},hideGear:{type:Boolean},size:{}},emits:["changed"],setup(S,{emit:t}){const e=Ve(),o=S,s=t,l=U(()=>e.defaultActions[o.action]),v=V([]),h=V(null),p=U(()=>o.size?o.size:12),n=U(()=>Ft(e.index).filter(P=>P.hooks.includes(o.action)).map(P=>P.id)),i=U(()=>h.value.slice(0,h.value.indexOf(".")));function c(){h.value=l.value,u()}function u(){const M=h.value;if(!M||!e.index[M])return;const P=e.index[M].params,C=e.getContext(M).uiInputs;for(let r of P)r.defaultValue=C[r.name];v.value=JSON.parse(JSON.stringify(P))}async function _(){const M=h.value;for(let P in v.value)e.index[M].params[P].defaultValue=v.value[P].defaultValue;await e.updateDefaultParams(),s("changed")}function $(){u()}async function z(M){const P={};P[o.action]=M,await e.updateDefaultActions(P),await c(),s("changed")}return oe(c),(M,P)=>(m(),x("div",{class:"d-flex",style:se({fontSize:p.value+"px"})},[E(ne,null,{button:T(()=>[a("div",null,[h.value?(m(),F(G,{key:0,class:"p-0 m-0",message:I(e).index[h.value].description},{default:T(()=>[a("span",cn,[ie(A(h.value),1),P[0]||(P[0]=a("i",{class:"ms-1 bi bi-chevron-down"},null,-1))])]),_:1},8,["message"])):R("",!0)])]),popup:T(({hide:C})=>[a("div",pn,[(m(!0),x(N,null,J(n.value,r=>(m(),x("div",{class:"bb",onClick:d=>{z(r),C()}},[E(G,{message:I(e).index[r].description},{default:T(()=>[ie(A(r),1)]),_:2},1032,["message"])],8,hn))),256))])]),_:1}),v.value.length&&!o.hideGear?(m(),x("div",vn,[E(ne,null,{button:T(()=>[a("div",null,[E(G,{message:"Options"},{default:T(()=>P[1]||(P[1]=[a("span",{class:"bbb"},[a("i",{class:"bi bi-gear"})],-1)])),_:1})])]),popup:T(({hide:C})=>[a("form",{onSubmit:pe(r=>{_(),C()},["prevent"]),class:"p-2"},[(m(!0),x(N,null,J(v.value,(r,d)=>(m(),x("div",fn,[E(Tt,{input:r,source:i.value},null,8,["input","source"])]))),256)),a("div",gn,[P[2]||(P[2]=a("div",{class:"flex-grow-1"},null,-1)),a("div",{class:"bb",onClick:r=>{$(),C()}},A(M.$t("cancel")),9,yn),a("div",{class:"bb",onClick:r=>{_(),C()}},A(M.$t("confirm")),9,bn)])],40,mn)]),_:1})])):R("",!0)],4))}}),xn={class:"reco-container"},wn={class:"d-flex flex-row m-0 ps-2 center mb-1 mt-0",style:{height:"25px"}},kn={key:0,class:"bi bi-funnel-fill bb text-primary"},$n={key:1,class:"bi bi-funnel bb"},Mn={class:"text-secondary me-2"},Sn={style:{"padding-top":"2px"},class:"me-1"},In={class:"flex-grow-1"},Cn={class:"d-flex flex-row"},Pn={key:0,class:"separator"},zn={class:"d-flex flex-row"},Ge=10,En=H({__name:"RecommendedMenu",props:{tab:{},imageSize:{},group:{},width:{},height:{}},emits:["scroll","close","update"],setup(S,{emit:t}){const e=X(),o=Ve(),s=S,l=t,v=V(1),h=Pe([]),p=V(null),n=Pe([]),i=Pe(new Set),c=V(!0),u=[],_=[];async function $(L){const y=[],b=[];n.forEach(f=>{if(f.value!=null){const g=e.properties[f.propertyId];let k=f.value;g.type==te.multi_tags?(k=L.properties[f.propertyId]??[],k=[...k,f.value]):g.type==te.tag&&(k=[k]),g.mode==tt.id?b.push({instanceId:L.id,propertyId:g.id,value:k}):y.push({propertyId:g.id,sha1:L.sha1,value:k})}}),await e.setPropertyValues(b,y)}function z(L){p.value.isSha1Group?p.value.images.filter(y=>y.sha1==L.sha1).forEach(y=>i.add(y.id)):i.add(L.id),O()}function M(){h.length=0;let L=[];const y=_.map(b=>e.instances[b]);if(p.value.isSha1Group){const b={},f=Array.from(new Set(y.map(g=>g.sha1)));f.forEach(g=>b[g]=[]),y.forEach(g=>b[g.sha1].push(g)),f.forEach(g=>L.push({sha1:g,images:e.sha1Index[g]}))}else y.forEach(b=>L.push({sha1:b.sha1,images:[b]}));P(L,h,v.value,s.imageSize,s.width)}function P(L,y,b,f,g){let k=g,D=[],B=0;for(let K=0;K<L.length&&!(y.length>=b);K++){let Z=L[K];if(Z.images=Z.images.filter(ae=>!i.has(ae.id)),Z.images.length==0)continue;let Q=f+Ge;if(B+Q<k){D.push(Z),B+=Q;continue}if(D.length==0)throw new Error("Images seems to be to big for the line");y.push(D),y.length<b&&(D=[Z],B=Q)}D.length>0&&y.length<b&&y.push(D)}async function C(){if(!s.group||!o.hasSimilaryFunction)return;const L=o.defaultActions.similar,y=o.getContext(L);y.instanceIds=s.group.images.map(D=>D.id);const b=await o.getSimilarImages(y);if(!b)return;if(!b.groups)throw new Error("No instances in ActionResult");let g=fs(b.groups)[0];if(c.value){const D=new Set(s.tab.collection.filterManager.result.images.map(B=>B.id));g.images=g.images.filter(B=>D.has(B.id))}g.scores&&gs(g),p.value=g,n.length=0;let k=s.group;for(;k;)n.push(...k.meta.propertyValues),k=k.parent;i.clear(),u.length=0,g.images.forEach(D=>u.push(D.id)),O(),l("update")}function r(){c.value=!c.value}function d(){s.tab.collection.groupManager.onResultChange.addListener(O)}function w(){s.tab.collection.groupManager.onResultChange.removeListener(O)}function O(){const L=s.tab.collection.groupManager.result.index[s.group.id];if(!L){l("close");return}_.length=0;const y=new Set(L.images.map(b=>b.id));u.forEach(b=>{y.has(b)||i.has(b)||_.push(b)}),M()}return oe(d),$e(w),oe(C),W(()=>s.group,()=>{C(),i.clear()}),W(()=>s.imageSize,M),W(()=>s.width,M),W(c,C),(L,y)=>(m(),x("div",xn,[a("div",wn,[E(G,{message:"main.recommand.close"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:y[0]||(y[0]=b=>l("close"))},y[2]||(y[2]=[a("span",{class:"bi bi-x-lg bb"},null,-1)]))]),_:1}),y[5]||(y[5]=a("div",{class:"b-left pe-1"},null,-1)),E(G,{message:"main.recommand.scroll"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:y[1]||(y[1]=b=>l("scroll",s.group.id))},y[3]||(y[3]=[a("span",{class:"bi bi-arrow-down-circle bb"},null,-1)]))]),_:1}),y[6]||(y[6]=a("div",{class:"b-left pe-1"},null,-1)),E(G,{message:"main.recommand.filter"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:r},[c.value?(m(),x("span",kn)):(m(),x("span",$n))])]),_:1}),y[7]||(y[7]=a("div",{class:"b-left pe-1"},null,-1)),E(G,{message:"main.recommand.reload"},{default:T(()=>[a("div",{class:"text-secondary pe-1",onClick:C},y[4]||(y[4]=[a("span",{class:"bi bi-arrow-clockwise bb"},null,-1)]))]),_:1}),y[8]||(y[8]=a("div",{class:"b-left pe-1"},null,-1)),E(G,{"icon-pos":"left",message:"main.recommand.tooltip",icon:!0},{default:T(()=>[a("span",Mn,A(L.$t("main.recommand.title")),1)]),_:1}),a("div",Sn,[E(_n,{action:"similar",onChanged:C})]),a("div",In,[a("div",Cn,[(m(!0),x(N,null,J(n,(b,f)=>(m(),x(N,null,[E(ms,{class:"",value:b},null,8,["value"]),f<n.length-1?(m(),x("div",Pn)):R("",!0)],64))),256))])])]),a("div",{style:se("margin-left:"+Ge+"px;")},[(m(!0),x(N,null,J(h,b=>(m(),x("div",null,[a("div",zn,[(m(!0),x(N,null,J(b,f=>(m(),F(dn,{pile:f,size:s.imageSize,onAccept:$,onRefuse:z,style:se("margin-right:"+Ge+"px;")},null,8,["pile","size","style"]))),256))])]))),256))],4)]))}}),Rn=j(En,[["__scopeId","data-v-c830b08a"]]),Tn={style:{display:"flex"}},Ln={class:"info"},An={__name:"LineChart",props:{chartData:{series:Array,xValues:Array,dataType:te},height:String},setup(S){const t=S,e=V(0),o=V(!1),s={};Object.keys(t.chartData.series).forEach(c=>{s[c]=!1});const l=V({markers:{size:7},legend:{showForSingleSeries:!0,onItemClick:{toggleDataSeries:!1}},xaxis:{type:t.chartData.dataType===te.date?"datetime":"numeric",categories:t.chartData.xValues},chart:{type:"area",stacked:!1,stackOnlyBar:!1,zoom:{type:"x",autoScaleYaxis:!0},animations:{animateGradually:{enabled:!1,delay:150}}},dataLabels:{enabled:!1},stroke:{curve:"straight"},tooltip:{intersect:!0,shared:!1,custom:function({series:c,seriesIndex:u,dataPointIndex:_,w:$}){const z=t.chartData.series[u].data[_];let M='<div style="display: grid; grid-template-columns: repeat(5, 1fr); grid-gap: 5px;">';z.images.forEach((C,r)=>{r<10&&(M+=`<div style="width: 75px; height: 75px;"><img src="${C}" style="width: 100%; height: 100%;" /></div>`)}),M+="</div>";let P=`<span style="display: flex; align-items: center; justify-content: center;min-height:40px"><b>${t.chartData.series[u].name} — </b> ${z.y} Images</span>`;return P+=`<div>${M}</div>`,P}}}),v=()=>{l.value.chart.stacked=!l.value.chart.stacked,o.value=!o.value,e.value+=1},h=()=>{let c;l.value.chart.type==="area"?c={chart:{...l.value.chart,type:"bar"}}:c={chart:{...l.value.chart,type:"area"}},l.value={...l.value,...c},e.value+=1},p=(c,u,_)=>{const z=t.chartData.series[u];let M=Math.max(...z.data.map(P=>P.y));if(document.querySelectorAll(".apexcharts-custom-image").forEach(P=>P.remove()),s[u]){s[u]=!1;return}z.data.forEach((P,C)=>{const d=Math.floor(P.y/M*17),w=P.images.slice(0,d),O=`circle[index="${u}"][j="${C}"]`,L=document.querySelector(O),y=parseFloat(L.getAttribute("cx"));w.forEach((b,f)=>{const g=document.createElement("img");g.src=b,g.width=40,g.height=40,g.style.position="absolute";let k=y+40/1.5,D=65+f*40;g.style.left=`${k}px`,g.style.bottom=`${D}px`,g.classList.add("apexcharts-custom-image"),g.addEventListener("mouseover",B=>n(k,D,b)),g.addEventListener("mouseout",i),c.el.appendChild(g)})}),Object.keys(s).forEach(P=>s[P]=!1),s[u]=!0};function n(c,u,_){const $=document.getElementById("zoomed-image");$.style.left=`${c+120*1.5}px`,$.src=_,$.style.bottom=`${u}px`,$.style.display="block"}function i(){const c=document.getElementById("zoomed-image");c.style.display="none"}return(c,u)=>{const _=Ct("apexchart");return m(),x(N,null,[a("div",Tn,[a("button",{class:"mt-2",onClick:h},A(l.value.chart.type==="area"?c.$t("main.graph-view.histo"):c.$t("main.graph-view.curve")),1),t.chartData.series.length>1?(m(),x("button",{key:0,class:"mt-2",style:{"margin-left":"1em"},onClick:v},A(o.value?c.$t("main.graph-view.over"):c.$t("main.graph-view.stack")),1)):R("",!0)]),(m(),F(_,{style:{position:"relative"},key:e.value,height:t.height,type:l.value.chart.type,options:l.value,series:t.chartData.series,onLegendClick:p},null,8,["height","type","options","series"])),a("i",Ln,A(c.$t("main.graph-view.info")),1),u[0]||(u[0]=a("img",{id:"zoomed-image",style:{display:"none",position:"absolute","z-index":"1000",width:"120px",height:"120px","pointer-events":"none"}},null,-1))],64)}}},On={key:1},Vn=H({__name:"GraphView",props:{collection:{},height:{}},emits:[],setup(S,{emit:t}){const e=X(),o=S,s=V(""),l=V(h());function v(){const p=new Set;let n=o.collection.groupManager.getGroupIterator();for(;n;){const i=n.group;if(i.id===0||i.meta.propertyValues&&i.meta.propertyValues[0].value==null){n=n.nextGroup();continue}for(let c of i.children)p.add(c.meta.propertyValues[0].value);i.children.forEach(()=>n=n.nextGroup()),n=n.nextGroup()}return p}function h(){const p={};let n,i=o.collection.groupManager.state.groupBy;if(i.length===0){s.value="Choose at least one date or numeric value to group the images by";return}const c=e.properties[i[0]],u=c.type;if(i.length>2){s.value="Only max two levels of grouping are supported";return}else if(i.length===1)p[c.name]={name:c.name,data:[]};else if(n=Array.from(v()),n.length>20){s.value="Too many curves to draw, select a subgrouping with less than 20 possible values";return}if(u!==te.number&&u!==te.date){s.value="First level of grouping needs to be a date or a numeric property";return}let _=o.collection.groupManager.getGroupIterator();const $=[];for(;_;){const z=_.group;if(z.id===0||z.meta.propertyValues&&z.meta.propertyValues[0].value==null){_=_.nextGroup();continue}let M=z.meta.propertyValues[0];const P=u===te.date?new Date(M.value).getTime():M.value;if($.push(P),c.name in p)p[c.name].data.push({x:P,y:z.images.length,images:z.images.slice(0,20).map(C=>C.urlSmall)});else{const C=z.children.map(d=>d.meta.propertyValues[0].value),r=n.filter(d=>!C.includes(d));for(let d of z.children){const w=d.meta.propertyValues[0].value;if(p[w]===void 0){let O=w;w in e.tags&&(O=e.tags[w].value),p[w]={data:[],name:O}}p[d.meta.propertyValues[0].value].data.push({x:P,y:d.images.length,images:d.images.slice(0,20).map(O=>O.urlSmall)})}for(let d of r){if(p[d]===void 0){let w=d;d in e.tags&&(w=e.tags[d].value),p[d]={data:[],name:w}}p[d].data.push({x:P,y:0,images:[]})}z.children.forEach(()=>_=_.nextGroup())}_=_.nextGroup()}return s.value="",{series:Object.values(p),xValues:$,dataType:u}}return o.collection.groupManager.onResultChange.addListener(()=>l.value=h()),(p,n)=>(m(),x("div",{class:"",style:se({height:o.height+"px"})},[s.value===""?(m(),F(An,{key:0,chartData:l.value,height:o.height-50+"px"},null,8,["chartData","height"])):(m(),x("span",On,A(s.value),1))],4))}});class Fn{camera;domElement;spatialIndex;mode="pan";isDragging=!1;isLassoing=!1;prevPos={x:0,y:0};mouse=new Cs;animationId=null;isMouseInCanvas=!1;lasso;minZoom=.01;maxZoom=20;zoomSpeed=.001;onUpdate=()=>{};constructor(t,e,o,s){this.camera=t,this.domElement=e,this.lasso=o,this.spatialIndex=s,this.init()}init(){this.domElement.addEventListener("wheel",this.handleWheel,{passive:!1}),this.domElement.addEventListener("mousedown",this.handleMouseDown),this.domElement.addEventListener("mouseenter",this.handleMouseEnter),this.domElement.addEventListener("mouseleave",this.handleMouseLeave),window.addEventListener("mousemove",this.handleMouseMove),window.addEventListener("mouseup",this.handleMouseUp)}handleMouseEnter=()=>{this.isMouseInCanvas=!0};handleMouseLeave=()=>{this.isMouseInCanvas=!1};handleMouseMove=t=>{const e=this.domElement.getBoundingClientRect();if(this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1,this.isLassoing){this.lasso.move(this.getMouseWorldPos(),{x:t.clientX,y:t.clientY}),this.onUpdate();return}if(this.isDragging&&this.mode==="pan"){const o=t.clientX-this.prevPos.x,s=t.clientY-this.prevPos.y,l=(this.camera.right-this.camera.left)/this.camera.zoom,v=(this.camera.top-this.camera.bottom)/this.camera.zoom;this.camera.position.x-=o*(l/e.width),this.camera.position.y+=s*(v/e.height),this.prevPos={x:t.clientX,y:t.clientY},this.onUpdate()}};getHoveredPoint(t){if(this.mode.startsWith("lasso")||!this.isMouseInCanvas)return null;const e=this.getMouseWorldPos(),o=this.camera.zoom,{h:s,z1:l,z2:v}=t;let h=s;o>=l&&o<v?h=s*(l/o):o>=v&&(h=s*(l/v));const p=this.spatialIndex.getPointsInRect({minX:e.x-h,maxX:e.x+h,minY:e.y-h,maxY:e.y+h});p.sort((n,i)=>{const c=Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2),u=Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2);return c-u});for(const n of p){const i=n.ratio>1?1:n.ratio,c=n.ratio>1?1/n.ratio:1,u=i*h/2,_=c*h/2;if(e.x>=n.x-u&&e.x<=n.x+u&&e.y>=n.y-_&&e.y<=n.y+_)return n}return null}handleWheel=t=>{t.preventDefault();const e=this.getMouseWorldPos(),o=t.deltaY*-this.zoomSpeed*this.camera.zoom;this.camera.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.camera.zoom+o)),this.camera.updateProjectionMatrix();const s=this.getMouseWorldPos();this.camera.position.x+=e.x-s.x,this.camera.position.y+=e.y-s.y,this.onUpdate()};handleMouseDown=t=>{this.mode.startsWith("lasso")?(this.isLassoing=!0,this.lasso.start(this.getMouseWorldPos(),{x:t.clientX,y:t.clientY})):this.mode==="pan"&&(this.isDragging=!0,this.prevPos={x:t.clientX,y:t.clientY}),this.updateCursor(),this.onUpdate()};handleMouseUp=()=>{this.isLassoing&&(this.isLassoing=!1,this.lasso.end()),this.isDragging=!1,this.updateCursor(),this.onUpdate()};setMode(t){this.isLassoing&&this.lasso.clear(),this.isLassoing=!1,this.isDragging=!1,this.mode=t,this.updateCursor()}getMode(){return this.mode}updateCursor(){this.isLassoing||this.mode.startsWith("lasso")?this.domElement.style.cursor="crosshair":this.isDragging?this.domElement.style.cursor="grabbing":this.mode==="pan"?this.domElement.style.cursor="grab":this.domElement.style.cursor="default"}getMouseWorldPos(){const t=new Ee,e=(this.camera.right-this.camera.left)/this.camera.zoom,o=(this.camera.top-this.camera.bottom)/this.camera.zoom;return t.x=this.camera.position.x+this.mouse.x*e/2,t.y=this.camera.position.y+this.mouse.y*o/2,t}lookAtRect(t,e=500){const o=(t.minX+t.maxX)/2,s=(t.minY+t.maxY)/2,l=t.maxX-t.minX,v=t.maxY-t.minY,h=this.camera.right-this.camera.left,p=this.camera.top-this.camera.bottom,n=h/l,i=p/v,c=Math.max(this.minZoom,Math.min(this.maxZoom,Math.min(n,i)*.9)),u=new Ee(o,s,this.camera.position.z),_=this.camera.position.clone(),$=this.camera.zoom,z=performance.now();this.animationId&&cancelAnimationFrame(this.animationId);const M=P=>{const C=P-z,r=Math.min(C/e,1),d=1-Math.pow(1-r,3);this.camera.position.lerpVectors(_,u,d),this.camera.zoom=$+(c-$)*d,this.camera.updateProjectionMatrix(),this.onUpdate(),r<1?this.animationId=requestAnimationFrame(M):this.animationId=null};this.animationId=requestAnimationFrame(M)}dispose(){this.domElement.removeEventListener("wheel",this.handleWheel),this.domElement.removeEventListener("mousedown",this.handleMouseDown),this.domElement.removeEventListener("mouseenter",this.handleMouseEnter),this.domElement.removeEventListener("mouseleave",this.handleMouseLeave),window.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("mouseup",this.handleMouseUp)}}const gt=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],He=1,xe=8;class ut{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[e,o]=new Uint8Array(t,0,2);if(e!==219)throw new Error("Data does not appear to be in a KDBush format.");const s=o>>4;if(s!==He)throw new Error(`Got v${s} data when expected v${He}.`);const l=gt[o&15];if(!l)throw new Error("Unrecognized array type.");const[v]=new Uint16Array(t,2,1),[h]=new Uint32Array(t,4,1);return new ut(h,v,l,t)}constructor(t,e=64,o=Float64Array,s){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=o,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const l=gt.indexOf(this.ArrayType),v=t*2*this.ArrayType.BYTES_PER_ELEMENT,h=t*this.IndexArrayType.BYTES_PER_ELEMENT,p=(8-h%8)%8;if(l<0)throw new Error(`Unexpected typed array class: ${o}.`);s&&s instanceof ArrayBuffer?(this.data=s,this.ids=new this.IndexArrayType(this.data,xe,t),this.coords=new this.ArrayType(this.data,xe+h+p,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(xe+v+h+p),this.ids=new this.IndexArrayType(this.data,xe,t),this.coords=new this.ArrayType(this.data,xe+h+p,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(He<<4)+l]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=t,this.coords[this._pos++]=e,o}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return ot(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,e,o,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:v,nodeSize:h}=this,p=[0,l.length-1,0],n=[];for(;p.length;){const i=p.pop()||0,c=p.pop()||0,u=p.pop()||0;if(c-u<=h){for(let M=u;M<=c;M++){const P=v[2*M],C=v[2*M+1];P>=t&&P<=o&&C>=e&&C<=s&&n.push(l[M])}continue}const _=u+c>>1,$=v[2*_],z=v[2*_+1];$>=t&&$<=o&&z>=e&&z<=s&&n.push(l[_]),(i===0?t<=$:e<=z)&&(p.push(u),p.push(_-1),p.push(1-i)),(i===0?o>=$:s>=z)&&(p.push(_+1),p.push(c),p.push(1-i))}return n}within(t,e,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:l,nodeSize:v}=this,h=[0,s.length-1,0],p=[],n=o*o;for(;h.length;){const i=h.pop()||0,c=h.pop()||0,u=h.pop()||0;if(c-u<=v){for(let M=u;M<=c;M++)yt(l[2*M],l[2*M+1],t,e)<=n&&p.push(s[M]);continue}const _=u+c>>1,$=l[2*_],z=l[2*_+1];yt($,z,t,e)<=n&&p.push(s[_]),(i===0?t-o<=$:e-o<=z)&&(h.push(u),h.push(_-1),h.push(1-i)),(i===0?t+o>=$:e+o>=z)&&(h.push(_+1),h.push(c),h.push(1-i))}return p}}function ot(S,t,e,o,s,l){if(s-o<=e)return;const v=o+s>>1;Xt(S,t,v,o,s,l),ot(S,t,e,o,v-1,1-l),ot(S,t,e,v+1,s,1-l)}function Xt(S,t,e,o,s,l){for(;s>o;){if(s-o>600){const n=s-o+1,i=e-o+1,c=Math.log(n),u=.5*Math.exp(2*c/3),_=.5*Math.sqrt(c*u*(n-u)/n)*(i-n/2<0?-1:1),$=Math.max(o,Math.floor(e-i*u/n+_)),z=Math.min(s,Math.floor(e+(n-i)*u/n+_));Xt(S,t,e,$,z,l)}const v=t[2*e+l];let h=o,p=s;for(we(S,t,o,e),t[2*s+l]>v&&we(S,t,o,s);h<p;){for(we(S,t,h,p),h++,p--;t[2*h+l]<v;)h++;for(;t[2*p+l]>v;)p--}t[2*o+l]===v?we(S,t,o,p):(p++,we(S,t,p,s)),p<=e&&(o=p+1),e<=p&&(s=p-1)}}function we(S,t,e,o){Ne(S,e,o),Ne(t,2*e,2*o),Ne(t,2*e+1,2*o+1)}function Ne(S,t,e){const o=S[t];S[t]=S[e],S[e]=o}function yt(S,t,e,o){const s=S-e,l=t-o;return s*s+l*l}class Un{tree=null;idToPointMap=new Map;initTree(t){this.idToPointMap.clear(),this.tree=new ut(t.length);for(const e of t){const o=this.tree.add(e.x,e.y);this.idToPointMap.set(o,e),e.id=o}this.tree.finish()}getPointsInRect(t){return this.tree?this.tree.range(t.minX,t.minY,t.maxX,t.maxY).map(o=>this.idToPointMap.get(o)):[]}getNearestPoint(t,e,o=1/0){if(!this.tree)return null;const s=this.tree.within(t,e,o);return s.length===0?null:this.idToPointMap.get(s[0])||null}clear(){this.tree=null,this.idToPointMap.clear()}}class Dn extends rt{_zoomRef={value:1};_zoomParams=new Ee(1,.1,.8);_ratio={value:1};_borderColor={value:new Re(0)};_borderWidth={value:0};_radius={value:.05};constructor(t){super(t),this.onBeforeCompile=e=>{e.uniforms.uZoom=this._zoomRef,e.uniforms.uZoomParams={value:this._zoomParams},e.uniforms.uRatio=this._ratio,e.uniforms.uBorderColor=this._borderColor,e.uniforms.uBorderWidth=this._borderWidth,e.uniforms.uRadius=this._radius,e.vertexShader=`
                varying vec2 vRawUv;
                uniform float uZoom;
                uniform vec3 uZoomParams;
                uniform float uRatio;
                ${e.vertexShader}
            `.replace("#include <begin_vertex>",`
                vec3 transformed = vec3( position );
                float h  = uZoomParams.x;
                float z1 = uZoomParams.y;
                float z2 = uZoomParams.z;

                float zoomScale = h;
                if(uZoom >= z1 && uZoom < z2) {
                    zoomScale = h * (z1 / uZoom);
                } else if(uZoom >= z2) {
                    zoomScale = h * (z1 / z2);
                }

                // Calculate vector scale to fit in 1.0 x 1.0 box while keeping aspect ratio
                vec2 sizeScale;
                if(uRatio > 1.0) {
                    // Landscape: Width fixed to 1.0, Height reduces
                    sizeScale = vec2(1.0, 1.0 / uRatio);
                } else {
                    // Portrait/Square: Height fixed to 1.0, Width reduces
                    sizeScale = vec2(uRatio, 1.0);
                }

                // Apply specific X and Y scaling
                transformed.xy *= sizeScale * zoomScale;
                `).replace("#include <uv_vertex>",`#include <uv_vertex>
                 vRawUv = uv;`),e.fragmentShader=`
                varying vec2 vRawUv;
                uniform float uBorderWidth;
                uniform float uRatio;
                uniform vec3 uBorderColor;
                uniform float uRadius;

                float sdRoundedBox(vec2 p, vec2 b, float r) {
                    vec2 q = abs(p) - b + r;
                    return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r;
                }

                ${e.fragmentShader}
            `.replace("#include <map_fragment>",`
                vec2 dimensions;
                if(uRatio > 1.0) {
                    dimensions = vec2(1.0, 1.0 / uRatio);
                } else {
                    dimensions = vec2(uRatio, 1.0);
                }
                
                vec2 p = (vRawUv - 0.5) * dimensions;
                vec2 b = dimensions * 0.5;
                
                float d = sdRoundedBox(p, b, uRadius);
                
                float edgeSoftness = 0.002;
                float outsideMask = smoothstep(edgeSoftness, 0.0, d);
                float borderMask = smoothstep(edgeSoftness, 0.0, d + uBorderWidth);

                vec4 texelColor = texture2D( map, vRawUv );
                texelColor.rgb *= diffuse;

                vec3 finalRGB = mix(uBorderColor, texelColor.rgb, borderMask);
                
                diffuseColor = vec4(finalRGB, texelColor.a * outsideMask);
                `),this.userData.shader=e}}setZoomReference(t){this._zoomRef=t}setZoomParams(t){this._zoomParams.set(t.h,t.z1,t.z2)}setRatio(t){this._ratio.value=t}setRadius(t){this._radius.value=t}setBorder(t,e){this._borderWidth.value=t,this._borderColor.value=new Re(e)}}const Bn=new Nt(1,1),Gn=new Bt,Ze=1.5,Se=1,bt=2,Hn=.2,Nn=.005;class Zn{group;scene;baseImgUrl;animationMap=new Map;textureCache=new Map;zoomRef={value:1};zoomParams={h:1,z1:.2,z2:.8};currentHoveredId=null;constructor(t,e){this.scene=t,this.baseImgUrl=e,this.group=new Ps,this.scene.add(this.group)}updatePositions(){this.animationMap.forEach(t=>{const e=t.point;t.mesh.position.set(e.x,e.y,Ze),t.mesh.scale.set(t.currentScale,t.currentScale,1)})}updateTints(){this.animationMap.forEach(t=>{t.mesh.material.color.set(t.point.tint||"#FFFFFF")})}updateBorder(){this.animationMap.forEach(t=>{const e=t.mesh.material;e.setBorder&&e.setBorder(t.point.border,t.point.borderColor)})}setZoomReference(t){this.zoomRef=t}show(t){t.sort((o,s)=>s.order-o.order);const e=new Set(t.map(o=>o.id));this.animationMap.forEach((o,s)=>{o.isInShowList=e.has(s)}),this.cleanupUnusedImages(),t.forEach(o=>{this.animationMap.has(o.id)?(this.animationMap.get(o.id).point=o,this.updateImagePosition(o)):this.createImage(o)}),this.setZoomParams(this.zoomParams),this.updateTints(),this.updateBorder()}cleanupUnusedImages(){this.animationMap.forEach((t,e)=>{const o=Math.abs(t.targetScale-t.currentScale)>Nn;!t.isInShowList&&!t.isHovered&&!o&&this.removeImage(e)})}getResolutionUrl(t){const e=this.zoomRef.value>7?"large":"medium";return`${this.baseImgUrl}${e}/${t}`}createImage(t){const e=this.getResolutionUrl(t.sha1);this.textureCache.has(e)?this.setupMesh(t,this.textureCache.get(e)):Gn.load(e,o=>{o.colorSpace=lt,this.textureCache.set(e,o),this.group.parent&&this.setupMesh(t,o)})}setupMesh(t,e){if(this.animationMap.has(t.id))return;const o=new Dn({map:e,transparent:!0,side:Gt});o.setZoomReference(this.zoomRef),o.setBorder(t.border,t.borderColor),o.setRatio(t.ratio);const s=new Ht(Bn,o);s.position.set(t.x,t.y,Ze),s.renderOrder=2e3+(t.order||0),s.scale.set(1,1,1),this.group.add(s);const l=this.currentHoveredId===t.id;this.animationMap.set(t.id,{mesh:s,point:t,currentScale:Se,targetScale:l?bt:Se,isHovered:l,isInShowList:!0}),l&&(s.renderOrder=Number.MAX_SAFE_INTEGER)}updateImagePosition(t){const e=this.animationMap.get(t.id);e&&e.mesh.position.set(t.x,t.y,Ze)}hover(t){this.currentHoveredId=t.id,this.animationMap.forEach((e,o)=>{o===t.id?(e.isHovered=!0,e.targetScale=bt,e.mesh.renderOrder=Number.MAX_SAFE_INTEGER):e.isHovered&&(e.isHovered=!1,e.targetScale=Se,e.mesh.renderOrder=2e3+(e.point.order||0))}),this.animationMap.has(t.id)||this.createImage(t)}unhover(){this.currentHoveredId=null,this.animationMap.forEach(t=>{t.isHovered&&(t.isHovered=!1,t.targetScale=Se,t.mesh.renderOrder=2e3+(t.point.order||0))})}updateAnimations(){let t=!1;this.animationMap.forEach(e=>{const o=e.targetScale-e.currentScale;Math.abs(o)>.001?(e.currentScale+=o*Hn,e.mesh.scale.set(e.currentScale,e.currentScale,1)):!e.isInShowList&&!e.isHovered&&(t=!0)}),t&&this.cleanupUnusedImages()}removeImage(t){const e=this.animationMap.get(t);e&&(this.group.remove(e.mesh),Array.isArray(e.mesh.material)?e.mesh.material.forEach(o=>o.dispose()):e.mesh.material.dispose(),this.animationMap.delete(t))}setZoomParams(t){this.zoomParams=t,this.animationMap.forEach(e=>{const o=e.mesh.material;o.setZoomParams&&o.setZoomParams(t)})}dispose(){Array.from(this.animationMap.keys()).forEach(e=>this.removeImage(e)),this.group.clear(),this.textureCache.forEach(e=>e.dispose()),this.textureCache.clear(),this.scene.remove(this.group)}}class Wn extends rt{_zoomRef={value:1};_zoomParams=new Ee(1,.1,.8);_radius={value:.05};_showAsPoint={value:0};constructor(t,e,o){super(t),this.onBeforeCompile=s=>{s.uniforms.uGridCols={value:e},s.uniforms.uGridRows={value:o},s.uniforms.uRadius=this._radius,s.uniforms.uZoom=this._zoomRef,s.uniforms.uZoomParams={value:this._zoomParams},s.uniforms.uShowAsPoint=this._showAsPoint,s.vertexShader=`
                attribute vec2 vOffset;
                attribute vec4 vUvTransform; 
                attribute vec4 vTint;
                attribute vec3 vBorderCol;
                attribute float vBorderWidth;
                attribute float vRatioAttr;

                varying vec2 vMappedUv;
                varying vec2 vRawUv; 
                varying vec4 vInstanceTint;
                varying vec3 vInstanceBorder;
                varying float vInstanceBorderWidth;
                varying float vRatio; 

                uniform float uGridCols;
                uniform float uGridRows;
                uniform float uZoom;
                uniform vec3 uZoomParams;
                uniform float uShowAsPoint;

                ${s.vertexShader}
            `.replace("#include <begin_vertex>",`
                vec3 transformed = vec3( position );
                float h  = uZoomParams.x;
                float z1 = uZoomParams.y;
                float z2 = uZoomParams.z;

                // Use the attribute directly
                vRatio = vRatioAttr; 

                // When showing as point, use uniform 1:1 scale
                if(uShowAsPoint > 0.5) {
                    // Point size is always h/uZoom for consistent sizing
                    float pointScale = h/10.0 / uZoom;
                    transformed.xy *= pointScale;
                } else {
                    // Normal image rendering with zoom scaling
                    float zoomScale = h;
                    if(uZoom >= z1 && uZoom < z2) {
                        zoomScale = h * (z1 / uZoom);
                    } else if(uZoom >= z2) {
                        zoomScale = h * (z1 / z2);
                    }

                    // FIT LOGIC: Calculate scale to fit in 1.0 x 1.0 box
                    vec2 sizeScale;
                    if(vRatio > 1.0) {
                        // Landscape: Width is 1.0, Height is 1/Ratio
                        sizeScale = vec2(1.0, 1.0 / vRatio);
                    } else {
                        // Portrait: Height is 1.0, Width is Ratio
                        sizeScale = vec2(vRatio, 1.0);
                    }
                    if(uZoom < z1/2.0) {
                        sizeScale = vec2(1.0, 1.0);
                    }

                    transformed.xy *= sizeScale * zoomScale;
                }
                `).replace("#include <uv_vertex>",`
                #include <uv_vertex>
                vRawUv = uv;
                
                float margin = 0.0005; 
                vec2 safeUv = mix(vec2(margin), vec2(1.0 - margin), uv);
                vec2 correctedUv = safeUv * vUvTransform.xy + vUvTransform.zw;
                vMappedUv = (correctedUv / vec2(uGridCols, uGridRows)) + vOffset;
                
                vInstanceTint = vTint;
                vInstanceBorder = vBorderCol;
                vInstanceBorderWidth = vBorderWidth;
                `),s.fragmentShader=`
                varying vec2 vMappedUv;
                varying vec2 vRawUv;
                varying vec4 vInstanceTint;
                varying vec3 vInstanceBorder;
                varying float vInstanceBorderWidth;
                varying float vRatio;

                uniform float uRadius;
                uniform float uShowAsPoint;

                float sdRoundedBox(vec2 p, vec2 b, float r) {
                    vec2 q = abs(p) - b + r;
                    return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r;
                }

                ${s.fragmentShader}
            `.replace("#include <map_fragment>",`
                // If showing as point, render a colored circle
                if(uShowAsPoint > 0.5) {
    vec2 p = vRawUv - 0.5;
    float dist = length(p);
    
    // Use a larger radius (0.5 fills the square) to ensure visibility
    float pointRadius = 0.45; 
    float aa = 0.1; // Softer edge for points
    float pointMask = smoothstep(pointRadius + aa, pointRadius, dist);
    
    // Instead of multiplying, use the logic from your image mode:
    // This ensures that if it's visible in image mode, it's visible here.
    vec3 finalRGB = mix(vInstanceBorder, vInstanceTint.rgb, vInstanceTint.a);
    
    // Use 1.0 instead of texelColor.a since there is no texture
    diffuseColor = vec4(finalRGB, pointMask); 
} else {
                    // Normal image rendering
                    vec2 dimensions;
                    if(vRatio > 1.0) {
                        dimensions = vec2(1.0, 1.0 / vRatio);
                    } else {
                        dimensions = vec2(vRatio, 1.0);
                    }
                    
                    vec2 p = (vRawUv - 0.5) * dimensions;
                    vec2 b = dimensions * 0.5;
                    
                    float d = sdRoundedBox(p, b, uRadius);
                    
                    float aa = 0.002; 
                    float outsideMask = smoothstep(aa, 0.0, d);
                    float borderMask = smoothstep(aa, 0.0, d + vInstanceBorderWidth);

                    vec4 texelColor = texture2D( map, vMappedUv );
                    
                    // Mix between original texture and tint color based on tint alpha
                    vec3 tintedColor = mix(texelColor.rgb, vInstanceTint.rgb, vInstanceTint.a);
                    vec3 tintedBorderColor = mix(vInstanceBorder.rgb, vInstanceTint.rgb, vInstanceTint.a);

                    vec3 finalRGB = mix(tintedBorderColor, tintedColor, borderMask);
                    diffuseColor = vec4(finalRGB, texelColor.a * outsideMask);
                }
                `),this.userData.shader=s}}setRadius(t){this._radius.value=t,this.userData.shader&&(this.userData.shader.uniforms.uRadius.value=t)}setZoomParams(t){this._zoomParams.set(t.h,t.z1,t.z2),this.userData.shader&&(this.userData.shader.uniforms.uZoomParams.value=this._zoomParams)}setZoomReference(t){this._zoomRef=t,this.userData.shader&&(this.userData.shader.uniforms.uZoom=t)}setShowAsPoint(t){this._showAsPoint.value=t?1:0,this.userData.shader&&(this.userData.shader.uniforms.uShowAsPoint.value=this._showAsPoint.value)}}class qn{mesh;geometry;material;points;atlas;matrixHelper=new zs;colorHelper=new Re;constructor(t,e,o,s){this.points=o,this.atlas=t;const l=t.width/t.cellWidth,v=t.height/t.cellHeight,h=o.length;this.geometry=new Nt(1,1),this.material=new Wn({map:e,transparent:!0,alphaTest:.1,depthTest:!0,depthWrite:!0},l,v),this.mesh=new Es(this.geometry,this.material,h),this.geometry.setAttribute("vOffset",new fe(new Float32Array(h*2),2)),this.geometry.setAttribute("vUvTransform",new fe(new Float32Array(h*4),4)),this.geometry.setAttribute("vTint",new fe(new Float32Array(h*4),4)),this.geometry.setAttribute("vBorderCol",new fe(new Float32Array(h*3),3)),this.geometry.setAttribute("vBorderWidth",new fe(new Float32Array(h),1)),this.geometry.setAttribute("vRatioAttr",new fe(new Float32Array(h),1)),this.updateUVsAndOffsets(),this.updatePositions(),this.updateRatios(),this.updateTints(),this.updateBorderColors(),this.updateBorderWidths(),this.mesh.frustumCulled=!1,this.mesh.matrixAutoUpdate=!1,this.mesh.updateMatrixWorld(!0)}updatePositions(){this.points.forEach((t,e)=>{this.matrixHelper.makeScale(1,1,1),this.matrixHelper.setPosition(t.x,t.y,t.z),this.mesh.setMatrixAt(e,this.matrixHelper)}),this.mesh.instanceMatrix.needsUpdate=!0}updateRatios(){const t=this.geometry.getAttribute("vRatioAttr"),e=t.array;this.points.forEach((o,s)=>{e[s]=o.ratio}),t.needsUpdate=!0}updateTints(){const t=this.geometry.getAttribute("vTint"),e=t.array;this.points.forEach((o,s)=>{this.colorHelper.set(o.tint||"#FFFFFF"),e[s*4]=this.colorHelper.r,e[s*4+1]=this.colorHelper.g,e[s*4+2]=this.colorHelper.b,e[s*4+3]=o.tintAlpha??0}),t.needsUpdate=!0}updateBorderColors(){const t=this.geometry.getAttribute("vBorderCol"),e=t.array;this.points.forEach((o,s)=>{this.colorHelper.set(o.borderColor||"#000000"),e[s*3]=this.colorHelper.r,e[s*3+1]=this.colorHelper.g,e[s*3+2]=this.colorHelper.b}),t.needsUpdate=!0}updateBorderWidths(){const t=this.geometry.getAttribute("vBorderWidth"),e=t.array;this.points.forEach((o,s)=>{e[s]=o.border??0}),t.needsUpdate=!0}updateUVsAndOffsets(){const t=this.atlas.width/this.atlas.cellWidth,e=this.atlas.height/this.atlas.cellHeight,o=this.atlas.cellWidth/this.atlas.cellHeight,s=.5,l=s/this.atlas.width*t,v=s/this.atlas.height*e,h=this.geometry.getAttribute("vOffset"),p=this.geometry.getAttribute("vUvTransform"),n=h.array,i=p.array;this.points.forEach((c,u)=>{const _=this.atlas.sha1Mapping[c.sha1];if(_){const P=_[1];n[u*2]=P%t/t,n[u*2+1]=(e-1-Math.floor(P/t))/e}const $=c.ratio;let z=1,M=1;$>o?M=o/$:z=$/o,i[u*4]=z-l*2,i[u*4+1]=M-v*2,i[u*4+2]=(1-z)*.5+l,i[u*4+3]=(1-M)*.5+v}),h.needsUpdate=!0,p.needsUpdate=!0}setZoomReference(t){this.material.setZoomReference(t)}setZoomParams(t){this.material.setZoomParams(t)}setShowAsPoint(t){this.material.setShowAsPoint(t)}dispose(){this.geometry.dispose(),this.material.dispose(),this.mesh.dispose()}}class ue{scene;layers=[];_isVisible=!0;_zoomParams;static textureCache=new Map;currentAtlasId=null;constructor(t){this.scene=t}getCacheKey(t,e){return`${t}_${e}`}async loadLayers(t,e,o,s,l){this.currentAtlasId,t.id,this.disposeLayers(),this.currentAtlasId=t.id;const v=new Bt,h=Array.from({length:t.atlasNb},()=>[]);for(let n of e){if(!t.sha1Mapping[n.sha1])continue;let i=t.sha1Mapping[n.sha1][0];h[i].push(n)}let p=Math.max(...h.map(n=>n.length));for(let n=0;n<t.atlasNb;n++){const i=h[n];if(i.length===0)continue;const c=this.getCacheKey(t.id,n),u=`${o}atlas_sheet/${t.id}/${n}`;i.forEach((_,$)=>_.order=n*p+$);try{let _;ue.textureCache.has(c)?_=ue.textureCache.get(c):(_=await v.loadAsync(u),_.colorSpace=lt,_.generateMipmaps=!0,_.minFilter=Rs,ue.textureCache.set(c,_));const $=new qn(t,_,i,n);$.setZoomReference(s),$.mesh.visible=this._isVisible,$.setZoomParams(this._zoomParams),$.setShowAsPoint(l),this.layers.push($),this.scene.add($.mesh)}catch(_){console.error(`Failed to load atlas sheet ${n}:`,_)}}}show(){this._isVisible=!0,this.layers.forEach(t=>t.mesh.visible=!0)}hide(){this._isVisible=!1,this.layers.forEach(t=>t.mesh.visible=!1)}disposeLayers(){this.layers.forEach(t=>{this.scene.remove(t.mesh),t.dispose()}),this.layers=[]}dispose(){this.disposeLayers()}static clearTextureCache(){ue.textureCache.forEach(t=>{t.dispose()}),ue.textureCache.clear()}static clearAtlasFromCache(t){const e=[];ue.textureCache.forEach((o,s)=>{s.startsWith(`${t}_`)&&(o.dispose(),e.push(s))}),e.forEach(o=>ue.textureCache.delete(o))}setZoomParams(t){this._zoomParams=t,this.layers.forEach(e=>e.setZoomParams(t))}updateTints(){this.layers.forEach(t=>t.updateTints())}updateBorderColors(){this.layers.forEach(t=>t.updateBorderColors())}updatePositions(){this.layers.forEach(t=>t.updatePositions())}updateBorderWidths(){this.layers.forEach(t=>t.updateBorderWidths())}setShowAsPoint(t){this.layers.forEach(e=>e.setShowAsPoint(t))}}var We,_t;function Yn(){if(_t)return We;_t=1,We=s;function S(l,v){var h=l.x-v.x,p=l.y-v.y;return h*h+p*p}function t(l,v,h){var p=v.x,n=v.y,i=h.x-p,c=h.y-n,u;return(i!==0||c!==0)&&(u=((l.x-p)*i+(l.y-n)*c)/(i*i+c*c),u>1?(p=h.x,n=h.y):u>0&&(p+=i*u,n+=c*u)),i=l.x-p,c=l.y-n,i*i+c*c}function e(l,v){var h,p=l.length,n,i=l[0],c=[i];for(h=1;h<p;h++)n=l[h],S(n,i)>v&&(c.push(n),i=n);return i!==n&&c.push(n),c}function o(l,v){var h=l.length,p=typeof Uint8Array<"u"?Uint8Array:Array,n=new p(h),i=0,c=h-1,u,_,$,z,M=[],P=[],C=[];for(n[i]=n[c]=1;c;){for(_=0,u=i+1;u<c;u++)$=t(l[u],l[i],l[c]),$>_&&(z=u,_=$);_>v&&(n[z]=1,M.push(i),P.push(z),M.push(z),P.push(c)),i=M.pop(),c=P.pop()}for(u=0;u<h;u++)n[u]&&C.push(l[u]);return C}function s(l,v,h){var p=v!==void 0?v*v:1;return h||(l=e(l,p)),l=o(l,p),l}return We}var Xn=Yn();const jn=Ut(Xn);var qe={exports:{}},Ye,xt;function jt(){if(xt)return Ye;xt=1,Ye=t;var S=+(Math.pow(2,27)+1);function t(e,o,s){var l=e*o,v=S*e,h=v-e,p=v-h,n=e-p,i=S*o,c=i-o,u=i-c,_=o-u,$=l-p*u,z=$-n*u,M=z-p*_,P=n*_-M;return s?(s[0]=P,s[1]=l,s):[P,l]}return Ye}var Xe,wt;function Kn(){if(wt)return Xe;wt=1,Xe=t;function S(e,o){var s=e+o,l=s-e,v=s-l,h=o-l,p=e-v,n=p+h;return n?[n,s]:[s]}function t(e,o){var s=e.length|0,l=o.length|0;if(s===1&&l===1)return S(e[0],o[0]);var v=s+l,h=new Array(v),p=0,n=0,i=0,c=Math.abs,u=e[n],_=c(u),$=o[i],z=c($),M,P;_<z?(P=u,n+=1,n<s&&(u=e[n],_=c(u))):(P=$,i+=1,i<l&&($=o[i],z=c($))),n<s&&_<z||i>=l?(M=u,n+=1,n<s&&(u=e[n],_=c(u))):(M=$,i+=1,i<l&&($=o[i],z=c($)));for(var C=M+P,r=C-M,d=P-r,w=d,O=C,L,y,b,f,g;n<s&&i<l;)_<z?(M=u,n+=1,n<s&&(u=e[n],_=c(u))):(M=$,i+=1,i<l&&($=o[i],z=c($))),P=w,C=M+P,r=C-M,d=P-r,d&&(h[p++]=d),L=O+C,y=L-O,b=L-y,f=C-y,g=O-b,w=g+f,O=L;for(;n<s;)M=u,P=w,C=M+P,r=C-M,d=P-r,d&&(h[p++]=d),L=O+C,y=L-O,b=L-y,f=C-y,g=O-b,w=g+f,O=L,n+=1,n<s&&(u=e[n]);for(;i<l;)M=$,P=w,C=M+P,r=C-M,d=P-r,d&&(h[p++]=d),L=O+C,y=L-O,b=L-y,f=C-y,g=O-b,w=g+f,O=L,i+=1,i<l&&($=o[i]);return w&&(h[p++]=w),O&&(h[p++]=O),p||(h[p++]=0),h.length=p,h}return Xe}var je,kt;function Qn(){if(kt)return je;kt=1,je=S;function S(t,e,o){var s=t+e,l=s-t,v=s-l,h=e-l,p=t-v;return o?(o[0]=p+h,o[1]=s,o):[p+h,s]}return je}var Ke,$t;function Jn(){if($t)return Ke;$t=1;var S=jt(),t=Qn();Ke=e;function e(o,s){var l=o.length;if(l===1){var v=S(o[0],s);return v[0]?v:[v[1]]}var h=new Array(2*l),p=[.1,.1],n=[.1,.1],i=0;S(o[0],s,p),p[0]&&(h[i++]=p[0]);for(var c=1;c<l;++c){S(o[c],s,n);var u=p[1];t(u,n[0],p),p[0]&&(h[i++]=p[0]);var _=n[1],$=p[1],z=_+$,M=z-_,P=$-M;p[1]=z,P&&(h[i++]=P)}return p[1]&&(h[i++]=p[1]),i===0&&(h[i++]=0),h.length=i,h}return Ke}var Qe,Mt;function er(){if(Mt)return Qe;Mt=1,Qe=t;function S(e,o){var s=e+o,l=s-e,v=s-l,h=o-l,p=e-v,n=p+h;return n?[n,s]:[s]}function t(e,o){var s=e.length|0,l=o.length|0;if(s===1&&l===1)return S(e[0],-o[0]);var v=s+l,h=new Array(v),p=0,n=0,i=0,c=Math.abs,u=e[n],_=c(u),$=-o[i],z=c($),M,P;_<z?(P=u,n+=1,n<s&&(u=e[n],_=c(u))):(P=$,i+=1,i<l&&($=-o[i],z=c($))),n<s&&_<z||i>=l?(M=u,n+=1,n<s&&(u=e[n],_=c(u))):(M=$,i+=1,i<l&&($=-o[i],z=c($)));for(var C=M+P,r=C-M,d=P-r,w=d,O=C,L,y,b,f,g;n<s&&i<l;)_<z?(M=u,n+=1,n<s&&(u=e[n],_=c(u))):(M=$,i+=1,i<l&&($=-o[i],z=c($))),P=w,C=M+P,r=C-M,d=P-r,d&&(h[p++]=d),L=O+C,y=L-O,b=L-y,f=C-y,g=O-b,w=g+f,O=L;for(;n<s;)M=u,P=w,C=M+P,r=C-M,d=P-r,d&&(h[p++]=d),L=O+C,y=L-O,b=L-y,f=C-y,g=O-b,w=g+f,O=L,n+=1,n<s&&(u=e[n]);for(;i<l;)M=$,P=w,C=M+P,r=C-M,d=P-r,d&&(h[p++]=d),L=O+C,y=L-O,b=L-y,f=C-y,g=O-b,w=g+f,O=L,i+=1,i<l&&($=-o[i]);return w&&(h[p++]=w),O&&(h[p++]=O),p||(h[p++]=0),h.length=p,h}return Qe}var St;function tr(){return St||(St=1,function(S){var t=jt(),e=Kn(),o=Jn(),s=er(),l=5,v=11102230246251565e-32,h=(3+16*v)*v,p=(7+56*v)*v;function n(r,d,w,O){return function(y,b,f){var g=r(r(d(b[1],f[0]),d(-f[1],b[0])),r(d(y[1],b[0]),d(-b[1],y[0]))),k=r(d(y[1],f[0]),d(-f[1],y[0])),D=O(g,k);return D[D.length-1]}}function i(r,d,w,O){return function(y,b,f,g){var k=r(r(w(r(d(f[1],g[0]),d(-g[1],f[0])),b[2]),r(w(r(d(b[1],g[0]),d(-g[1],b[0])),-f[2]),w(r(d(b[1],f[0]),d(-f[1],b[0])),g[2]))),r(w(r(d(b[1],g[0]),d(-g[1],b[0])),y[2]),r(w(r(d(y[1],g[0]),d(-g[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),g[2])))),D=r(r(w(r(d(f[1],g[0]),d(-g[1],f[0])),y[2]),r(w(r(d(y[1],g[0]),d(-g[1],y[0])),-f[2]),w(r(d(y[1],f[0]),d(-f[1],y[0])),g[2]))),r(w(r(d(b[1],f[0]),d(-f[1],b[0])),y[2]),r(w(r(d(y[1],f[0]),d(-f[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),f[2])))),B=O(k,D);return B[B.length-1]}}function c(r,d,w,O){return function(y,b,f,g,k){var D=r(r(r(w(r(w(r(d(g[1],k[0]),d(-k[1],g[0])),f[2]),r(w(r(d(f[1],k[0]),d(-k[1],f[0])),-g[2]),w(r(d(f[1],g[0]),d(-g[1],f[0])),k[2]))),b[3]),r(w(r(w(r(d(g[1],k[0]),d(-k[1],g[0])),b[2]),r(w(r(d(b[1],k[0]),d(-k[1],b[0])),-g[2]),w(r(d(b[1],g[0]),d(-g[1],b[0])),k[2]))),-f[3]),w(r(w(r(d(f[1],k[0]),d(-k[1],f[0])),b[2]),r(w(r(d(b[1],k[0]),d(-k[1],b[0])),-f[2]),w(r(d(b[1],f[0]),d(-f[1],b[0])),k[2]))),g[3]))),r(w(r(w(r(d(f[1],g[0]),d(-g[1],f[0])),b[2]),r(w(r(d(b[1],g[0]),d(-g[1],b[0])),-f[2]),w(r(d(b[1],f[0]),d(-f[1],b[0])),g[2]))),-k[3]),r(w(r(w(r(d(g[1],k[0]),d(-k[1],g[0])),b[2]),r(w(r(d(b[1],k[0]),d(-k[1],b[0])),-g[2]),w(r(d(b[1],g[0]),d(-g[1],b[0])),k[2]))),y[3]),w(r(w(r(d(g[1],k[0]),d(-k[1],g[0])),y[2]),r(w(r(d(y[1],k[0]),d(-k[1],y[0])),-g[2]),w(r(d(y[1],g[0]),d(-g[1],y[0])),k[2]))),-b[3])))),r(r(w(r(w(r(d(b[1],k[0]),d(-k[1],b[0])),y[2]),r(w(r(d(y[1],k[0]),d(-k[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),k[2]))),g[3]),r(w(r(w(r(d(b[1],g[0]),d(-g[1],b[0])),y[2]),r(w(r(d(y[1],g[0]),d(-g[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),g[2]))),-k[3]),w(r(w(r(d(f[1],g[0]),d(-g[1],f[0])),b[2]),r(w(r(d(b[1],g[0]),d(-g[1],b[0])),-f[2]),w(r(d(b[1],f[0]),d(-f[1],b[0])),g[2]))),y[3]))),r(w(r(w(r(d(f[1],g[0]),d(-g[1],f[0])),y[2]),r(w(r(d(y[1],g[0]),d(-g[1],y[0])),-f[2]),w(r(d(y[1],f[0]),d(-f[1],y[0])),g[2]))),-b[3]),r(w(r(w(r(d(b[1],g[0]),d(-g[1],b[0])),y[2]),r(w(r(d(y[1],g[0]),d(-g[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),g[2]))),f[3]),w(r(w(r(d(b[1],f[0]),d(-f[1],b[0])),y[2]),r(w(r(d(y[1],f[0]),d(-f[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),f[2]))),-g[3]))))),B=r(r(r(w(r(w(r(d(g[1],k[0]),d(-k[1],g[0])),f[2]),r(w(r(d(f[1],k[0]),d(-k[1],f[0])),-g[2]),w(r(d(f[1],g[0]),d(-g[1],f[0])),k[2]))),y[3]),w(r(w(r(d(g[1],k[0]),d(-k[1],g[0])),y[2]),r(w(r(d(y[1],k[0]),d(-k[1],y[0])),-g[2]),w(r(d(y[1],g[0]),d(-g[1],y[0])),k[2]))),-f[3])),r(w(r(w(r(d(f[1],k[0]),d(-k[1],f[0])),y[2]),r(w(r(d(y[1],k[0]),d(-k[1],y[0])),-f[2]),w(r(d(y[1],f[0]),d(-f[1],y[0])),k[2]))),g[3]),w(r(w(r(d(f[1],g[0]),d(-g[1],f[0])),y[2]),r(w(r(d(y[1],g[0]),d(-g[1],y[0])),-f[2]),w(r(d(y[1],f[0]),d(-f[1],y[0])),g[2]))),-k[3]))),r(r(w(r(w(r(d(f[1],k[0]),d(-k[1],f[0])),b[2]),r(w(r(d(b[1],k[0]),d(-k[1],b[0])),-f[2]),w(r(d(b[1],f[0]),d(-f[1],b[0])),k[2]))),y[3]),w(r(w(r(d(f[1],k[0]),d(-k[1],f[0])),y[2]),r(w(r(d(y[1],k[0]),d(-k[1],y[0])),-f[2]),w(r(d(y[1],f[0]),d(-f[1],y[0])),k[2]))),-b[3])),r(w(r(w(r(d(b[1],k[0]),d(-k[1],b[0])),y[2]),r(w(r(d(y[1],k[0]),d(-k[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),k[2]))),f[3]),w(r(w(r(d(b[1],f[0]),d(-f[1],b[0])),y[2]),r(w(r(d(y[1],f[0]),d(-f[1],y[0])),-b[2]),w(r(d(y[1],b[0]),d(-b[1],y[0])),f[2]))),-k[3])))),K=O(D,B);return K[K.length-1]}}function u(r){var d=r===3?n:r===4?i:c;return d(e,t,o,s)}var _=u(3),$=u(4),z=[function(){return 0},function(){return 0},function(d,w){return w[0]-d[0]},function(d,w,O){var L=(d[1]-O[1])*(w[0]-O[0]),y=(d[0]-O[0])*(w[1]-O[1]),b=L-y,f;if(L>0){if(y<=0)return b;f=L+y}else if(L<0){if(y>=0)return b;f=-(L+y)}else return b;var g=h*f;return b>=g||b<=-g?b:_(d,w,O)},function(d,w,O,L){var y=d[0]-L[0],b=w[0]-L[0],f=O[0]-L[0],g=d[1]-L[1],k=w[1]-L[1],D=O[1]-L[1],B=d[2]-L[2],K=w[2]-L[2],Z=O[2]-L[2],Q=b*D,ae=f*k,ee=f*g,Me=y*D,ce=y*k,_e=b*g,Fe=B*(Q-ae)+K*(ee-Me)+Z*(ce-_e),Kt=(Math.abs(Q)+Math.abs(ae))*Math.abs(B)+(Math.abs(ee)+Math.abs(Me))*Math.abs(K)+(Math.abs(ce)+Math.abs(_e))*Math.abs(Z),dt=p*Kt;return Fe>dt||-Fe>dt?Fe:$(d,w,O,L)}];function M(r){var d=z[r.length];return d||(d=z[r.length]=u(r.length)),d.apply(void 0,r)}function P(r,d,w,O,L,y,b){return function(g,k,D,B,K){switch(arguments.length){case 0:case 1:return 0;case 2:return O(g,k);case 3:return L(g,k,D);case 4:return y(g,k,D,B);case 5:return b(g,k,D,B,K)}for(var Z=new Array(arguments.length),Q=0;Q<arguments.length;++Q)Z[Q]=arguments[Q];return r(Z)}}function C(){for(;z.length<=l;)z.push(u(z.length));S.exports=P.apply(void 0,[M].concat(z));for(var r=0;r<=l;++r)S.exports[r]=z[r]}C()}(qe)),qe.exports}var Je,It;function sr(){if(It)return Je;It=1,Je=t;var S=tr();function t(e,o){for(var s=o[0],l=o[1],v=e.length,h=1,p=v,n=0,i=v-1;n<p;i=n++){var c=e[n],u=e[i],_=c[1],$=u[1];if($<_){if($<l&&l<_){var z=S(c,u,o);if(z===0)return 0;h^=0<z|0}else if(l===_){var M=e[(n+1)%v],P=M[1];if(_<P){var z=S(c,u,o);if(z===0)return 0;h^=0<z|0}}}else if(_<$){if(_<l&&l<$){var z=S(c,u,o);if(z===0)return 0;h^=z<0|0}else if(l===_){var M=e[(n+1)%v],P=M[1];if(P<_){var z=S(c,u,o);if(z===0)return 0;h^=z<0|0}}}else if(l===_){var C=Math.min(c[0],u[0]),r=Math.max(c[0],u[0]);if(n===0){for(;i>0;){var d=(i+v-1)%v,w=e[d];if(w[1]!==l)break;var O=w[0];C=Math.min(C,O),r=Math.max(r,O),i=d}if(i===0)return C<=s&&s<=r?0:1;p=i+1}for(var L=e[(i+v-1)%v][1];n+1<p;){var w=e[n+1];if(w[1]!==l)break;var O=w[0];C=Math.min(C,O),r=Math.max(r,O),n+=1}if(C<=s&&s<=r)return 0;var y=e[(n+1)%v][1];s<C&&L<l!=y<l&&(h^=1)}}return 2*h-1}return Je}var or=sr();const ar=Ut(or);class ir{scene;spatialIndex;onLassoComplete;lassoPoints=[];lastScreenPos=null;lassoMesh=null;lassoLine=null;clearTimeoutId=null;FILL_COLOR=43775;FILL_OPACITY=.3;STROKE_COLOR=30668;MIN_PIXEL_DIST_SQ=100;CURVE_TENSION=.5;SMOOTHNESS_MULTIPLIER=10;constructor(t,e,o){this.scene=t,this.spatialIndex=e,this.onLassoComplete=o}initMesh(){if(!this.lassoMesh){const t=new rt({color:this.FILL_COLOR,transparent:!0,opacity:this.FILL_OPACITY,side:Gt,depthTest:!1});this.lassoMesh=new Ht(new De,t),this.lassoMesh.renderOrder=999,this.scene.add(this.lassoMesh)}if(!this.lassoLine){const t=new Ts({color:this.STROKE_COLOR,depthTest:!1});this.lassoLine=new Ls(new De,t),this.lassoLine.renderOrder=999,this.scene.add(this.lassoLine)}}start(t,e){this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.initMesh(),this.lassoPoints=[t],this.lastScreenPos=e,this.lassoMesh&&(this.lassoMesh.visible=!0),this.lassoLine&&(this.lassoLine.visible=!0),this.updateGeometry()}move(t,e){if(this.lassoPoints.length===0||!this.lastScreenPos)return;const o=e.x-this.lastScreenPos.x,s=e.y-this.lastScreenPos.y;o*o+s*s<this.MIN_PIXEL_DIST_SQ||(this.lassoPoints.push(t),this.lastScreenPos=e,this.updateGeometry())}end(){if(this.lassoPoints.length<3){this.clear();return}const t=this.updateGeometry(!0);this.computeSelectedPoints(t),this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.clear()}updateGeometry(t=!1){if(!this.lassoMesh||!this.lassoLine||this.lassoPoints.length===0)return[];let e=[];if(this.lassoPoints.length>2){const s=new As(this.lassoPoints);s.closed=t,s.curveType="centripetal",s.tension=this.CURVE_TENSION;const l=this.lassoPoints.length*this.SMOOTHNESS_MULTIPLIER;e=s.getPoints(l)}else e=[...this.lassoPoints],t&&e.push(this.lassoPoints[0]);const o=new Os;if(e.length>0){o.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)o.lineTo(e[s].x,e[s].y)}return this.lassoMesh.geometry.dispose(),this.lassoMesh.geometry=new Vs(o),this.lassoLine.geometry.dispose(),this.lassoLine.geometry=new De().setFromPoints(e),e}clear(){this.lassoMesh&&(this.lassoMesh.visible=!1,this.lassoMesh.geometry&&this.lassoMesh.geometry.dispose()),this.lassoLine&&(this.lassoLine.visible=!1,this.lassoLine.geometry&&this.lassoLine.geometry.dispose()),this.lassoPoints=[],this.lastScreenPos=null}computeSelectedPoints(t){const e=jn(t,.1),o=ys(e),s=this.spatialIndex.getPointsInRect(o),l=e.map(h=>[h.x,h.y]),v=s.filter(h=>ar(l,[h.x,h.y])<=0);this.onLassoComplete(v)}dispose(){this.clearTimeoutId&&clearTimeout(this.clearTimeoutId),this.lassoMesh&&(this.scene.remove(this.lassoMesh),this.lassoMesh.geometry&&this.lassoMesh.geometry.dispose(),this.lassoMesh.material instanceof ft&&this.lassoMesh.material.dispose(),this.lassoMesh=null),this.lassoLine&&(this.scene.remove(this.lassoLine),this.lassoLine.geometry&&this.lassoLine.geometry.dispose(),this.lassoLine.material instanceof ft&&this.lassoLine.material.dispose(),this.lassoLine=null)}}class nr{container;scene;camera;renderer;controls;requestID=null;resizeObserver;frustumSize=20;zoomParams={h:5,z1:.1,z2:.5};atlasLayers;hdLayer;lassoLayer;spatialIndex=new Un;globalUniforms={uZoom:{value:1}};onPointSelection=null;onHover=new bs;constructor(t,e){this.container=t,this.scene=new Fs,this.scene.background=new Re(16777215),this.initCamera(),this.initRenderer(),this.atlasLayers=new ue(this.scene),this.atlasLayers.setZoomParams(this.zoomParams),this.hdLayer=new Zn(this.scene,e),this.hdLayer.setZoomReference(this.globalUniforms.uZoom),this.hdLayer.setZoomParams(this.zoomParams),this.lassoLayer=new ir(this.scene,this.spatialIndex,o=>{this.onPointSelection&&this.onPointSelection(o)}),this.controls=new Fn(this.camera,this.renderer.domElement,this.lassoLayer,this.spatialIndex),this.resizeObserver=new ResizeObserver(()=>this.onResize()),this.resizeObserver.observe(this.container),this.animate()}initCamera(){const t=this.container.clientWidth/this.container.clientHeight;this.camera=new Us(this.frustumSize*t/-2,this.frustumSize*t/2,this.frustumSize/2,this.frustumSize/-2,.1,1e3),this.camera.position.z=10,this.camera.zoom=.08,this.camera.updateProjectionMatrix(),this.globalUniforms.uZoom.value=this.camera.zoom}initRenderer(){this.renderer=new Ds({antialias:!0,alpha:!1,powerPreference:"high-performance"}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.outputColorSpace=lt,this.renderer.setClearColor(16777215,1),this.container.appendChild(this.renderer.domElement)}async createMap(t,e,o){const s=X();this.spatialIndex.initTree(e),await this.atlasLayers.loadLayers(t,e,s.baseUrl,this.globalUniforms.uZoom,o)}animate(){this.requestID=requestAnimationFrame(()=>this.animate()),this.globalUniforms.uZoom.value!==this.camera.zoom&&(this.globalUniforms.uZoom.value=this.camera.zoom),this.hdLayer&&(this.hdLayer.updateAnimations(),this.hdLayer.show([])),this.updateHoverState(),this.renderer.render(this.scene,this.camera)}updateHoverState(){const t=this.controls.getHoveredPoint(this.zoomParams);(t?t.id:null)?(this.hdLayer.hover(t),this.onHover.emit(X().sha1Index[t.sha1][0].id)):(this.hdLayer.unhover(),this.onHover.emit())}setMouseMode(t){this.controls.setMode(t)}updateTints(){this.atlasLayers.updateTints(),this.hdLayer.updateTints()}updateBorder(){this.atlasLayers.updateBorderColors(),this.atlasLayers.updateBorderWidths(),this.hdLayer.updateBorder()}updatePosition(){this.atlasLayers.updatePositions()}setShowAsPoint(t){this.atlasLayers.setShowAsPoint(t)}setImageSize(t){this.zoomParams.h=t/50*3,this.hdLayer.setZoomParams(this.zoomParams),this.atlasLayers.setZoomParams(this.zoomParams)}onResize(){const t=this.container.clientWidth/this.container.clientHeight;this.camera.left=this.frustumSize*t/-2,this.camera.right=this.frustumSize*t/2,this.camera.top=this.frustumSize/2,this.camera.bottom=this.frustumSize/-2,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)}getImageMaxSize(){const t=this.camera.zoom,{h:e,z1:o,z2:s}=this.zoomParams;let l;return t>=o&&t<s?l=e*(o/t):t>=s?l=e*(o/s):l=e,l}getCameraRect(){const t=this.camera.zoom;return{minX:this.camera.left/t+this.camera.position.x,maxX:this.camera.right/t+this.camera.position.x,minY:this.camera.bottom/t+this.camera.position.y,maxY:this.camera.top/t+this.camera.position.y}}lookAtRect(t){let e=this.getImageMaxSize(),o=_s(t);o.minX-=e,o.minY-=e,o.maxX+=e,o.maxY+=e,this.controls.lookAtRect(o)}dispose(){this.requestID&&cancelAnimationFrame(this.requestID),this.resizeObserver.disconnect(),this.controls.dispose(),this.renderer.dispose(),this.atlasLayers.dispose(),this.hdLayer?.dispose(),this.scene.clear()}}function rr(S){const t=Dt(null),e=V(null),o=X();return oe(()=>{if(!S.value){console.error("MapRenderer: Container ref is null on mount.");return}console.log("Initializing MapRenderer..."),t.value=new nr(S.value,o.baseImgUrl),t.value.onHover.addListener(s=>e.value=s),t.value.animate()}),$e(()=>{t.value&&(console.log("Disposing MapRenderer..."),t.value.dispose(),t.value=null)}),{map:t,hoverInstanceId:e}}const lr={class:"text-center",style:{position:"relative",top:"1px"}},ur={class:"image-container"},dr={key:0,class:"menu-section-card scrollable-section"},cr={class:"section-title"},pr={class:"flex-grow-1"},hr={class:"groups-list"},vr=["onMouseover","onMouseleave","onClick"],mr={class:"group-name"},fr={class:"group-count"},gr=H({__name:"MapMenu",props:{selectedMap:{},colorOption:{},groups:{},images:{},hoverImageId:{}},emits:["update:selectedMap","update:spatialFunction","update:colorOption","clusters","hoverGroup","clickGroup","removeClusters"],setup(S,{emit:t}){const{t:e}=Le(),o=X(),s=S,l=t,v=V(!1),h=U(()=>o.instances[s.hoverImageId]);function p(){v.value=!v.value}return(n,i)=>(m(),x("div",{class:Y(["map-menu",{collapsed:v.value}])},[a("div",{class:"toggle-header",onClick:p},[a("i",{class:Y(v.value?"bi bi-arrow-left-circle":"bi bi-arrow-right-circle")},null,2)]),v.value?R("",!0):(m(),x(N,{key:0},[a("div",lr,A(n.$t("map.main_menu")),1),i[2]||(i[2]=a("div",{class:"mb-2"},null,-1)),a("div",ur,[h.value?(m(),F(Ot,{key:0,image:h.value,class:""},{default:T(()=>[E(Vt,{image:h.value,width:260,height:200,style:{"margin-left":"10px"}},null,8,["image"])]),_:1},8,["image"])):R("",!0)]),a("div",{class:Y(["menu-content mt-2",{hidden:v.value}])},[s.groups.length?(m(),x("div",dr,[a("div",cr,[a("span",pr,A(s.colorOption=="property"?n.$t("map.group_property"):n.$t("map.group_cluster")),1),a("span",null,A(s.groups.length),1),s.colorOption=="cluster"?(m(),x("span",{key:0,class:"sb ms-2",onClick:i[0]||(i[0]=c=>l("removeClusters"))},i[1]||(i[1]=[a("i",{class:"bi bi-x"},null,-1)]))):R("",!0)]),a("div",hr,[(m(!0),x(N,null,J(s.groups,c=>(m(),x("div",{key:c.id,class:"group-item",onMouseover:u=>l("hoverGroup",{groupId:c.id,value:!0}),onMouseleave:u=>l("hoverGroup",{groupId:c.id,value:!1}),onClick:u=>l("clickGroup",c)},[a("div",{class:"group-color",style:se({backgroundColor:c.color})},null,4),a("span",mr,A(c.name),1),a("span",fr,A(c.count),1)],40,vr))),128))])])):R("",!0)],2)],64))],2))}}),yr=j(gr,[["__scopeId","data-v-376da823"]]),br="/icons/network2_white.svg",_r={class:"cont3"},xr=H({__name:"PointMapSelection",props:{modelValue:{}},emits:["update:modelValue"],setup(S,{emit:t}){const e=X(),o=S,s=t,l=V(null),v=V([]),h=V();async function p(){v.value=Ft(e.maps).map(i=>({value:i.id,label:i.id+": "+i.source+"."+i.name,icon:"geo"}));let n=o.modelValue;n&&!e.maps[n]&&(n=null),!n&&v.value.length&&(console.log("Defaulting to first available map",{old:o.modelValue,new:v.value[0].value}),n=v.value[0].value),n!==h.value&&(h.value=n,s("update:modelValue",n))}return W(()=>o.modelValue,n=>h.value=n),W(()=>e.maps,()=>p()),W(h,n=>s("update:modelValue",n)),oe(()=>{h.value=o.modelValue,p()}),q.ctrlF.on(()=>l.value?.focus()),(n,i)=>(m(),x("div",_r,[E(nt,{options:v.value,modelValue:h.value,"onUpdate:modelValue":i[0]||(i[0]=c=>h.value=c),placeholder:n.$t("map.select_map"),"no-border":!0,teleport:!0},null,8,["options","modelValue","placeholder"])]))}}),wr=j(xr,[["__scopeId","data-v-e98deea9"]]),kr={class:"glass-box2 d-flex align-items-center"},$r={class:"toolbar-item px-1 d-flex align-items-center gap-1"},Mr={key:1,style:{"min-width":"150px"},class:"map-select"},Sr={class:"toolbar-item"},Ir={class:"toolbar-item d-flex align-items-center gap-1"},Cr={style:{"min-width":"120px"}},Pr={key:0,class:"toobar-item"},zr=H({__name:"Toolbar",props:{mouseMode:{},imageSize:{},showPoint:{type:Boolean},selectedMap:{},colorOption:{},hasMaps:{type:Boolean},images:{}},emits:["update:mouseMode","update:imageSize","update:showPoint","update:selectedMap","update:colorOption","clusters","delete:map"],setup(S,{emit:t}){const{t:e}=Le(),o=X(),s=S,l=t,v=U(()=>[{value:"property",label:e("map.color_prop"),icon:"stack"},{value:"cluster",label:e("map.color_cluster"),icon:"stack"}]);function h(c){l("update:mouseMode",c)}function p(){X().deleteMap(s.selectedMap)}async function n(c){await o.loadMaps(),l("update:selectedMap",c.value.id)}const i=U(()=>Object.keys(ve().getMainTab().collection.groupManager.selectedImages.value).map(Number).map(c=>o.instances[c]));return(c,u)=>(m(),x("div",kr,[a("div",$r,[s.hasMaps?(m(),x("div",{key:0,class:"tool sb",onClick:p},u[8]||(u[8]=[a("i",{class:"bi bi-trash",style:{opacity:"0.8"}},null,-1)]))):R("",!0),s.hasMaps?(m(),x("div",Mr,[E(wr,{"model-value":s.selectedMap,"onUpdate:modelValue":u[0]||(u[0]=_=>l("update:selectedMap",_))},null,8,["model-value"])])):R("",!0)]),a("div",Sr,[E(ht,{action:"map",class:"bb ps-1 pe-1",style:{"font-size":"14px"},"no-border":!0,onCall:n,images:i.value},{default:T(()=>[u[9]||(u[9]=a("i",{class:"bi bi-boxes"},null,-1)),ie(" "+A(c.$t("map.create")),1)]),_:1},8,["images"])]),u[15]||(u[15]=a("div",{class:"divider"},null,-1)),a("div",Ir,[a("div",Cr,[E(nt,{teleport:!0,options:v.value,"model-value":s.colorOption,"onUpdate:modelValue":u[1]||(u[1]=_=>l("update:colorOption",_)),"no-border":!0},null,8,["options","model-value"])])]),s.colorOption==="cluster"?(m(),x("div",Pr,[E(ht,{images:s.images,action:"group",class:"sb ps-1 pe-1",style:{"font-size":"14px"},"no-border":!0,onGroups:u[2]||(u[2]=_=>l("clusters",_))},{default:T(()=>u[10]||(u[10]=[a("img",{class:"cluster-icon",src:br},null,-1)])),_:1},8,["images"])])):R("",!0),u[16]||(u[16]=a("div",{class:"divider"},null,-1)),a("div",{class:Y(["tool",{selected:s.showPoint}]),onClick:u[3]||(u[3]=_=>l("update:showPoint",!s.showPoint)),title:"Show Points"},u[11]||(u[11]=[a("i",{class:"bi bi-dot"},null,-1)]),2),a("div",{class:Y(["tool",{selected:s.mouseMode=="pan"}]),onClick:u[4]||(u[4]=_=>h("pan")),title:"Pan"},u[12]||(u[12]=[a("i",{class:"bi bi-hand-index-thumb"},null,-1)]),2),a("div",{class:Y(["tool",{selected:s.mouseMode=="lasso-plus"}]),onClick:u[5]||(u[5]=_=>h("lasso-plus")),title:"Lasso Add"},u[13]||(u[13]=[a("i",{class:"bi bi-plus-circle-dotted"},null,-1)]),2),a("div",{class:Y(["tool",{selected:s.mouseMode=="lasso-minus"}]),onClick:u[6]||(u[6]=_=>h("lasso-minus")),title:"Lasso Remove"},u[14]||(u[14]=[a("i",{class:"bi bi-dash-circle-dotted"},null,-1)]),2),u[17]||(u[17]=a("div",{class:"divider"},null,-1)),u[18]||(u[18]=a("div",{class:"tool-icon ms-1"},[a("i",{class:"bi bi-aspect-ratio"})],-1)),E(At,{style:{width:"60px"},min:10,max:100,modelValue:s.imageSize,"onUpdate:modelValue":u[7]||(u[7]=_=>l("update:imageSize",_))},null,8,["modelValue"])]))}}),Er=j(zr,[["__scopeId","data-v-22afe6c7"]]),Rr={class:"main-layout"},Tr={class:"toolbar-container"},Lr={class:"map-view-container"},Ar=.05,Or="#FFFFFF",Vr="#CCCCCC",Fr="#5DACFF",Ie="#777777",Ur=H({__name:"MapView",props:{tab:{}},setup(S){const t=X(),e=S,o=V(null),{map:s,hoverInstanceId:l}=rr(o),v=V("pan"),h=V(1e3),p=V(l.value),n=V(!0),i=V([]);let c=[],u={},_={};const $=V({}),z=Dt([]);function M(f,g){let k=0,D=0,B=0,K=0,Z=!1;for(let Q=0;Q<f.length;Q++){let ae=f[Q],ee=u[ae.sha1];ee&&(Z?(k=Math.min(k,ee.x),D=Math.min(D,ee.y),B=Math.max(B,ee.x),K=Math.max(K,ee.y)):(k=ee.x,D=ee.y,B=ee.x,K=ee.y,Z=!0))}return{minX:k,minY:D,maxX:B,maxY:K,color:g}}function P(f,g=0){if(f.name)return f.name;if(f.meta.propertyValues?.length){const k=f.meta.propertyValues[0],D=t.properties[k.propertyId];return ze(D.type)?t.tags[k.value]?.value??"undefined":D.name+": "+k.value}return"Group "+g}function C(){z.value.forEach(k=>{k.color=Ie,k.borderColor=Ie,k.border=0,k.tint=Or,k.tintAlpha=0,k.z=1});const f=Object.keys($.value).length>0;for(let k of i.value){const D=$.value[k.id];for(let B of k.points)B.border=Ar,B.borderColor=k.color,D?(B.tintAlpha=0,B.z=1.1):f?(B.tintAlpha=1,B.tint=Vr,B.z=1):(B.tintAlpha=0,B.z=1)}const g=e.tab.collection.groupManager.selectedImages.value;Object.keys(g).map(Number).forEach(k=>{const D=u[t.instances[k].sha1];D&&(D.tint=Fr,D.tintAlpha=.8)}),s.value&&(s.value.updateBorder(),s.value.updateTints(),s.value.updatePosition())}function r(){let f=[];e.tab.state.mapOptions.groupOption==="property"?f=e.tab.collection.groupManager.result.root.children:f=c,f=f.map(Z=>({...Z}));const k=new Set;z.value.forEach(Z=>k.add(Z.sha1));for(let Z of f)Z.images=Z.images.filter(Q=>k.has(Q.sha1));if(f=f.filter(Z=>Z.images.length>0),!f.length){i.value=[],C();return}const D=f.length,B=ws(D),K=[];_={},f.forEach((Z,Q)=>{let ae=B[Q];const ee=Z.meta?.propertyValues?.[0]?.propertyId;if(ee){const ce=t.properties[ee];if(ze(ce.type)){const _e=Z.meta.propertyValues[0].value;_e!==void 0?ae=ks[t.tags[_e].color].color:ae=$s.color}}_[Z.id]=Z.images.map(ce=>ce.sha1);const Me=Array.from(new Set(Z.images.map(ce=>u[ce.sha1]).filter(Boolean)));K.push({id:Z.id,name:P(Z,Q),count:Z.images.length,color:ae,box:M(Z.images,ae),points:Me})}),i.value=K,C()}async function d(f){if(!t.maps[f])return;t.maps[f].data||await t.loadMapData(f),u={};const g=[],k=t.maps[f].data,D=new Set;e.tab.collection.filterManager.result.images.forEach(B=>D.add(B.sha1));for(let B=0;B<k.length;B+=3){const K=k[B];if(!D.has(K))continue;const Z=k[B+1],Q=k[B+2],ae=t.sha1Index[K]?.[0];if(!ae)continue;const ee={id:ae.id,x:Z,y:Q,z:1,color:Ie,sha1:K,ratio:ae.containerRatio,order:1,border:0,tintAlpha:0,borderColor:Ie};g.push(ee),u[K]=ee}if(z.value=g,r(),s.value){const B=t.atlas;if(!B){n.value=!1;return}s.value.createMap(B,z.value,e.tab.state.mapOptions.showPoints)}}function w(f){f.value?$.value[f.groupId]=!0:delete $.value[f.groupId],$.value={...$.value},C()}const O=f=>{let g=[];for(let k of f)t.sha1Index[k.sha1]&&g.push(...t.sha1Index[k.sha1].map(D=>D.id));v.value=="lasso-plus"&&e.tab.collection.groupManager.selectImages(g),v.value=="lasso-minus"&&e.tab.collection.groupManager.unselectImages(g)};async function L(f){await t.deleteMap(f)}function y(){d(e.tab.state.mapOptions.selectedMap)}function b(){e.tab.state.mapOptions.groupOption=="cluster"&&(c=[],r())}return W(v,f=>{s.value?.setMouseMode(f)}),W(e.tab.collection.groupManager.selectedImages,()=>C()),W(()=>e.tab.state.mapOptions.selectedMap,f=>{f!=null&&d(f)}),W(()=>e.tab.state.mapOptions.groupOption,()=>r()),W(()=>e.tab.state.mapOptions.showPoints,f=>s.value.setShowAsPoint(f)),W(()=>e.tab.state.mapOptions.imageSize,f=>s.value.setImageSize(f)),W(l,()=>{l.value&&(p.value=l.value)}),W(s,f=>{f&&(f.onPointSelection=O,z.value.length>0&&f.atlasLayers&&C(),f.setImageSize(e.tab.state.mapOptions.imageSize))}),W(h,()=>console.log("map width",h.value)),W(()=>e.tab.state.mapOptions,()=>e.tab.saveState(),{deep:!0}),W(()=>t.atlas,async()=>{d(e.tab.state.mapOptions.selectedMap)}),oe(async()=>{e.tab.collection.groupManager.onResultChange.addListener(y),await t.loadMaps(),d(e.tab.state.mapOptions.selectedMap),s.value&&s.value.setMouseMode(v.value)}),$e(()=>{e.tab.collection.groupManager.onResultChange.removeListener(y)}),(f,g)=>(m(),x("div",Rr,[a("div",Tr,[E(Er,{"mouse-mode":v.value,"onUpdate:mouseMode":g[0]||(g[0]=k=>v.value=k),"image-size":e.tab.state.mapOptions.imageSize,"onUpdate:imageSize":g[1]||(g[1]=k=>e.tab.state.mapOptions.imageSize=k),"show-point":e.tab.state.mapOptions.showPoints,"onUpdate:showPoint":g[2]||(g[2]=k=>e.tab.state.mapOptions.showPoints=k),"selected-map":e.tab.state.mapOptions.selectedMap,"onUpdate:selectedMap":g[3]||(g[3]=k=>e.tab.state.mapOptions.selectedMap=k),"color-option":e.tab.state.mapOptions.groupOption,"onUpdate:colorOption":g[4]||(g[4]=k=>{e.tab.state.mapOptions.groupOption=k,e.tab.saveState()}),"has-maps":I(t).hasMaps,images:f.tab.collection.groupManager.result.root.images,onClusters:g[5]||(g[5]=k=>{vt(c)?c.value=k:c=k,r()}),"onDelete:map":L},null,8,["mouse-mode","image-size","show-point","selected-map","color-option","has-maps","images"])]),a("div",Lr,[E(xs,{onResize:g[6]||(g[6]=k=>h.value=k),class:"map-resizable-wrapper",disabled:!0},{default:T(()=>[a("div",{class:Y(["map-container",{"cursor-grab":v.value=="pan","cursor-lasso":v.value.startsWith("lasso")}])},[a("div",{ref_key:"canvasContainer",ref:o,class:"canvas-wrapper"},null,512)],2)]),_:1}),E(yr,{"selected-map":e.tab.state.mapOptions.selectedMap,"onUpdate:selectedMap":g[7]||(g[7]=k=>e.tab.state.mapOptions.selectedMap=k),"color-option":e.tab.state.mapOptions.groupOption,"onUpdate:colorOption":g[8]||(g[8]=k=>e.tab.state.mapOptions.groupOption=k),"hover-image-id":p.value,groups:i.value,images:f.tab.collection.groupManager.result.root.images,onClusters:g[9]||(g[9]=k=>{vt(c)?c.value=k:c=k,r()}),onHoverGroup:w,onClickGroup:g[10]||(g[10]=k=>I(s)?.lookAtRect(k.box)),onRemoveClusters:b},null,8,["selected-map","color-option","hover-image-id","groups","images"])])]))}}),Dr=j(Ur,[["__scopeId","data-v-cdb0fd9f"]]),Br={key:0,class:"m-0 p-0"},Gr={key:0},Hr=H({__name:"MainView",props:{tab:{},height:{},filterOpen:{type:Boolean}},setup(S,{expose:t}){const e=ve(),o=X(),s=S;t({updateScrollerWidth:P});const l=V({}),v=V(!0),h=V(null),p=V(null),n=V(null),i=V(0),c=V(0),u=Pe({groups:!1}),_=U(()=>s.tab.getVisibleProperties());function $(){h.value&&p.value?i.value=s.height-h.value.clientHeight-p.value.clientHeight:h.value?i.value=s.height-h.value.clientHeight:i.value=0}function z(C){l.value=s.tab.collection.groupManager.result.index[C],re(()=>$())}function M(){l.value={},re(()=>$())}async function P(){await re(),c.value=h.value?.clientWidth??c.value}return oe(()=>{P(),window.addEventListener("resize",P)}),$e(()=>{window.removeEventListener("resize",P)}),W(()=>s.tab.state.imageSize,()=>re($)),W(()=>s.filterOpen,()=>re($)),W(()=>s.height,async()=>{await re($)}),oe($),(C,r)=>(m(),x(N,null,[a("div",{id:"main-content",ref_key:"filterElem",ref:h},[s.filterOpen?(m(),F(nn,{key:0,tab:s.tab,"compute-status":u},null,8,["tab","compute-status"])):R("",!0)],512),a("div",{ref_key:"boxElem",ref:p,class:"m-0 p-0"},[l.value.id?(m(),x("div",Br,[E(Rn,{tab:s.tab,group:l.value,"image-size":s.tab.state.imageSize,width:c.value,height:50,onClose:M,onScroll:n.value.scrollTo,onUpdate:r[0]||(r[0]=d=>re(()=>$()))},null,8,["tab","group","image-size","width","onScroll"])])):R("",!0)],512),I(o).isLoaded&&c.value>0&&i.value>0&&v.value?(m(),x("div",Gr,[s.tab.state.display=="tree"?(m(),F(Ms,{key:0,"input-key":"main-view-tree","group-manager":s.tab.collection.groupManager,"image-size":s.tab.state.imageSize,height:i.value,properties:_.value,"hide-if-modal":!0,"selected-images":s.tab.collection.groupManager.selectedImages,ref_key:"imageList",ref:n,width:c.value-20,onRecommend:z,style:{"margin-left":"10px"}},null,8,["group-manager","image-size","height","properties","selected-images","width"])):R("",!0),s.tab.state.display=="grid"?(m(),x("div",{key:1,style:se([{width:c.value-12+"px"},{"margin-left":"10px"}]),class:"grid-container"},[E(Ss,{tab:C.tab,manager:s.tab.collection.groupManager,height:i.value-15,width:c.value-12,"selected-properties":_.value,class:"p-0 m-0","show-images":!0,"selected-images":s.tab.collection.groupManager.selectedImages,ref_key:"imageList",ref:n,"hide-if-modal":!0},null,8,["tab","manager","height","width","selected-properties","selected-images"])],4)):R("",!0),s.tab.state.display=="graph"?(m(),F(Vn,{key:2,collection:s.tab.collection,height:i.value-15,style:{"margin-left":"10px"}},null,8,["collection","height"])):R("",!0),s.tab.state.display=="map"&&I(e).loaded?(m(),F(Dr,{key:3,style:se({height:i.value-0+"px"}),tab:s.tab},null,8,["style","tab"])):R("",!0)])):R("",!0)],64))}}),Nr=j(Hr,[["__scopeId","data-v-02e2c96c"]]),Zr=H({__name:"TabButton",props:{tab:{}},setup(S){const t=ve(),e=V(""),o=V(null),s=V(!1),l=V(!1),v=S,h=U(()=>v.tab.state.id);function p(){t.selectMainTab(v.tab.state.id)}function n(){l.value=!0,e.value=v.tab.state.name,re(()=>o.value.focus())}function i(){v.tab.renameTab(e.value),l.value=!1}async function c(){confirm("Are you sure to delete Tab: "+v.tab.state.name)&&t.deleteTab(v.tab.state.id)}return oe(()=>{v.tab.isNew&&n()}),(u,_)=>(m(),x("div",{class:"d-flex d-row me-2",onMouseenter:_[1]||(_[1]=$=>s.value=!0),onMouseleave:_[2]||(_[2]=$=>s.value=!1)},[l.value?(m(),x("div",{key:1,class:Y(["tab-button",h.value==I(t).mainTab?" active":""])},[a("form",{onSubmit:pe(i,["stop","prevent"])},[Ae(a("input",{onFocusout:i,onKeydown:Lt(i,["escape"]),type:"text",class:"text-input","onUpdate:modelValue":_[0]||(_[0]=$=>e.value=$),ref_key:"inputElem",ref:o},null,544),[[Oe,e.value]])],32)],2)):(m(),x(N,{key:0},[E(G,{message:"main.menu.rename_tab_tooltip"},{default:T(()=>[a("i",{onClick:n,class:Y(["bi bi-pencil me-1 tab-icon hover-light",s.value&&I(t).mainTab==h.value?"":"hidden"]),style:{"font-size":"10px"}},null,2)]),_:1}),a("div",{class:Y(["tab-button",h.value==I(t).mainTab?" active":""]),onClick:p},[a("span",null,A(v.tab.state.name),1)],2),E(G,{message:"main.menu.delete_tab_tooltip"},{default:T(()=>[a("i",{onClick:c,class:Y(["btn-icon bi bi-x tab-icon hover-light",s.value?"":"hidden"]),style:{"font-size":"15px"}},null,2)]),_:1})],64))],32))}}),Wr={class:"d-flex d-row",style:{cursor:"pointer"}},qr={class:"pt-1"},Yr={key:0,class:"bb bi bi-chevron-down"},Xr={key:1,class:"bb bi bi-chevron-right"},jr={style:{"padding-top":"2px","margin-right":"2px"}},Kr={class:"lang"},Qr=["value"],Jr=["value"],el=H({__name:"TabNav",props:{reRender:{type:Function},filterOpen:{type:Boolean}},emits:["update:filterOpen"],setup(S,{emit:t}){const{locale:e}=Le(),o=be(),s=ve(),l=S,v=t;async function h(c){await s.addTab("New Tab")}const p=["fr","en"];function n(){v("update:filterOpen",!l.filterOpen)}function i(c){l.reRender();const u=c.target.value;e.value=u,ke().setLang(u)}return(c,u)=>(m(),x("nav",null,[a("div",Wr,[a("div",qr,[a("span",{onClick:n},[l.filterOpen?(m(),x("i",Yr)):(m(),x("i",Xr))])]),(m(!0),x(N,null,J(I(s).loadedTabs,_=>(m(),x("div",null,[E(Zr,{tab:I(s).getTab(_)},null,8,["tab"])]))),256)),E(G,{message:"main.menu.add_tab_tooltip"},{default:T(()=>[a("button",{class:"tab-icon hover-light ps-1 pe-1",onClick:h,id:"add-tab-button"},u[2]||(u[2]=[a("span",{class:"bi bi-plus"},null,-1)]))]),_:1}),u[5]||(u[5]=a("div",{class:"flex-grow-1"},null,-1)),I(o).clientState.user?(m(),x("div",{key:0,style:{margin:"2px"},class:"bb me-3 text-secondary",onClick:u[0]||(u[0]=_=>I(Is)().disconnectUser())},A(I(o).clientState.user.name),1)):R("",!0),a("div",jr,[E(G,{message:"modals.notif.icon"},{default:T(()=>[a("span",{class:"bb",onClick:u[1]||(u[1]=_=>I(o).showModal(I(le).NOTIF))},u[3]||(u[3]=[a("i",{class:"bi bi-bell"},null,-1)]))]),_:1})]),a("div",Kr,[u[4]||(u[4]=a("i",{class:"bi bi-translate",style:{"margin-right":"0.5rem"}},null,-1)),a("select",{value:c.$i18n.locale,onChange:i},[(m(),x(N,null,J(p,(_,$)=>a("option",{key:`Lang${$}`,value:_},A(_.toUpperCase()),9,Jr)),64))],40,Qr)])])]))}}),tl={key:0},sl={key:0,class:"spinner-border spinner-border-sm text-primary",style:{position:"relative",top:"1px"},strole:"status"},ye=H({__name:"LoadWheel",props:{loading:{type:Boolean}},setup(S){const t=S;return(e,o)=>t.loading?(m(),x("div",tl,[e.loading?(m(),x("div",sl,o[0]||(o[0]=[a("span",{class:"visually-hidden"},"Loading...",-1)]))):R("",!0)])):R("",!0)}}),et=H({__name:"Percentage",props:{current:{},max:{},force:{type:Boolean}},setup(S){const t=S,e=U(()=>t.force?"100%":t.max==0?"0%":t.current>=t.max?"100%":Math.floor(t.current/t.max*100)+"%");return(o,s)=>(m(),x("span",null,A(e.value),1))}}),ol={key:0,class:"center"},al={class:"text-start",style:{display:"inline-block",width:"200px",height:"300px"}},il={class:"d-flex text-secondary"},nl={key:0,style:{"font-size":"14px"},class:"bi bi-check text-success"},rl={class:"d-flex text-secondary",style:{"font-size":"14px"}},ll={key:0,class:"bi bi-check text-success"},ul={class:"d-flex text-secondary",style:{"font-size":"14px"}},dl={key:0,class:"bi bi-check text-success"},cl={class:"d-flex text-secondary",style:{"font-size":"14px"}},pl={key:0,class:"bi bi-check text-success"},hl={class:"d-flex text-secondary",style:{"font-size":"14px"}},vl={key:0,class:"bi bi-check text-success"},ml={class:"d-flex text-secondary",style:{"font-size":"14px"}},fl={key:0,class:"bi bi-check text-success"},gl=H({__name:"DataLoad",setup(S){const t=X();return(e,o)=>I(t).loadState?(m(),x("div",ol,[a("div",al,[a("div",null,[a("div",il,[o[0]||(o[0]=a("div",{class:"me-1",style:{"font-size":"14px"}},"Properties",-1)),E(ye,{class:"me-2",loading:!I(t).loadState.finishedProperty},null,8,["loading"]),I(t).loadState.finishedProperty?(m(),x("i",nl)):R("",!0)]),a("div",rl,[o[1]||(o[1]=a("div",{class:"me-1"},"PropertyGroups",-1)),E(ye,{class:"me-2",loading:!I(t).loadState.finishedPropertyGroups},null,8,["loading"]),I(t).loadState.finishedPropertyGroups?(m(),x("i",ll)):R("",!0)]),a("div",ul,[o[2]||(o[2]=a("div",{class:"me-1"},"Tags",-1)),E(ye,{class:"me-2",loading:!I(t).loadState.finishedTags},null,8,["loading"]),I(t).loadState.finishedTags?(m(),x("i",dl)):R("",!0)]),a("div",cl,[o[3]||(o[3]=a("div",{class:"me-1"},"Instances",-1)),E(ye,{class:"me-2",loading:!I(t).loadState.finishedInstance},null,8,["loading"]),I(t).loadState.finishedInstance?(m(),x("i",pl)):R("",!0),E(et,{current:I(t).loadState.counterInstance,max:I(t).loadState.maxInstance,force:I(t).loadState.finishedInstance},null,8,["current","max","force"])]),a("div",hl,[o[4]||(o[4]=a("div",{class:"me-1"},"InstanceValues",-1)),E(ye,{class:"me-2",loading:!I(t).loadState.finishedInstanceValues},null,8,["loading"]),I(t).loadState.finishedInstanceValues?(m(),x("i",vl)):R("",!0),E(et,{current:I(t).loadState.counterInstanceValue,max:I(t).loadState.maxInstanceValue,force:I(t).loadState.finishedInstanceValues},null,8,["current","max","force"])]),a("div",ml,[o[5]||(o[5]=a("div",{class:"me-1"},"ImageValues",-1)),E(ye,{class:"me-2",loading:!I(t).loadState.finishedImageValues},null,8,["loading"]),I(t).loadState.finishedImageValues?(m(),x("i",fl)):R("",!0),E(et,{current:I(t).loadState.counterImageValue,max:I(t).loadState.maxImageValue,force:I(t).loadState.finishedImageValues},null,8,["current","max","force"])])])])])):R("",!0)}}),yl=j(gl,[["__scopeId","data-v-8b416e86"]]),bl={key:0},_l={id:"panoptic"},xl={class:"d-flex flex-row m-0 p-0 overflow-hidden"},wl={class:"w-100"},kl={key:0,class:"custom-hr"},$l={key:2,class:"loading"},Ml={class:"text-center"},Sl={key:3,class:"loading"},Il=H({__name:"ProjectView",setup(S){const t=ke(),e=X(),o=be(),s=ve(),l=V(null),v=V(null),h=V(window.innerHeight),p=V(!1),n=V(!0),i=V(!0),c=U(()=>h.value-(v.value?.clientHeight??0)),u=U(()=>l.value?.filteredImages.map(r=>r.id));let _=navigator.userAgent.indexOf("Mac OS X")!==-1;async function $(){n.value=!1,await re(),n.value=!0}oe(async()=>{if(!o.isProjectLoaded){mt.push("/");return}t.init(),re(()=>{window.addEventListener("resize",z),z()}),window.addEventListener("keydown",r=>{r.key=="Meta"&&(q.cmd=!0),r.key=="Control"&&(q.ctrl=!0),r.key=="Alt"&&(_&&(q.ctrl=!0),q.alt=!0),r.key=="Shift"&&(q.shift=!0),r.key=="ArrowLeft"&&(q.left=!0),r.key=="ArrowRight"&&(q.right=!0),r.key=="Z"&&q.ctrl&&e.redo(),r.key=="z"&&q.ctrl&&e.undo(),r.key=="f"&&(q.ctrl||q.cmd)&&(r.preventDefault(),q.ctrlF.emit())}),window.addEventListener("keyup",r=>{r.key=="Meta"&&(q.cmd=!1),r.key=="Control"&&(q.ctrl=!1),r.key=="Alt"&&(_&&(q.ctrl=!1),q.alt=!1),r.key=="Shift"&&(q.shift=!1),r.key=="ArrowLeft"&&(q.left=!1),r.key=="ArrowRight"&&(q.right=!1)}),window.addEventListener("mousemove",r=>{q.ctrl=r.ctrlKey,q.alt=r.altKey,q.shift=r.shiftKey,q.cmd=r.metaKey,_&&(q.ctrl=q.ctrl||q.alt)})}),$e(()=>{window.removeEventListener("resize",z),ke().clear()});function z(){h.value=window.innerHeight,p.value=!0}function M(){o.showModal(le.EXPORT,u)}function P(){mt.push("/")}function C(){l.value&&l.value.updateScrollerWidth()}return(r,d)=>n.value?(m(),x("div",bl,[l.value&&!l.value.imageList?(m(),F(Bs,{key:0,tutorial:"project"})):R("",!0),a("div",_l,[a("div",xl,[I(e).isLoaded?I(e).isLoaded?(m(),x(N,{key:1},[a("div",null,[E(Ko,{onExport:d[0]||(d[0]=w=>M()),onToggle:C})]),a("div",wl,[a("div",{class:"ms-1",ref_key:"navElem",ref:v},[E(el,{"re-render":$,filterOpen:i.value,"onUpdate:filterOpen":d[1]||(d[1]=w=>i.value=w)},null,8,["filterOpen"])],512),p.value?(m(),x("div",kl)):R("",!0),E(Zt,{id:I(s).mainTab},{default:T(({tab:w})=>[E(Nr,{tab:w,height:c.value,ref_key:"mainViewRef",ref:l,"filter-open":i.value},null,8,["tab","height","filter-open"])]),_:1},8,["id"])])],64)):I(o).isProjectLoaded?(m(),x("div",Sl,d[2]||(d[2]=[a("i",{class:"spinner-border",role:"status"},null,-1),a("span",{class:"ms-1"},"Loading...",-1)]))):(m(),x("div",$l,[a("div",Ml,[a("div",null,A(r.$t("main.status.no_project")),1),a("div",{class:"bi bi-house p-3",onClick:P,style:{"font-size":"50px",cursor:"pointer"}})])])):(m(),x("div",{key:0,class:"d-flex flex-column w-100",style:se({height:h.value+"px"})},[E(yl,{class:"flex-grow-1"})],4))])])])):R("",!0)}}),El=j(Il,[["__scopeId","data-v-ddaa0fb1"]]);export{El as default};
